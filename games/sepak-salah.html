<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sepak Salah, Alien Marah! - Aliens vs Malaysians</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'fredoka': ['Fredoka', 'sans-serif'] },
                    colors: { 'sambal': '#FF5252', 'durian': '#FFD600', 'pandan': '#00E676' }
                }
            }
        }
    </script>
    <style>
        .ball-fly {
            animation: ballFly 0.4s ease-out forwards;
        }

        @keyframes ballFly {
            0% {
                transform: scale(1) rotate(0deg);
            }

            50% {
                transform: scale(1.2) rotate(180deg);
            }

            100% {
                transform: scale(0.9) rotate(360deg);
            }
        }

        .alien-hit {
            animation: alienHit 0.5s ease-out forwards;
        }

        @keyframes alienHit {
            0% {
                transform: translateY(0) scale(1);
            }

            30% {
                transform: translateY(-30px) scale(1.1);
            }

            100% {
                transform: translateY(80px) scale(0.8);
                opacity: 0;
            }
        }

        .wrong-hit {
            animation: wrongHit 0.5s ease-out;
        }

        @keyframes wrongHit {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-15deg);
            }

            75% {
                transform: rotate(15deg);
            }
        }

        .ufo-hover {
            animation: ufoHover 2s ease-in-out infinite;
        }

        @keyframes ufoHover {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        .portal-pulse {
            animation: portalPulse 1.5s ease-in-out infinite;
        }

        @keyframes portalPulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .combo-text {
            animation: comboFloat 1s ease-out forwards;
        }

        @keyframes comboFloat {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-80px) scale(1.5);
                opacity: 0;
            }
        }

        .aiyo-popup {
            animation: aiyoShake 0.8s ease-out forwards;
        }

        @keyframes aiyoShake {
            0% {
                transform: scale(0) rotate(-10deg);
            }

            20% {
                transform: scale(1.2) rotate(5deg);
            }

            40% {
                transform: scale(1) rotate(-5deg);
            }

            60% {
                transform: scale(1.1) rotate(3deg);
            }

            80% {
                transform: scale(1) rotate(-2deg);
            }

            100% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
        }

        .winner-bounce {
            animation: winnerBounce 0.5s ease-out forwards, winnerGlow 1s ease-in-out infinite 0.5s;
        }

        @keyframes winnerBounce {
            0% {
                transform: scale(0) rotate(-10deg);
            }

            50% {
                transform: scale(1.3) rotate(5deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
            }
        }

        @keyframes winnerGlow {

            0%,
            100% {
                filter: drop-shadow(0 0 20px gold);
            }

            50% {
                filter: drop-shadow(0 0 40px gold) drop-shadow(0 0 60px orange);
            }
        }

        .confetti {
            position: fixed;
            pointer-events: none;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .pulse-text {
            animation: pulseText 1s ease-in-out infinite;
        }

        @keyframes pulseText {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.9;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }
        }
    </style>
</head>

<body
    class="font-fredoka bg-gradient-to-b from-green-600 via-green-500 to-emerald-400 min-h-screen overflow-hidden touch-none select-none">

    <!-- Game Canvas -->
    <canvas id="gameCanvas" class="block w-full h-screen"></canvas>

    <!-- HUD -->
    <div id="hud" class="hidden fixed inset-0 pointer-events-none z-50">
        <div class="absolute top-4 left-1/2 -translate-x-1/2 flex gap-4 flex-wrap justify-center">
            <div
                class="bg-white/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg">
                ‚öΩ <span id="shotsLeft" class="text-sambal">10</span> LEFT
            </div>
            <div id="p1ScoreBox"
                class="bg-pandan/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg">
                P1: <span id="p1Score">0</span>
            </div>
            <div id="p2ScoreBox"
                class="hidden bg-orange-500/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg text-white">
                P2: <span id="p2Score">0</span>
            </div>
            <div id="comboBox"
                class="hidden bg-durian/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg">
                üî• <span id="comboCount">0</span>x
            </div>
        </div>
        <div class="absolute top-16 left-1/2 -translate-x-1/2">
            <div id="difficultyBadge" class="bg-pandan px-4 py-1 rounded-full border-2 border-black font-bold text-sm">
                EASY</div>
        </div>
    </div>

    <!-- Countdown Overlay -->
    <div id="countdown"
        class="hidden fixed inset-0 flex items-center justify-center z-[80] bg-black/70 pointer-events-none">
        <div id="countdownText" class="text-9xl font-bold text-white drop-shadow-[0_8px_0_#000]">3</div>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu"
        class="fixed inset-0 bg-gradient-to-b from-green-800 to-emerald-900 flex flex-col items-center justify-center z-[100] text-center px-4">
        <div class="text-8xl mb-4 animate-bounce">‚öΩ</div>
        <h1 class="text-4xl md:text-6xl font-bold text-pandan drop-shadow-[0_6px_0_#000] mb-2">
            SEPAK SALAH,<br>ALIEN MARAH!
        </h1>
        <p class="text-white text-xl mb-2 max-w-md">"Kick the ball. Miss the alien.<br>Kick the wrong thing ‚Äî everyone
            judge you."</p>
        <p class="text-green-300 text-lg mb-6">Kick footballs at aliens!</p>

        <!-- Difficulty Selection -->
        <div class="flex gap-2 mb-6">
            <button onclick="setDifficulty('easy')" id="btnEasy"
                class="bg-pandan text-black font-bold px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] transition-all">EASY</button>
            <button onclick="setDifficulty('normal')" id="btnNormal"
                class="bg-durian text-black font-bold px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] transition-all opacity-60">NORMAL</button>
            <button onclick="setDifficulty('hard')" id="btnHard"
                class="bg-sambal text-white font-bold px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] transition-all opacity-60">HARD</button>
        </div>

        <button onclick="startGame(1)"
            class="bg-pandan text-black font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#2E7D32] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#2E7D32] transition-all mb-4 w-72">
            üë§ 1 PLAYER
        </button>

        <button onclick="startGame(2)"
            class="bg-durian text-black font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#B8860B] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#B8860B] transition-all w-72">
            üë• 2 PLAYER (TURN)
        </button>
    </div>

    <!-- Player Ready Screen -->
    <div id="playerReadyScreen"
        class="hidden fixed inset-0 bg-gradient-to-b from-green-800 to-emerald-900 flex flex-col items-center justify-center z-[90] text-center px-4">
        <div id="playerReadyIcon" class="text-9xl mb-4 pulse-text">‚öΩ</div>
        <h1 id="playerReadyText"
            class="text-5xl md:text-7xl font-bold text-pandan drop-shadow-[0_6px_0_#000] mb-4 pulse-text">
            PLAYER 1 READY?
        </h1>
        <p class="text-white text-2xl">Get ready to kick some aliens!</p>
    </div>

    <!-- Score Reveal Screen -->
    <div id="scoreRevealScreen"
        class="hidden fixed inset-0 bg-black/95 flex flex-col items-center justify-center z-[95] text-center px-4">
        <div id="confettiContainer"></div>
        <h2 id="scoreRevealTitle" class="text-4xl md:text-5xl font-bold text-pandan drop-shadow-[0_4px_0_#000] mb-4">
            PLAYER 1 SCORED
        </h2>
        <div id="scoreRevealNumber" class="text-8xl md:text-9xl font-bold text-durian drop-shadow-[0_8px_0_#000] mb-8">
            0
        </div>
        <p class="text-white text-xl animate-pulse">Tap to continue...</p>
    </div>

    <!-- Winner Screen -->
    <div id="winnerScreen"
        class="hidden fixed inset-0 bg-gradient-to-b from-green-800 via-black to-emerald-900 flex flex-col items-center justify-center z-[100] text-center px-4">
        <div id="winnerConfettiContainer"></div>
        <div class="text-9xl mb-4 winner-bounce">üèÜ</div>
        <h1 id="winnerTitle"
            class="text-4xl md:text-6xl font-bold text-pandan drop-shadow-[0_6px_0_#000] mb-2 winner-bounce">
            WHO MORE POWER?
        </h1>
        <h2 id="winnerSubtitle" class="text-3xl md:text-5xl font-bold text-durian drop-shadow-[0_4px_0_#000] mb-8"></h2>
        <div class="flex gap-8 justify-center mb-8">
            <div class="text-center">
                <div class="text-pandan font-bold text-2xl">Player 1</div>
                <div id="winnerP1Score" class="text-5xl font-bold text-white drop-shadow-[0_4px_0_#000]">0</div>
            </div>
            <div class="text-6xl font-bold text-white">VS</div>
            <div class="text-center">
                <div class="text-orange-400 font-bold text-2xl">Player 2</div>
                <div id="winnerP2Score" class="text-5xl font-bold text-white drop-shadow-[0_4px_0_#000]">0</div>
            </div>
        </div>
        <div class="flex flex-col gap-4">
            <button onclick="rematch()"
                class="bg-pandan text-black font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#2E7D32] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#2E7D32] transition-all">
                üî• FIGHT AGAIN!
            </button>
            <button onclick="returnToMainMenu()"
                class="bg-gray-600 text-white font-bold text-xl px-8 py-3 rounded-full border-4 border-black shadow-[0_6px_0_#374151] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_3px_0_#374151] transition-all">
                üè† MAIN MENU
            </button>
        </div>
    </div>

    <!-- End Screen (Single Player) -->
    <div id="endScreen"
        class="hidden fixed inset-0 bg-black/90 flex flex-col items-center justify-center z-[100] text-center px-4">
        <div class="text-8xl mb-4">‚öΩ</div>
        <h1 class="text-5xl md:text-6xl font-bold text-pandan drop-shadow-[0_4px_0_#000] mb-4">
            TIME'S UP!
        </h1>
        <p class="text-white text-xl mb-2">Final Score:</p>
        <div id="finalScore" class="text-6xl font-bold text-durian drop-shadow-[0_4px_0_#000] mb-8">0</div>
        <button onclick="location.reload()"
            class="bg-pandan text-black font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#2E7D32] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#2E7D32] transition-all">
            PLAY AGAIN
        </button>
        <button onclick="window.location.href='../'"
            class="mt-4 bg-gray-600 text-white font-bold px-6 py-2 rounded-full border-2 border-black">
            BACK TO HUB
        </button>
    </div>

    <!-- Back Button -->
    <button onclick="handleBackButton()"
        class="fixed bottom-4 left-4 z-[200] bg-red-500 hover:bg-red-600 text-white font-bold px-6 py-3 rounded-xl border-4 border-black shadow-[4px_4px_0_#000] hover:shadow-[2px_2px_0_#000] hover:translate-y-[2px] transition-all flex items-center gap-2 pointer-events-auto">
        <span class="text-2xl">üîô</span> MENU
    </button>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            // Position updates if needed
        }
        window.addEventListener('resize', resize);
        resize();

        // Game State
        let gameRunning = false;
        let numPlayers = 1;
        let currentPlayer = 1;
        let p1Score = 0;
        let p2Score = 0;
        let timeRemaining = 40;
        let gameTimer = null;
        let gamePhase = 'menu';
        let combo = 0;
        let difficulty = 'easy';

        // Game Objects
        let goalkeeper = null;
        let kicker = null;
        let ball = null;
        let particles = [];
        let popups = [];
        let frameCount = 0;

        // Assets
        const ASSETS = {
            kicker: '../assets/malaysian_male.png',
            goalkeeper: '../assets/alien_purple_v2.png',
            durian: '../assets/durian.png'
        };

        const images = {};
        let imagesLoaded = 0;
        Object.entries(ASSETS).forEach(([key, src]) => {
            const img = new Image();
            img.onload = () => { imagesLoaded++; };
            if (key === 'goalkeeper') {
                // Apply transparency fix just in case, though v2 should be clean
                img.onload = () => {
                    imagesLoaded++;
                    images[key] = processTransparency(img); // Reuse transparency function if I copy it?
                    // Wait, I didn't copy processTransparency here. I should define it or trust v2.
                    // v2 is transparent (I verified). So generic load is fine.
                };
            }
            img.src = src;
            images[key] = img;
        });

        // Difficulty
        const difficultySettings = {
            easy: { goalieSpeed: 3, reactionTime: 20 },
            normal: { goalieSpeed: 5, reactionTime: 15 },
            hard: { goalieSpeed: 8, reactionTime: 10 }
        };

        function setDifficulty(diff) {
            difficulty = diff;
            document.getElementById('btnEasy').classList.toggle('opacity-60', diff !== 'easy');
            document.getElementById('btnNormal').classList.toggle('opacity-60', diff !== 'normal');
            document.getElementById('btnHard').classList.toggle('opacity-60', diff !== 'hard');
        }

        // Classes
        class Kicker {
            constructor() {
                this.size = 150;
                this.x = width / 2; // Center
                this.y = height - 100; // Bottom
            }
            draw() {
                const img = images.kicker;
                if (img && img.complete) {
                    ctx.drawImage(img, this.x - this.size / 2, this.y - this.size, this.size, this.size);
                } else {
                    ctx.fillStyle = 'blue';
                    ctx.fillRect(this.x - 20, this.y - 100, 40, 100);
                }
            }
        }

        class Goalkeeper {
            constructor() {
                this.size = 180;
                this.x = width / 2;
                this.y = height * 0.35 + 40; // Standing on Goal Line
                this.baseY = this.y;
                this.targetX = width / 2;
                this.state = 'idle'; // idle, diving, save, miss
                this.animTimer = 0;
                this.settings = difficultySettings[difficulty];
            }

            update(ball) {
                if (ball && ball.isKicked) {
                    // React to ball
                    if (ball.z > this.settings.reactionTime) {
                        // Move towards ball target X
                        const dx = ball.targetX - this.x;
                        if (Math.abs(dx) > 5) {
                            this.x += Math.sign(dx) * this.settings.goalieSpeed;
                        }
                    }

                    // Dive animation logic could go here
                } else {
                    // Return to center
                    const dx = (width / 2) - this.x;
                    this.x += dx * 0.05;
                }

                // Keep in bounds (Goal Posts are roughly width*0.2 to width*0.8)
                const goalLeft = width * 0.15;
                const goalRight = width * 0.85;
                this.x = Math.max(goalLeft, Math.min(goalRight, this.x));
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);

                if (this.state === 'save') {
                    // Scale up slightly?
                }

                const img = images.goalkeeper;
                if (img && img.complete) {
                    ctx.drawImage(img, -this.size / 2, -this.size, this.size, this.size);
                } else {
                    ctx.fillStyle = 'purple';
                    ctx.fillRect(-40, -100, 80, 100);
                }
                ctx.restore();
            }
        }

        let shotsLeft = 10;

        class PenaltyBall {
            constructor() {
                this.x = width / 2;
                this.y = height - 50;
                this.z = 0;
                this.targetX = width / 2;
                this.targetY = height * 0.4;
                this.isKicked = false;
                this.speed = 2;
                this.size = 30;
                this.rotation = 0;
                this.hasScored = false;
                this.hasSaved = false;
            }

            kick(tx, ty) {
                this.isKicked = true;
                this.targetX = tx;
                this.targetY = ty;
                this.startX = this.x;
                this.startY = this.y;
            }

            update() {
                if (!this.isKicked) return;
                this.z += this.speed;
                this.rotation += 0.2;
                const progress = this.z / 100;
                this.x = this.startX + (this.targetX - this.startX) * progress;
                this.y = this.startY + (this.targetY - this.startY) * progress;
                if (this.z >= 100 && !this.hasScored && !this.hasSaved) {
                    this.checkResult();
                }
            }

            checkResult() {
                const dx = Math.abs(this.x - goalkeeper.x);
                const dy = Math.abs(this.y - (goalkeeper.y - 50));

                if (dx < 80 && dy < 80) {
                    this.hasSaved = true;
                    spawnExampleParticles(this.x, this.y, '#FF5252');
                    showPopup(this.x, this.y, "SAVE!", "#FF5252");
                    this.speed = -1;
                } else {
                    this.hasScored = true;
                    showPopup(this.x, this.y, "GOAL!", "#00E676");
                    spawnExampleParticles(this.x, this.y, '#FFD600');
                    addScore(100);
                }

                shotsLeft--;
                updateHUD();

                if (shotsLeft > 0) {
                    setTimeout(() => resetBall(), 1500);
                } else {
                    setTimeout(() => endRound(), 2000);
                }
            }

            draw() {
                ctx.save();
                const scale = 1 - (this.z / 200);
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath();
                ctx.ellipse(this.x, this.y + 20 * scale, this.size / 2 * scale, this.size / 4 * scale, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.translate(this.x, this.y);
                ctx.scale(scale, scale);
                ctx.rotate(this.rotation);
                ctx.fillStyle = '#FFF';
                ctx.beginPath(); ctx.arc(0, 0, this.size, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();
                ctx.fillStyle = '#000';
                for (let i = 0; i < 5; i++) {
                    const angle = (i / 5) * Math.PI * 2 - Math.PI / 2;
                    const px = Math.cos(angle) * 12; const py = Math.sin(angle) * 12;
                    ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(px, py);
                    ctx.lineTo(Math.cos(angle + Math.PI / 5) * 12, Math.sin(angle + Math.PI / 5) * 12); ctx.fill();
                }
                ctx.restore();
            }
        }

        // Helper Functions
        function updateHUD() {
            const el = document.getElementById('shotsLeft');
            if (el) el.textContent = shotsLeft;
        }

        function showPopup(x, y, text, color) {
            popups.push({ x, y, text, color, life: 60 });
        }

        function spawnExampleParticles(x, y, color) {
            for (let i = 0; i < 20; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 30,
                    color
                });
            }
        }

        function resetBall() {
            if (!gameRunning) return;
            ball = new PenaltyBall();
        }

        function gameLoop() {
            if (!gameRunning) return;

            // 1. Draw Background Layer (Blurred for Depth)
            ctx.save();
            ctx.filter = 'blur(4px)';

            // Draw Grass Base
            ctx.fillStyle = '#2E7D32';
            ctx.fillRect(0, 0, width, height);

            // Draw Perspective Field (Trapezoid)
            ctx.fillStyle = '#388E3C'; // Lighter grass
            ctx.beginPath();
            const topWidth = width * 0.6;
            const topX = (width - topWidth) / 2;
            const horizon = height * 0.3; // where the ground meets goal

            ctx.moveTo(0, height); // Bottom Left
            ctx.lineTo(width, height); // Bottom Right
            ctx.lineTo(topX + topWidth, horizon); // Top Right
            ctx.lineTo(topX, horizon); // Top Left
            ctx.fill();

            // Draw Perspective Grid Lines
            ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            ctx.lineWidth = 2;

            // Vertical Lines (Converging)
            for (let i = 0; i <= 10; i++) {
                const fraction = i / 10;
                const bottomX = width * fraction;
                const topX_i = topX + (topWidth * fraction);
                ctx.beginPath(); ctx.moveTo(bottomX, height); ctx.lineTo(topX_i, horizon); ctx.stroke();
            }

            // Horizontal Lines (Perspective Spacing)
            for (let i = 0; i <= 10; i++) {
                const fraction = i / 10;
                // Linear interpolation for Y (Arcade Style)
                const y = horizon + (height - horizon) * fraction;

                // Calculate width at this Y
                const lx = topX * (1 - fraction);
                const rx = (topX + topWidth) + (width - (topX + topWidth)) * fraction;

                ctx.beginPath(); ctx.moveTo(lx, y); ctx.lineTo(rx, y); ctx.stroke();
            }

            // Draw Goal Frame (Background)
            ctx.strokeStyle = '#FFF';
            ctx.lineWidth = 8;
            const goalLeft = width * 0.15;
            const goalRight = width * 0.85;
            ctx.strokeRect(goalLeft, height * 0.1, goalRight - goalLeft, height * 0.6);

            ctx.restore(); // END BLUR

            // 2. Draw Foreground Objects (Sharp)
            goalkeeper.update(ball);
            goalkeeper.draw();
            kicker.draw();

            if (ball) {
                ball.update();
                ball.draw();
            }

            // 3. Particles & Popups (Crash Fix: Use Filter)
            particles = particles.filter(p => {
                p.x += p.vx; p.y += p.vy; p.life--;
                ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI * 2); ctx.fill();
                return p.life > 0;
            });

            popups = popups.filter(p => {
                p.y -= 2; p.life--;
                ctx.fillStyle = p.color;
                ctx.font = 'bold 40px Fredoka';
                ctx.fillText(p.text, p.x, p.y);
                return p.life > 0;
            });

            requestAnimationFrame(gameLoop);
        }

        // Input
        canvas.addEventListener('mousedown', (e) => {
            if (gameRunning && ball && !ball.isKicked) {
                ball.kick(e.clientX, e.clientY);
            }
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (gameRunning && ball && !ball.isKicked) {
                const touch = e.touches[0];
                ball.kick(touch.clientX, touch.clientY);
            }
        });

        // Initialize
        function startRound() {
            gameRunning = true;
            gamePhase = 'playing';
            shotsLeft = 10;
            updateHUD();

            goalkeeper = new Goalkeeper();
            kicker = new Kicker();
            resetBall();
            particles = [];
            popups = [];

            document.getElementById('hud').classList.remove('hidden');
            gameLoop();
        }

        function startGame(players) {
            numPlayers = players;
            currentPlayer = 1;
            p1Score = 0;
            p2Score = 0;
            document.getElementById('mainMenu').classList.add('hidden');
            if (players === 2) {
                document.getElementById('p2ScoreBox').classList.remove('hidden');
                showReadyScreen();
            } else {
                document.getElementById('p2ScoreBox').classList.add('hidden');
                startCountdown();
            }
        }

        function showReadyScreen() {
            const screen = document.getElementById('playerReadyScreen');
            document.getElementById('playerReadyText').textContent = `PLAYER ${currentPlayer} READY?`;
            screen.classList.remove('hidden');
            setTimeout(() => {
                screen.classList.add('hidden');
                startCountdown();
            }, 2000);
        }

        function startCountdown() {
            document.getElementById('countdown').classList.remove('hidden');
            let count = 3;
            const el = document.getElementById('countdownText');
            el.textContent = count;
            const int = setInterval(() => {
                count--;
                if (count > 0) el.textContent = count;
                else if (count === 0) el.textContent = 'KICK!';
                else {
                    clearInterval(int);
                    document.getElementById('countdown').classList.add('hidden');
                    startRound();
                }
            }, 1000);
        }

        function handleBackButton() {
            window.location.href = '../';
        }

        function returnToMainMenu() {
            gameRunning = false;
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('winnerScreen').classList.add('hidden');
        }

        function endRound() {
            gameRunning = false;
            if (numPlayers === 2) {
                if (currentPlayer === 1) {
                    gamePhase = 'scoreReveal';
                    currentPlayer = 2;
                    showReadyScreen();
                } else {
                    document.getElementById('winnerScreen').classList.remove('hidden');
                    document.getElementById('winnerP1Score').textContent = p1Score;
                    document.getElementById('winnerP2Score').textContent = p2Score;
                    document.getElementById('winnerSubtitle').textContent = p1Score > p2Score ? "PLAYER 1 WINS!" : (p2Score > p1Score ? "PLAYER 2 WINS!" : "DRAW!");
                }
            } else {
                document.getElementById('finalScore').textContent = p1Score;
                document.getElementById('endScreen').classList.remove('hidden');
            }
        }

        function addScore(points) {
            if (currentPlayer === 1) p1Score += points; else p2Score += points;
            document.getElementById('p1Score').textContent = p1Score;
            document.getElementById('p2Score').textContent = p2Score;
        }

        function spawnConfetti(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            const colors = ['#FF5252', '#FFD600', '#00E676', '#2196F3', '#E040FB'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.fontSize = (Math.random() * 20 + 10) + 'px';
                confetti.textContent = ['üéâ', 'üéä', '‚ú®', '‚≠ê', '‚öΩ'][Math.floor(Math.random() * 5)];
                confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
                container.appendChild(confetti);
            }
        }

        function rematch() {
            document.getElementById('winnerScreen').classList.add('hidden');
            currentPlayer = 1;
            p1Score = 0;
            p2Score = 0;
            combo = 0;
            startGame(numPlayers);
        }
    </script>
</body>

</html>