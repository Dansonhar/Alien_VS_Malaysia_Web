<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Slipper Sniper - Aliens vs Malaysians</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'fredoka': ['Fredoka', 'sans-serif'] },
                    colors: { 'sambal': '#FF5252', 'durian': '#FFD600', 'pandan': '#00E676' }
                }
            }
        }
    </script>
    <style>
        /* Custom screen styles for non-Tailwind overlay needs if any */
    </style>
</head>

<body
    class="font-fredoka bg-gradient-to-b from-[#FF9A8B] via-[#FF6B6B] to-[#4ECDC4] min-h-screen overflow-hidden touch-none select-none">

    <!-- HUD -->
    <div id="hud"
        class="hidden fixed top-4 left-1/2 -translate-x-1/2 z-50 flex gap-2 md:gap-4 pointer-events-none scale-90 md:scale-100">
        <div
            class="bg-white/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg whitespace-nowrap">
            SCORE: <span id="score" class="text-pandan">0</span>
        </div>
        <div
            class="bg-white/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg whitespace-nowrap">
            TIME: <span id="timer" class="text-sambal">60</span>s
        </div>
        <div
            class="bg-white/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg whitespace-nowrap">
            üëΩ: <span id="remaining" class="text-orange-500">10</span>
        </div>
    </div>

    <canvas id="gameCanvas" class="block w-full h-screen"></canvas>

    <!-- Start Screen -->
    <div id="startScreen"
        class="fixed inset-0 bg-black/85 flex flex-col items-center justify-center z-[100] text-center px-4">
        <h1 class="text-5xl md:text-6xl font-bold text-[#FF5E5E] drop-shadow-[0_4px_0_#000] mb-4">
            üëü SLIPPER SNIPER
        </h1>
        <p class="text-white text-xl mb-8">Mak's secret weapon... now it's your turn!<br>Drag & Release to throw!</p>
        <button onclick="startGame()"
            class="bg-[#00BFA5] text-white font-bold text-2xl px-12 py-4 rounded-full border-4 border-white shadow-[0_8px_0_#00897B] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#00897B] transition-all">
            TAP TO START
        </button>
    </div>

    <!-- End Screen -->
    <div id="endScreen"
        class="hidden fixed inset-0 bg-black/85 flex flex-col items-center justify-center z-[100] text-center px-4">
        <h1 class="text-5xl md:text-6xl font-bold text-durian drop-shadow-[0_4px_0_#000] mb-4">
            ALL CLEAR!
        </h1>
        <p class="text-white text-2xl mb-4">Aliens knocked off:</p>
        <div id="finalScore" class="text-7xl font-bold text-pandan drop-shadow-[0_4px_0_#000] mb-8">0</div>
        <button onclick="startGame()"
            class="bg-pandan text-white font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#2E7D32] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#2E7D32] transition-all">
            PLAY AGAIN
        </button>
        <button onclick="window.location.href='../'"
            class="mt-4 bg-gray-600 text-white font-bold px-6 py-2 rounded-full border-2 border-black">
            BACK TO MENU
        </button>
    </div>

    <button onclick="window.location.href='../'"
        class="fixed bottom-4 left-4 z-[200] bg-red-500 hover:bg-red-600 text-white font-bold px-6 py-3 rounded-xl border-4 border-black shadow-[4px_4px_0_#000] hover:shadow-[2px_2px_0_#000] hover:translate-y-[2px] transition-all flex items-center gap-2">
        <span class="text-2xl">üè†</span> BACK TO MENU
    </button>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resize();
        window.addEventListener('resize', resize);

        let score = 0;
        let timeLeft = 60;
        let timerInterval = null;
        let aliensRemaining = 10;
        let gameRunning = false;
        let slipper = null;
        let aliens = [];
        let effects = [];
        let platforms = [];

        const slipperSpawn = () => ({ x: canvas.width / 2, y: canvas.height - 100 });

        class Platform {
            constructor(x, y, width) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = 20;
            }
            draw() {
                ctx.fillStyle = '#8B4513';
                ctx.fillRect(this.x, this.y, this.width, this.height);
                ctx.fillStyle = '#A0522D';
                ctx.fillRect(this.x, this.y, this.width, 5);
            }
        }

        class Alien {
            constructor(platform) {
                this.platform = platform;
                this.x = platform.x + platform.width / 2;
                this.y = platform.y - 35;
                this.size = 50;
                this.visible = true;
                this.falling = false;
                this.fallVy = 0;
                this.wobble = 0;
                this.hue = Math.floor(Math.random() * 360);
            }
            draw() {
                if (!this.visible) return;
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(Math.sin(this.wobble) * 0.15);

                // Body
                ctx.fillStyle = `hsl(${this.hue}, 70%, 55%)`;
                ctx.beginPath();
                ctx.arc(0, 0, this.size / 2, 0, Math.PI * 2);
                ctx.fill();

                // Eyes
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(-10, -5, 10, 0, Math.PI * 2);
                ctx.arc(10, -5, 10, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(-10, -5, 5, 0, Math.PI * 2);
                ctx.arc(10, -5, 5, 0, Math.PI * 2);
                ctx.fill();

                // Mouth
                if (this.falling) {
                    ctx.beginPath();
                    ctx.arc(0, 10, 10, 0, Math.PI * 2);
                    ctx.stroke();
                } else {
                    ctx.beginPath();
                    ctx.arc(0, 8, 8, 0, Math.PI);
                    ctx.stroke();
                }

                ctx.restore();
            }
            update() {
                this.wobble += 0.1;
                if (this.falling) {
                    this.fallVy += 0.5;
                    this.y += this.fallVy;
                    this.wobble += 0.3;
                    if (this.y > canvas.height + 100) {
                        this.visible = false;
                    }
                }
            }
        }

        class Slipper {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = 0;
                this.vy = 0;
                this.size = 40;
                this.rotation = 0;
                this.thrown = false;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);

                // Slipper base
                ctx.fillStyle = '#E74C3C';
                ctx.beginPath();
                ctx.ellipse(0, 0, this.size / 2, this.size / 3, 0, 0, Math.PI * 2);
                ctx.fill();

                // Strap
                ctx.fillStyle = '#C0392B';
                ctx.beginPath();
                ctx.moveTo(-10, -5);
                ctx.quadraticCurveTo(0, -15, 10, -5);
                ctx.lineTo(5, -5);
                ctx.quadraticCurveTo(0, -10, -5, -5);
                ctx.fill();

                ctx.restore();
            }
            update() {
                if (this.thrown) {
                    this.x += this.vx;
                    this.y += this.vy;
                    this.vy += 0.3; // Gravity
                    this.rotation += 0.2;
                }
            }
        }

        class Effect {
            constructor(x, y, text) {
                this.x = x;
                this.y = y;
                this.text = text;
                this.life = 1;
                this.vy = -2;
            }
            draw() {
                ctx.save();
                ctx.globalAlpha = this.life;
                ctx.font = 'bold 2rem Fredoka';
                ctx.fillStyle = '#FFD43B';
                ctx.textAlign = 'center';
                ctx.fillText(this.text, this.x, this.y);
                ctx.restore();
            }
            update() {
                this.y += this.vy;
                this.life -= 0.02;
            }
        }

        function setupLevel() {
            platforms = [];
            aliens = [];

            const rows = 3;
            const cols = 4;
            const startX = canvas.width * 0.1;
            const totalWidth = canvas.width * 0.8;
            const gapX = totalWidth / cols;
            const gapY = (canvas.height * 0.5) / rows;

            for (let r = 0; r < rows; r++) {
                for (let c = 0; c < cols; c++) {
                    if (Math.random() > 0.3) {
                        const px = startX + c * gapX + Math.random() * 30;
                        const py = 100 + r * gapY;
                        const pw = 60 + Math.random() * 40;
                        const p = new Platform(px, py, pw);
                        platforms.push(p);
                        aliens.push(new Alien(p));
                    }
                }
            }
            aliensRemaining = aliens.length;
            document.getElementById('remaining').textContent = aliensRemaining;
        }

        function checkCollision(s, a) {
            const dx = s.x - a.x;
            const dy = s.y - a.y;
            return Math.sqrt(dx * dx + dy * dy) < (s.size / 2 + a.size / 2);
        }

        function gameLoop() {
            if (!gameRunning) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw platforms
            platforms.forEach(p => p.draw());

            // Update and draw aliens
            aliens.forEach(a => {
                a.update();
                a.draw();
            });

            // Update and draw slipper
            if (slipper) {
                slipper.update();
                slipper.draw();

                if (slipper.thrown) {
                    aliens.forEach(a => {
                        if (a.visible && !a.falling && checkCollision(slipper, a)) {
                            a.falling = true;
                            score++;
                            aliensRemaining--;
                            document.getElementById('score').textContent = score;
                            document.getElementById('remaining').textContent = aliensRemaining;
                            effects.push(new Effect(a.x, a.y, 'BONK!'));

                            // Check win
                            if (aliensRemaining <= 0) {
                                endGame();
                            }
                        }
                    });

                    // Reset if off screen (Left, Right, Bottom OR Top)
                    // Removing premature resets!
                    const isOffScreen =
                        slipper.y > canvas.height + 100 ||
                        slipper.x < -100 ||
                        slipper.x > canvas.width + 100 ||
                        slipper.y < -100;

                    if (isOffScreen) {
                        slipper = new Slipper(slipperSpawn().x, slipperSpawn().y);
                    }
                } else {
                    // Draw drag line if dragging
                    // Logic handled in input, but visualization could be here
                }
            }

            // Effects
            effects = effects.filter(e => e.life > 0);
            effects.forEach(e => { e.update(); e.draw(); });

            requestAnimationFrame(gameLoop);
        }

        function handleInput(e) {
            if (!gameRunning || !slipper || slipper.thrown) return;
            e.preventDefault();

            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const x = clientX - rect.left;
            const y = clientY - rect.top;

            // Simple click-to-fling towards click direction
            // Calculate vector from slipper to click
            const dx = x - slipper.x;
            const dy = y - slipper.y;

            // Normalize and multiply force
            const angle = Math.atan2(dy, dx);
            const force = 35; // velocity magnitude

            slipper.vx = Math.cos(angle) * force;
            slipper.vy = Math.sin(angle) * force;
            slipper.thrown = true;

            // NO TIMEOUT RESET HERE! 
            // Reset happens in gameLoop when off-screen.
        }

        canvas.addEventListener('pointerdown', handleInput);

        function startGame() {
            score = 0;
            timeLeft = 60;
            gameRunning = true;
            document.getElementById('score').textContent = score;
            document.getElementById('timer').textContent = 60;
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');

            setupLevel();
            slipper = new Slipper(slipperSpawn().x, slipperSpawn().y);
            effects = [];

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);

            requestAnimationFrame(gameLoop);
        }

        function endGame() {
            gameRunning = false;
            if (timerInterval) clearInterval(timerInterval);
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('finalScore').textContent = score;
            document.getElementById('endScreen').classList.remove('hidden');
        }
    </script>
</body>

</html>