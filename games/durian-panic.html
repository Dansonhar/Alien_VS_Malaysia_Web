<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Durian Panic! - Aliens vs Malaysians</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'fredoka': ['Fredoka', 'sans-serif'] },
                    colors: { 'sambal': '#FF5252', 'durian': '#FFD600', 'pandan': '#00E676' }
                }
            }
        }
    </script>
    <style>
        .pulse-text {
            animation: pulseText 1s ease-in-out infinite;
        }

        @keyframes pulseText {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .winner-bounce {
            animation: winnerBounce 0.5s ease-out forwards, winnerGlow 1s ease-in-out infinite 0.5s;
        }

        @keyframes winnerBounce {
            0% {
                transform: scale(0) rotate(-10deg);
            }

            50% {
                transform: scale(1.3) rotate(5deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
            }
        }

        @keyframes winnerGlow {

            0%,
            100% {
                filter: drop-shadow(0 0 20px gold);
            }

            50% {
                filter: drop-shadow(0 0 40px gold);
            }
        }

        .confetti {
            position: fixed;
            pointer-events: none;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>

<body
    class="font-fredoka bg-gradient-to-b from-yellow-600 via-yellow-500 to-orange-400 min-h-screen overflow-hidden touch-none select-none">
    <canvas id="gameCanvas" class="block w-full h-screen"></canvas>

    <!-- HUD -->
    <div id="hud" class="hidden fixed inset-0 pointer-events-none z-50">
        <div class="absolute top-4 left-1/2 -translate-x-1/2 flex gap-4 flex-wrap justify-center">
            <div
                class="bg-white/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg">
                ‚è±Ô∏è <span id="timer" class="text-sambal">45</span>s</div>
            <div id="p1ScoreBox"
                class="bg-durian/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg">
                P1: <span id="p1Score">0</span></div>
            <div id="p2ScoreBox"
                class="hidden bg-orange-500/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg text-white">
                P2: <span id="p2Score">0</span></div>
            <div id="comboBox"
                class="hidden bg-sambal/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg text-white">
                üî• <span id="comboCount">0</span>x</div>
        </div>
        <div class="absolute top-16 left-1/2 -translate-x-1/2">
            <div id="difficultyBadge" class="bg-pandan px-4 py-1 rounded-full border-2 border-black font-bold text-sm">
                EASY</div>
        </div>
    </div>

    <!-- Countdown -->
    <div id="countdown"
        class="hidden fixed inset-0 flex items-center justify-center z-[80] bg-black/70 pointer-events-none">
        <div id="countdownText" class="text-9xl font-bold text-white drop-shadow-[0_8px_0_#000]">3</div>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu"
        class="fixed inset-0 bg-gradient-to-b from-yellow-800 to-orange-900 flex flex-col items-center justify-center z-[100] text-center px-4">
        <div class="text-8xl mb-4 animate-bounce">üçà</div>
        <h1 class="text-5xl md:text-7xl font-bold text-durian drop-shadow-[0_6px_0_#000] mb-2">DURIAN PANIC!</h1>
        <p class="text-white text-xl mb-2 max-w-md">"Aliens don't understand durian.<br>Malaysians don't understand why
            aliens still standing."</p>
        <p class="text-yellow-300 text-lg mb-6">Throw durians at aliens!</p>
        <div class="flex gap-2 mb-6">
            <button onclick="setDifficulty('easy')" id="btnEasy"
                class="bg-pandan text-black font-bold px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000]">EASY</button>
            <button onclick="setDifficulty('normal')" id="btnNormal"
                class="bg-durian text-black font-bold px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] opacity-60">NORMAL</button>
            <button onclick="setDifficulty('hard')" id="btnHard"
                class="bg-sambal text-white font-bold px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] opacity-60">HARD</button>
        </div>
        <button onclick="startGame(1)"
            class="bg-pandan text-black font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#2E7D32] hover:-translate-y-1 active:translate-y-1 transition-all mb-4 w-72">üë§
            1 PLAYER</button>
        <button onclick="startGame(2)"
            class="bg-durian text-black font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#B8860B] hover:-translate-y-1 active:translate-y-1 transition-all w-72">üë•
            2 PLAYER (TURN)</button>
    </div>

    <!-- Player Ready Screen -->
    <div id="playerReadyScreen"
        class="hidden fixed inset-0 bg-gradient-to-b from-yellow-800 to-orange-900 flex flex-col items-center justify-center z-[90] text-center px-4">
        <div class="text-9xl mb-4 pulse-text">üçà</div>
        <h1 id="playerReadyText"
            class="text-5xl md:text-7xl font-bold text-durian drop-shadow-[0_6px_0_#000] mb-4 pulse-text">PLAYER 1
            READY?</h1>
        <p class="text-white text-2xl">Get ready to throw some durians!</p>
    </div>

    <!-- Score Reveal Screen -->
    <div id="scoreRevealScreen"
        class="hidden fixed inset-0 bg-black/95 flex flex-col items-center justify-center z-[95] text-center px-4">
        <div id="confettiContainer"></div>
        <h2 id="scoreRevealTitle" class="text-4xl md:text-5xl font-bold text-durian drop-shadow-[0_4px_0_#000] mb-4">
            PLAYER 1 SCORED</h2>
        <div id="scoreRevealNumber" class="text-8xl md:text-9xl font-bold text-pandan drop-shadow-[0_8px_0_#000] mb-8">0
        </div>
        <p class="text-white text-xl animate-pulse">Tap to continue...</p>
    </div>

    <!-- Winner Screen -->
    <div id="winnerScreen"
        class="hidden fixed inset-0 bg-gradient-to-b from-yellow-800 via-black to-orange-900 flex flex-col items-center justify-center z-[100] text-center px-4">
        <div id="winnerConfettiContainer"></div>
        <div class="text-9xl mb-4 winner-bounce">üèÜ</div>
        <h1 class="text-4xl md:text-6xl font-bold text-durian drop-shadow-[0_6px_0_#000] mb-2 winner-bounce">WHO MORE
            POWER?</h1>
        <h2 id="winnerSubtitle" class="text-3xl md:text-5xl font-bold text-pandan drop-shadow-[0_4px_0_#000] mb-8"></h2>
        <div class="flex gap-8 justify-center mb-8">
            <div class="text-center">
                <div class="text-durian font-bold text-2xl">Player 1</div>
                <div id="winnerP1Score" class="text-5xl font-bold text-white drop-shadow-[0_4px_0_#000]">0</div>
            </div>
            <div class="text-6xl font-bold text-white">VS</div>
            <div class="text-center">
                <div class="text-orange-400 font-bold text-2xl">Player 2</div>
                <div id="winnerP2Score" class="text-5xl font-bold text-white drop-shadow-[0_4px_0_#000]">0</div>
            </div>
        </div>
        <button onclick="rematch()"
            class="bg-pandan text-black font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#2E7D32] hover:-translate-y-1 transition-all mb-4">üî•
            FIGHT AGAIN!</button>
        <button onclick="returnToMainMenu()"
            class="bg-gray-600 text-white font-bold text-xl px-8 py-3 rounded-full border-4 border-black shadow-[0_6px_0_#374151] transition-all">üè†
            MAIN MENU</button>
    </div>

    <!-- End Screen -->
    <div id="endScreen"
        class="hidden fixed inset-0 bg-black/90 flex flex-col items-center justify-center z-[100] text-center px-4">
        <div class="text-8xl mb-4">üò≠</div>
        <h1 class="text-5xl md:text-6xl font-bold text-durian drop-shadow-[0_4px_0_#000] mb-4">TIME'S UP!</h1>
        <p class="text-white text-xl mb-2">Final Score:</p>
        <div id="finalScore" class="text-6xl font-bold text-pandan drop-shadow-[0_4px_0_#000] mb-8">0</div>
        <button onclick="location.reload()"
            class="bg-pandan text-black font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#2E7D32] transition-all">PLAY
            AGAIN</button>
        <button onclick="window.location.href='../'"
            class="mt-4 bg-gray-600 text-white font-bold px-6 py-2 rounded-full border-2 border-black">BACK TO
            HUB</button>
    </div>

    <!-- Back Button -->
    <button onclick="handleBackButton()"
        class="fixed bottom-4 left-4 z-[200] bg-red-500 hover:bg-red-600 text-white font-bold px-6 py-3 rounded-xl border-4 border-black shadow-[4px_4px_0_#000] transition-all flex items-center gap-2 pointer-events-auto">
        <span class="text-2xl">üîô</span> MENU
    </button>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize);
        resize();

        // Game State
        let gameRunning = false, numPlayers = 1, currentPlayer = 1, p1Score = 0, p2Score = 0;
        let timeRemaining = 45, gameTimer = null, difficulty = 'easy', gamePhase = 'menu';
        let combo = 0, lastHitTime = 0;
        let aliens = [], durians = [], particles = [], smellClouds = [], popups = [], helpers = [], frameCount = 0;

        // Asset paths - CHANGE THESE TO USE YOUR OWN CUSTOM ASSETS
        const ASSETS = {
            alienNormal: '../assets/alien_normal.png',
            alienHelmet: '../assets/alien_helmet.png',
            alienHit: '../assets/alien_hit.png',
            durian: '../assets/durian.png',
            malaysianMale: '../assets/malaysian_male.png',
            malaysianFemale: '../assets/malaysian_female.png'
        };

        // Preload images
        const images = {};
        let imagesLoaded = 0;
        const totalImages = Object.keys(ASSETS).length;

        Object.entries(ASSETS).forEach(([key, src]) => {
            const img = new Image();
            img.onload = () => { imagesLoaded++; };
            img.onerror = () => { imagesLoaded++; console.log('Asset not found:', src, '- using canvas drawing'); };
            img.src = src;
            images[key] = img;
        });

        // Entry points for aliens
        const entryPoints = [
            { type: 'left', getPos: () => ({ x: -80, y: 150 + Math.random() * (height * 0.4) }) },
            { type: 'right', getPos: () => ({ x: width + 80, y: 150 + Math.random() * (height * 0.4) }) },
            { type: 'roof', getPos: () => ({ x: 150 + Math.random() * (width - 300), y: -80 }) },
            { type: 'window_left', getPos: () => ({ x: 120, y: height * 0.5 }) },
            { type: 'window_right', getPos: () => ({ x: width - 120, y: height * 0.5 }) }
        ];

        // Difficulty settings - PROPER ALIEN COUNTS
        const difficultySettings = {
            easy: { maxAliens: 3, spawnDelay: 180, speed: 0.8, hitbox: 90, helmetChance: 0, fakeChance: 0, pauseChance: 0.3, time: 45 },
            normal: { maxAliens: 5, spawnDelay: 120, speed: 1.2, hitbox: 75, helmetChance: 0.2, fakeChance: 0.15, pauseChance: 0.2, time: 40 },
            hard: { maxAliens: 6, spawnDelay: 90, speed: 1.6, hitbox: 65, helmetChance: 0.3, fakeChance: 0.25, pauseChance: 0.15, time: 35 }
        };

        function setDifficulty(diff) {
            difficulty = diff;
            document.getElementById('btnEasy').classList.toggle('opacity-60', diff !== 'easy');
            document.getElementById('btnNormal').classList.toggle('opacity-60', diff !== 'normal');
            document.getElementById('btnHard').classList.toggle('opacity-60', diff !== 'hard');
        }

        function handleBackButton() { gamePhase === 'menu' ? window.location.href = '../' : returnToMainMenu(); }

        function returnToMainMenu() {
            gameRunning = false; clearInterval(gameTimer); gamePhase = 'menu';
            document.getElementById('mainMenu').classList.remove('hidden');
            ['hud', 'endScreen', 'winnerScreen', 'scoreRevealScreen', 'playerReadyScreen'].forEach(id => document.getElementById(id).classList.add('hidden'));
            aliens = []; durians = []; particles = []; smellClouds = []; popups = [];
        }

        // IMPROVED ALIEN CLASS with proper entry, movement, and reactions
        class Alien {
            constructor() {
                const settings = difficultySettings[difficulty];
                const entry = entryPoints[Math.floor(Math.random() * entryPoints.length)];
                const pos = entry.getPos();

                this.x = pos.x; this.y = pos.y;
                this.entryType = entry.type;
                this.size = settings.hitbox;
                this.speed = settings.speed * (0.8 + Math.random() * 0.4);
                this.hue = 120 + Math.random() * 40;

                // State machine: peeking -> entering -> floating -> [pause/sniff/slip] -> exiting
                this.state = 'peeking';
                this.stateTimer = 0;
                this.animTimer = 0;

                // Movement
                this.targetX = 200 + Math.random() * (width - 400);
                this.targetY = 150 + Math.random() * (height * 0.35);
                this.floatPhase = Math.random() * Math.PI * 2;
                this.direction = this.x < width / 2 ? 1 : -1;

                // Special properties
                this.health = Math.random() < settings.helmetChance ? 2 : 1;
                this.hasHelmet = this.health > 1;
                this.isFake = Math.random() < settings.fakeChance;
                if (this.isFake) this.hue = 200; // Blue for balloon

                // Lawak bodoh timers
                this.pauseTimer = 0;
                this.lookingAround = false;
                this.eyeDirection = 0;
            }

            update() {
                const settings = difficultySettings[difficulty];
                this.animTimer++;
                this.stateTimer++;

                switch (this.state) {
                    case 'peeking':
                        // Alien peeks for 1 second, looking left-right
                        this.lookingAround = true;
                        this.eyeDirection = Math.sin(this.stateTimer * 0.15) * 0.8;
                        if (this.stateTimer > 60) { this.state = 'entering'; this.stateTimer = 0; this.lookingAround = false; }
                        break;

                    case 'entering':
                        // Slowly float to target position
                        const dx = this.targetX - this.x, dy = this.targetY - this.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist > 5) {
                            this.x += (dx / dist) * this.speed * 1.5;
                            this.y += (dy / dist) * this.speed * 1.5;
                        } else {
                            this.state = 'floating'; this.stateTimer = 0;
                        }
                        break;

                    case 'floating':
                        // Gentle floating movement
                        this.floatPhase += 0.03;
                        this.x += Math.sin(this.floatPhase) * this.speed * 0.5;
                        this.y += Math.cos(this.floatPhase * 0.7) * this.speed * 0.3;

                        // Random behaviors
                        if (this.pauseTimer <= 0 && Math.random() < 0.005 * settings.pauseChance * 10) {
                            const behaviors = ['pause', 'sniff', 'slip_random'];
                            this.state = behaviors[Math.floor(Math.random() * behaviors.length)];
                            this.stateTimer = 0;
                        }

                        // Keep in bounds
                        if (this.x < 100) { this.x = 100; this.direction = 1; }
                        if (this.x > width - 100) { this.x = width - 100; this.direction = -1; }
                        if (this.y < 100) this.y = 100;
                        if (this.y > height * 0.55) this.y = height * 0.55;

                        // Exit after 8-12 seconds
                        if (this.stateTimer > 480 + Math.random() * 240) { this.state = 'exiting'; this.stateTimer = 0; }
                        break;

                    case 'pause':
                        // Freeze for 1 second (easy hit!)
                        if (this.stateTimer > 60) { this.state = 'floating'; this.stateTimer = 0; this.pauseTimer = 180; }
                        break;

                    case 'sniff':
                        // Smell durian fear - wobble and look scared
                        this.eyeDirection = Math.sin(this.stateTimer * 0.3) * 0.5;
                        if (this.stateTimer > 90) { this.state = 'floating'; this.stateTimer = 0; this.pauseTimer = 180; }
                        break;

                    case 'slip_random':
                        // Random slip on invisible banana
                        this.y += Math.sin(this.stateTimer * 0.2) * 2;
                        this.direction = Math.sin(this.stateTimer * 0.1) > 0 ? 1 : -1;
                        if (this.stateTimer > 60) { this.state = 'floating'; this.stateTimer = 0; }
                        break;

                    case 'exiting':
                        // Float away
                        this.x += this.direction * this.speed * 2;
                        if (this.x < -100 || this.x > width + 100) return false;
                        break;

                    case 'hit':
                        // Overreaction!
                        if (this.stateTimer > 60) return false;
                        break;

                    case 'laughing':
                        // When player misses
                        if (this.stateTimer > 90) { this.state = 'floating'; this.stateTimer = 0; }
                        break;

                    case 'faint':
                    case 'slip':
                    case 'runaway':
                        if (this.stateTimer > 80) return false;
                        break;
                }

                if (this.pauseTimer > 0) this.pauseTimer--;
                return true;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);

                // State-based animations
                let scale = 1, rotate = 0, alpha = 1;

                if (this.state === 'peeking') {
                    // Only show part of alien
                    const peekProgress = Math.min(this.stateTimer / 30, 1);
                    scale = 0.3 + peekProgress * 0.3;
                } else if (this.state === 'entering') {
                    scale = 0.6 + (this.stateTimer / 60) * 0.4;
                } else if (this.state === 'hit') {
                    rotate = Math.sin(this.stateTimer * 0.8) * 0.4;
                    scale = 1 + Math.sin(this.stateTimer * 0.5) * 0.2;
                } else if (this.state === 'faint') {
                    const p = this.stateTimer / 80;
                    ctx.translate(0, p * 100);
                    rotate = p * Math.PI * 0.5;
                    alpha = 1 - p;
                } else if (this.state === 'slip') {
                    const p = this.stateTimer / 80;
                    ctx.translate(Math.sin(this.stateTimer * 0.5) * 30, p * 80);
                    rotate = -p * Math.PI * 0.6;
                    alpha = 1 - p * 0.8;
                } else if (this.state === 'runaway') {
                    this.x += this.direction * 8;
                    scale = 1 - (this.stateTimer / 80) * 0.5;
                } else if (this.state === 'laughing') {
                    scale = 1 + Math.sin(this.stateTimer * 0.3) * 0.1;
                } else if (this.state === 'sniff') {
                    scale = 0.9 + Math.sin(this.stateTimer * 0.2) * 0.1;
                } else if (this.state === 'pause') {
                    // Frozen - slight sparkle effect
                }

                ctx.rotate(rotate);
                ctx.scale(scale, scale);
                ctx.globalAlpha = alpha;

                // Draw body
                if (this.isFake) {
                    // Balloon alien
                    ctx.fillStyle = '#64B5F6';
                    ctx.beginPath();
                    ctx.ellipse(0, 0, this.size * 0.5, this.size * 0.6, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#1976D2';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    // String
                    ctx.beginPath();
                    ctx.moveTo(0, this.size * 0.5);
                    ctx.quadraticCurveTo(10, this.size * 0.7, 0, this.size * 0.9);
                    ctx.stroke();
                    // "FAKE" face
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(-12, -5, 6, 0, Math.PI * 2);
                    ctx.arc(12, -5, 6, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#FFF';
                    ctx.font = 'bold 12px Fredoka';
                    ctx.textAlign = 'center';
                    ctx.fillText('FAKE', 0, this.size * 0.3);
                } else {
                    // Real alien
                    ctx.fillStyle = `hsl(${this.hue}, 70%, 50%)`;
                    ctx.beginPath();
                    ctx.ellipse(0, 0, this.size * 0.5, this.size * 0.45, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 3;
                    ctx.stroke();

                    // Eyes
                    const eyeOffset = this.eyeDirection * 5;
                    ctx.fillStyle = '#FFF';
                    ctx.beginPath();
                    ctx.ellipse(-15 + eyeOffset, -8, 14, 16, 0, 0, Math.PI * 2);
                    ctx.ellipse(15 + eyeOffset, -8, 14, 16, 0, 0, Math.PI * 2);
                    ctx.fill();

                    // Pupils
                    ctx.fillStyle = '#000';
                    if (this.state === 'faint' || this.state === 'hit') {
                        // Spiral eyes
                        ctx.save();
                        ctx.translate(-15, -8);
                        for (let i = 0; i < 3; i++) {
                            ctx.rotate(this.animTimer * 0.15);
                            ctx.beginPath();
                            ctx.moveTo(0, 0);
                            ctx.lineTo(8, 0);
                            ctx.stroke();
                        }
                        ctx.restore();
                        ctx.save();
                        ctx.translate(15, -8);
                        for (let i = 0; i < 3; i++) {
                            ctx.rotate(-this.animTimer * 0.15);
                            ctx.beginPath();
                            ctx.moveTo(0, 0);
                            ctx.lineTo(8, 0);
                            ctx.stroke();
                        }
                        ctx.restore();
                    } else {
                        const pupilMove = this.lookingAround ? this.eyeDirection * 8 : Math.sin(frameCount * 0.05) * 3;
                        ctx.beginPath();
                        ctx.arc(-15 + pupilMove, -8, 5, 0, Math.PI * 2);
                        ctx.arc(15 + pupilMove, -8, 5, 0, Math.PI * 2);
                        ctx.fill();
                    }

                    // Mouth
                    ctx.beginPath();
                    if (this.state === 'laughing') {
                        ctx.arc(0, 12, 12, 0, Math.PI);
                        ctx.fill();
                    } else if (this.state === 'hit' || this.state === 'faint' || this.state === 'sniff') {
                        ctx.ellipse(0, 12, 10, 14, 0, 0, Math.PI * 2);
                        ctx.fill();
                    } else {
                        ctx.arc(0, 12, 8, 0, Math.PI);
                        ctx.fill();
                    }

                    // Helmet
                    if (this.hasHelmet) {
                        ctx.fillStyle = '#607D8B';
                        ctx.beginPath();
                        ctx.ellipse(0, -this.size * 0.3, this.size * 0.45, this.size * 0.2, 0, Math.PI, 0);
                        ctx.fill();
                        ctx.strokeStyle = '#455A64';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    }

                    // Arms
                    ctx.strokeStyle = `hsl(${this.hue}, 70%, 40%)`;
                    ctx.lineWidth = 8;
                    ctx.lineCap = 'round';
                    const armWave = this.state === 'hit' || this.state === 'laughing' ? Math.sin(this.animTimer * 0.4) * 0.8 : Math.sin(this.animTimer * 0.1) * 0.2;
                    ctx.beginPath();
                    ctx.moveTo(-this.size * 0.4, 5);
                    ctx.lineTo(-this.size * 0.7, -10 + Math.sin(armWave) * 25);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(this.size * 0.4, 5);
                    ctx.lineTo(this.size * 0.7, -10 + Math.sin(-armWave + 1) * 25);
                    ctx.stroke();

                    // Stars when fainting
                    if (this.state === 'faint') {
                        ctx.fillStyle = '#FFD700';
                        for (let i = 0; i < 5; i++) {
                            const a = (i / 5) * Math.PI * 2 + this.animTimer * 0.1;
                            ctx.font = '16px Arial';
                            ctx.fillText('‚≠ê', Math.cos(a) * 40 - 8, -35 + Math.sin(a) * 15);
                        }
                    }

                    // Pointing when laughing at miss
                    if (this.state === 'laughing') {
                        ctx.font = '24px Arial';
                        ctx.fillText('üòÇ', -12, -this.size * 0.5);
                    }
                }

                ctx.restore();
            }

            hit() {
                this.health--;
                if (this.health <= 0) {
                    const reactions = ['faint', 'slip', 'runaway'];
                    this.state = reactions[Math.floor(Math.random() * reactions.length)];
                    this.stateTimer = 0;
                    return true;
                } else {
                    this.state = 'hit';
                    this.stateTimer = 0;
                    this.hasHelmet = false;
                    setTimeout(() => { if (this.state === 'hit') { this.state = 'floating'; this.stateTimer = 0; } }, 500);
                    return false;
                }
            }

            triggerLaugh() {
                if (this.state === 'floating') {
                    this.state = 'laughing';
                    this.stateTimer = 0;
                }
            }
        }

        // MALAYSIAN HELPER - Friendly character that helps throw durians!
        class MalaysianHelper {
            constructor(side) {
                this.side = side; // 'left' or 'right'
                this.isMale = Math.random() > 0.5;
                this.x = side === 'left' ? 100 : width - 100;
                this.y = height * 0.7;
                this.size = 80;
                this.state = 'idle'; // idle, throwing, cheering
                this.stateTimer = 0;
                this.throwCooldown = 0;
                this.targetAlien = null;
            }

            update() {
                this.stateTimer++;
                if (this.throwCooldown > 0) this.throwCooldown--;

                // Find a floating alien to throw at
                if (this.state === 'idle' && this.throwCooldown <= 0) {
                    const activeAliens = aliens.filter(a => a.state === 'floating' || a.state === 'pause' || a.state === 'sniff');
                    if (activeAliens.length > 0 && Math.random() < 0.01) { // 1% chance per frame
                        this.targetAlien = activeAliens[Math.floor(Math.random() * activeAliens.length)];
                        this.state = 'throwing';
                        this.stateTimer = 0;
                    }
                }

                if (this.state === 'throwing') {
                    if (this.stateTimer === 30 && this.targetAlien) {
                        // Actually throw the durian
                        durians.push(new Durian(this.x, this.y - 30, this.targetAlien.x, this.targetAlien.y));
                        popups.push(new Popup(this.x, this.y - 60, 'TOLONG!', '#FFD600', true));
                    }
                    if (this.stateTimer > 60) {
                        this.state = 'idle';
                        this.stateTimer = 0;
                        this.throwCooldown = 180; // 3 seconds cooldown
                    }
                }

                // Cheer when player hits an alien
                if (this.state === 'cheering' && this.stateTimer > 60) {
                    this.state = 'idle';
                    this.stateTimer = 0;
                }

                return true;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);

                // Bounce animation
                const bounce = this.state === 'cheering' ? Math.sin(this.stateTimer * 0.3) * 10 : 0;
                ctx.translate(0, -bounce);

                // Throwing wind-up
                if (this.state === 'throwing' && this.stateTimer < 30) {
                    ctx.rotate(-0.2);
                } else if (this.state === 'throwing') {
                    ctx.rotate(0.1);
                }

                // Try to draw PNG asset, fallback to canvas drawing
                const imgKey = this.isMale ? 'malaysianMale' : 'malaysianFemale';
                if (images[imgKey] && images[imgKey].complete && images[imgKey].naturalWidth > 0) {
                    ctx.drawImage(images[imgKey], -this.size / 2, -this.size / 2, this.size, this.size);
                } else {
                    // Fallback: draw simple character
                    this.drawFallback();
                }

                // Speech bubble when throwing
                if (this.state === 'throwing' && this.stateTimer < 30) {
                    ctx.fillStyle = '#FFF';
                    ctx.beginPath();
                    ctx.ellipse(this.side === 'left' ? 50 : -50, -50, 40, 25, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    ctx.fillStyle = '#000';
                    ctx.font = 'bold 14px Fredoka';
                    ctx.textAlign = 'center';
                    ctx.fillText('Makan ni!', this.side === 'left' ? 50 : -50, -45);
                }

                ctx.restore();
            }

            drawFallback() {
                // Simple cartoon Malaysian
                // Body
                ctx.fillStyle = this.isMale ? '#2196F3' : '#E91E63';
                ctx.beginPath();
                ctx.ellipse(0, 10, 25, 35, 0, 0, Math.PI * 2);
                ctx.fill();

                // Head
                ctx.fillStyle = '#D7A377';
                ctx.beginPath();
                ctx.arc(0, -25, 22, 0, Math.PI * 2);
                ctx.fill();

                // Hat/Tudung
                if (this.isMale) {
                    ctx.fillStyle = '#1A237E';
                    ctx.beginPath();
                    ctx.rect(-15, -48, 30, 20);
                    ctx.fill();
                } else {
                    ctx.fillStyle = '#E91E63';
                    ctx.beginPath();
                    ctx.arc(0, -25, 25, Math.PI, 0);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.ellipse(0, -5, 28, 15, 0, Math.PI * 0.8, Math.PI * 0.2);
                    ctx.fill();
                }

                // Eyes
                ctx.fillStyle = '#FFF';
                ctx.beginPath();
                ctx.arc(-8, -28, 6, 0, Math.PI * 2);
                ctx.arc(8, -28, 6, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(-8, -28, 3, 0, Math.PI * 2);
                ctx.arc(8, -28, 3, 0, Math.PI * 2);
                ctx.fill();

                // Smile
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(0, -20, 10, 0.2, Math.PI - 0.2);
                ctx.stroke();

                // Arms
                ctx.strokeStyle = '#D7A377';
                ctx.lineWidth = 8;
                ctx.lineCap = 'round';
                const armAngle = this.state === 'throwing' ? Math.sin(this.stateTimer * 0.2) * 0.5 : 0;
                ctx.beginPath();
                ctx.moveTo(-20, 0);
                ctx.lineTo(-35, -15 + armAngle * 20);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(20, 0);
                ctx.lineTo(35, -15 - armAngle * 20);
                ctx.stroke();
            }

            cheer() {
                this.state = 'cheering';
                this.stateTimer = 0;
            }
        }


        // Durian class
        class Durian {
            constructor(startX, startY, targetX, targetY) {
                this.x = startX; this.y = startY;
                this.size = 45; this.rotation = 0; this.life = 70; this.hasHit = false;
                const dx = targetX - startX, dy = targetY - startY;
                const dist = Math.sqrt(dx * dx + dy * dy);
                this.speed = 18;
                this.vx = (dx / dist) * this.speed;
                this.vy = (dy / dist) * this.speed;
            }

            update() {
                this.x += this.vx; this.y += this.vy;
                this.rotation += 0.35; this.vy += 0.15; this.life--;
                return this.life > 0 && !this.hasHit && this.y < height + 50;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                ctx.fillStyle = '#8BC34A';
                ctx.beginPath();
                ctx.ellipse(0, 0, this.size * 0.5, this.size * 0.4, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#689F38';
                for (let i = 0; i < 12; i++) {
                    const a = (i / 12) * Math.PI * 2;
                    ctx.beginPath();
                    ctx.moveTo(Math.cos(a) * 18, Math.sin(a) * 14);
                    ctx.lineTo(Math.cos(a) * 28, Math.sin(a) * 22);
                    ctx.lineTo(Math.cos(a + 0.3) * 18, Math.sin(a + 0.3) * 14);
                    ctx.closePath();
                    ctx.fill();
                }
                ctx.restore();
            }

            checkCollision(alien) {
                const dx = this.x - alien.x, dy = this.y - alien.y;
                return Math.sqrt(dx * dx + dy * dy) < (this.size * 0.5 + alien.size * 0.5);
            }
        }

        // SmellCloud, Particle, Popup classes
        class SmellCloud {
            constructor(x, y) { this.x = x; this.y = y; this.size = 30; this.life = 90; }
            update() { this.y -= 0.8; this.size += 0.8; this.life--; return this.life > 0; }
            draw() {
                ctx.save(); ctx.globalAlpha = this.life / 90 * 0.7;
                ctx.fillStyle = '#7CB342';
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                ctx.font = `${this.size}px Arial`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText('üí®', this.x, this.y);
                ctx.restore();
            }
        }

        class Popup {
            constructor(x, y, text, color, big = false) { this.x = x; this.y = y; this.text = text; this.color = color; this.life = 50; this.big = big; }
            update() { this.y -= 1.5; this.life--; return this.life > 0; }
            draw() {
                ctx.save(); ctx.globalAlpha = Math.min(1, this.life / 20);
                ctx.font = this.big ? 'bold 48px Fredoka' : 'bold 32px Fredoka';
                ctx.textAlign = 'center'; ctx.fillStyle = this.color; ctx.strokeStyle = '#000'; ctx.lineWidth = 4;
                ctx.strokeText(this.text, this.x, this.y); ctx.fillText(this.text, this.x, this.y);
                ctx.restore();
            }
        }

        class Particle {
            constructor(x, y, color) { this.x = x; this.y = y; this.vx = (Math.random() - 0.5) * 12; this.vy = (Math.random() - 0.5) * 12 - 4; this.life = 1; this.color = color; this.size = 4 + Math.random() * 6; }
            update() { this.x += this.vx; this.y += this.vy; this.vy += 0.3; this.life -= 0.03; return this.life > 0; }
            draw() { ctx.save(); ctx.globalAlpha = this.life; ctx.fillStyle = this.color; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); ctx.restore(); }
        }

        // Game functions
        function startGame(players) {
            numPlayers = players; currentPlayer = 1; p1Score = 0; p2Score = 0; combo = 0;
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('p2ScoreBox').classList.toggle('hidden', players === 1);
            gamePhase = players === 2 ? 'ready' : 'countdown';
            players === 2 ? showReadyScreen() : startCountdown();
        }

        function showReadyScreen() {
            document.getElementById('playerReadyScreen').classList.remove('hidden');
            document.getElementById('playerReadyText').textContent = `PLAYER ${currentPlayer} READY?`;
            document.getElementById('playerReadyText').style.color = currentPlayer === 1 ? '#FFD600' : '#F97316';
            setTimeout(() => { document.getElementById('playerReadyScreen').classList.add('hidden'); startCountdown(); }, 2000);
        }

        function startCountdown() {
            const countEl = document.getElementById('countdown');
            const textEl = document.getElementById('countdownText');
            countEl.classList.remove('hidden');
            let count = 3; textEl.textContent = count;
            const intv = setInterval(() => {
                count--;
                if (count > 0) textEl.textContent = count;
                else if (count === 0) textEl.textContent = 'THROW!';
                else { clearInterval(intv); countEl.classList.add('hidden'); startRound(); }
            }, 1000);
        }

        function startRound() {
            gameRunning = true; gamePhase = 'playing';
            aliens = []; durians = []; particles = []; smellClouds = []; popups = [];
            combo = 0; frameCount = 0; lastSpawn = 0;

            // Spawn Malaysian helpers - one on each side
            helpers = [new MalaysianHelper('left'), new MalaysianHelper('right')];
            timeRemaining = difficultySettings[difficulty].time;
            document.getElementById('timer').textContent = timeRemaining;
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('difficultyBadge').textContent = difficulty.toUpperCase();
            updateScoreDisplay(); updateComboDisplay();
            gameTimer = setInterval(() => { timeRemaining--; document.getElementById('timer').textContent = timeRemaining; if (timeRemaining <= 0) endRound(); }, 1000);
            gameLoop();
        }

        function updateScoreDisplay() {
            document.getElementById('p1Score').textContent = currentPlayer === 1 ? (currentPlayer === 1 ? p1Score : p2Score) : p1Score;
            document.getElementById('p2Score').textContent = currentPlayer === 2 ? p2Score : p2Score;
            if (numPlayers === 1) document.getElementById('p1Score').textContent = p1Score;
            else {
                document.getElementById('p1Score').textContent = currentPlayer === 1 ? p1Score : p1Score;
                document.getElementById('p2Score').textContent = currentPlayer === 2 ? p2Score : p2Score;
            }
        }

        function updateComboDisplay() {
            document.getElementById('comboCount').textContent = combo;
            document.getElementById('comboBox').classList.toggle('hidden', combo < 3);
        }

        function addScore(pts) {
            if (currentPlayer === 1) p1Score = Math.max(0, p1Score + pts);
            else p2Score = Math.max(0, p2Score + pts);
            updateScoreDisplay();
        }

        function endRound() {
            gameRunning = false; clearInterval(gameTimer);
            document.getElementById('hud').classList.add('hidden');
            if (numPlayers === 2) {
                showScoreReveal(currentPlayer, currentPlayer === 1 ? p1Score : p2Score);
            } else {
                document.getElementById('finalScore').textContent = p1Score;
                document.getElementById('endScreen').classList.remove('hidden');
            }
        }

        function showScoreReveal(player, score) {
            gamePhase = 'scoreReveal';
            document.getElementById('scoreRevealTitle').textContent = `PLAYER ${player} SCORED`;
            document.getElementById('scoreRevealNumber').textContent = score;
            document.getElementById('scoreRevealScreen').classList.remove('hidden');
            spawnConfetti('confettiContainer');
            document.getElementById('scoreRevealScreen').onclick = () => {
                document.getElementById('scoreRevealScreen').classList.add('hidden');
                document.getElementById('scoreRevealScreen').onclick = null;
                if (player === 1) { currentPlayer = 2; combo = 0; showReadyScreen(); }
                else showWinner();
            };
        }

        function showWinner() {
            gamePhase = 'winner';
            document.getElementById('winnerP1Score').textContent = p1Score;
            document.getElementById('winnerP2Score').textContent = p2Score;
            let sub = p1Score > p2Score ? 'PLAYER 1 MORE POWER! üéâ' : p2Score > p1Score ? 'PLAYER 2 MORE POWER! üéâ' : "SAMA POWER! ü§ù";
            document.getElementById('winnerSubtitle').textContent = sub;
            document.getElementById('winnerScreen').classList.remove('hidden');
            spawnConfetti('winnerConfettiContainer');
        }

        function spawnConfetti(id) {
            const c = document.getElementById(id); c.innerHTML = '';
            for (let i = 0; i < 50; i++) {
                const cf = document.createElement('div');
                cf.className = 'confetti';
                cf.style.left = Math.random() * 100 + 'vw';
                cf.style.animationDelay = Math.random() * 2 + 's';
                cf.style.fontSize = (10 + Math.random() * 15) + 'px';
                cf.textContent = ['üéâ', 'üéä', '‚ú®', '‚≠ê', 'üçà'][Math.floor(Math.random() * 5)];
                c.appendChild(cf);
            }
        }

        function rematch() {
            document.getElementById('winnerScreen').classList.add('hidden');
            currentPlayer = 1; p1Score = 0; p2Score = 0; combo = 0;
            showReadyScreen();
        }

        // Spawn aliens properly based on difficulty
        var lastSpawn = 0; // Using var to allow reset from startRound
        function spawnAlien() {
            const settings = difficultySettings[difficulty];
            const activeAliens = aliens.filter(a => a.state !== 'faint' && a.state !== 'slip' && a.state !== 'runaway').length;
            if (activeAliens < settings.maxAliens && frameCount - lastSpawn > settings.spawnDelay) {
                aliens.push(new Alien());
                lastSpawn = frameCount;
            }
        }

        // Handle throw
        function handleClick(e) {
            if (!gameRunning) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
            durians.push(new Durian(width / 2, height - 60, x, y));
        }
        canvas.addEventListener('click', handleClick);
        canvas.addEventListener('touchstart', handleClick);

        // Main game loop
        function gameLoop() {
            if (!gameRunning) return;
            frameCount++;

            // Draw background
            const grad = ctx.createLinearGradient(0, 0, 0, height);
            grad.addColorStop(0, '#87CEEB'); grad.addColorStop(0.6, '#E3F2FD'); grad.addColorStop(1, '#81C784');
            ctx.fillStyle = grad; ctx.fillRect(0, 0, width, height);

            // Sun
            ctx.fillStyle = '#FFD600'; ctx.beginPath(); ctx.arc(width - 100, 80, 50, 0, Math.PI * 2); ctx.fill();

            // Clouds
            ctx.fillStyle = '#FFF';
            for (let i = 0; i < 3; i++) {
                const cx = ((frameCount * 0.3 + i * 300) % (width + 200)) - 100;
                ctx.beginPath();
                ctx.arc(cx, 60 + i * 35, 30, 0, Math.PI * 2);
                ctx.arc(cx + 30, 50 + i * 35, 25, 0, Math.PI * 2);
                ctx.arc(cx + 55, 60 + i * 35, 28, 0, Math.PI * 2);
                ctx.fill();
            }

            // Ground and houses
            ctx.fillStyle = '#4CAF50'; ctx.fillRect(0, height * 0.75, width, height * 0.25);

            // House left
            ctx.fillStyle = '#8D6E63'; ctx.fillRect(80, height * 0.62, 100, height * 0.13);
            ctx.fillStyle = '#FF7043';
            ctx.beginPath(); ctx.moveTo(70, height * 0.62); ctx.lineTo(130, height * 0.52); ctx.lineTo(190, height * 0.62); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#5D4037'; ctx.fillRect(110, height * 0.68, 30, height * 0.07);
            // Window
            ctx.fillStyle = '#81D4FA'; ctx.fillRect(130, height * 0.5, 25, 20);
            ctx.strokeStyle = '#5D4037'; ctx.lineWidth = 3; ctx.strokeRect(130, height * 0.5, 25, 20);

            // House right
            ctx.fillStyle = '#8D6E63'; ctx.fillRect(width - 180, height * 0.62, 100, height * 0.13);
            ctx.fillStyle = '#FF7043';
            ctx.beginPath(); ctx.moveTo(width - 190, height * 0.62); ctx.lineTo(width - 130, height * 0.52); ctx.lineTo(width - 70, height * 0.62); ctx.closePath(); ctx.fill();
            ctx.fillStyle = '#5D4037'; ctx.fillRect(width - 150, height * 0.68, 30, height * 0.07);
            // Window
            ctx.fillStyle = '#81D4FA'; ctx.fillRect(width - 155, height * 0.5, 25, 20);
            ctx.strokeStyle = '#5D4037'; ctx.lineWidth = 3; ctx.strokeRect(width - 155, height * 0.5, 25, 20);

            // Spawn and update aliens
            spawnAlien();
            aliens = aliens.filter(a => { if (!a.update()) return false; a.draw(); return true; });

            // Update durians and check collisions
            let missedThisFrame = false;
            durians = durians.filter(d => {
                if (!d.update()) { if (!d.hasHit) missedThisFrame = true; return false; }

                for (let a of aliens) {
                    if ((a.state === 'floating' || a.state === 'pause' || a.state === 'sniff' || a.state === 'entering') && d.checkCollision(a)) {
                        d.hasHit = true;
                        if (a.isFake) {
                            combo = 0;
                            popups.push(new Popup(a.x, a.y - 40, '-5', '#FF5252'));
                            popups.push(new Popup(a.x, a.y - 80, 'FAKE!', '#2196F3', true));
                            addScore(-5);
                            // Pop effect
                            for (let i = 0; i < 8; i++) particles.push(new Particle(a.x, a.y, '#64B5F6'));
                            a.state = 'faint'; a.stateTimer = 0;
                        } else {
                            const killed = a.hit();
                            if (killed) {
                                combo++; lastHitTime = Date.now();
                                const pts = a.hasHelmet ? 15 : 10;
                                const comboBonus = combo >= 3 ? (combo - 2) * 5 : 0;
                                addScore(pts + comboBonus);
                                popups.push(new Popup(a.x, a.y - 40, '+' + (pts + comboBonus), '#00E676'));
                                if (combo >= 3) popups.push(new Popup(a.x, a.y - 80, combo + 'x COMBO!', '#FFD600', true));
                                if (!a.hasMask) smellClouds.push(new SmellCloud(a.x, a.y));
                                for (let i = 0; i < 10; i++) particles.push(new Particle(a.x, a.y, `hsl(${a.hue}, 70%, 50%)`));
                                // Helpers cheer!
                                helpers.forEach(h => h.cheer());
                            } else {
                                addScore(5);
                                popups.push(new Popup(a.x, a.y - 40, '+5', '#00E676'));
                            }
                        }
                        updateComboDisplay();
                        break;
                    }
                }
                d.draw();
                return true;
            });

            // If missed - aliens laugh and "Aiyo!" popup
            if (missedThisFrame) {
                combo = 0; updateComboDisplay();
                popups.push(new Popup(width / 2, height / 2, 'AIYO!', '#FF9800', true));
                aliens.forEach(a => { if (Math.random() < 0.3) a.triggerLaugh(); });
            }

            // Update and draw Malaysian helpers
            helpers.forEach(h => { h.update(); h.draw(); });

            // Update effects
            smellClouds = smellClouds.filter(s => { if (!s.update()) return false; s.draw(); return true; });
            particles = particles.filter(p => { if (!p.update()) return false; p.draw(); return true; });
            popups = popups.filter(p => { if (!p.update()) return false; p.draw(); return true; });

            requestAnimationFrame(gameLoop);
        }

        // Initial draw
        resize();
        ctx.fillStyle = '#87CEEB'; ctx.fillRect(0, 0, width, height);
    </script>
</body>

</html>