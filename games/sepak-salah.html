<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sepak Salah - Aliens vs Malaysians</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        .game-text {
            text-shadow: 4px 4px 0px #000;
        }

        .hidden {
            display: none !important;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-10px);
            }

            75% {
                transform: translateX(10px);
            }
        }

        .shake {
            animation: shake 0.3s ease-in-out 3;
        }

        @keyframes pulse-scale {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .animate-pulse-scale {
            animation: pulse-scale 1s infinite;
        }
    </style>
</head>

<body class="bg-black text-white w-full h-screen relative">

    <!-- CANVAS LAYER -->
    <canvas id="gameCanvas" class="absolute top-0 left-0 w-full h-full z-0"></canvas>

    <!-- UI LAYER -->
    <div id="uiLayer"
        class="absolute top-0 left-0 w-full h-full z-10 pointer-events-none flex flex-col justify-between p-6">

        <!-- HUD -->
        <div id="hud" class="hidden flex justify-between items-start w-full">
            <button onclick="returnToMenu()"
                class="pointer-events-auto bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-10 rounded-2xl border-[8px] border-white shadow-lg text-3xl">
                üè† MENU
            </button>

            <div class="flex flex-col items-center gap-3">
                <div
                    class="bg-gray-900/90 rounded-full px-12 py-4 border-[8px] border-yellow-400 min-w-[300px] text-center">
                    <span id="timerDisplay" class="text-6xl font-bold text-white game-text">ROUND 1/10</span>
                </div>
                <div id="currentPlayerBadge" class="bg-blue-600/90 rounded-full px-10 py-2 border-[4px] border-white">
                    <span id="currentPlayerText" class="text-2xl font-bold text-white game-text">PLAYER 1</span>
                </div>
            </div>

            <div class="bg-blue-600 rounded-2xl px-10 py-4 border-[8px] border-white flex flex-col items-end">
                <span class="text-2xl font-bold uppercase text-white">SCORE</span>
                <span id="scoreDisplay" class="text-6xl font-bold game-text">0</span>
            </div>
        </div>

        <!-- CENTER MESSAGES -->
        <div id="centerMessage" class="absolute inset-0 flex items-center justify-center pointer-events-none"></div>

    </div>

    <!-- SCREENS OVERLAY -->
    <div id="menuOverlay" class="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">

        <!-- MAIN MENU -->
        <div id="mainMenu"
            class="text-center w-full max-w-3xl p-10 bg-white/10 rounded-3xl border-[10px] border-yellow-400 shadow-[0_0_50px_rgba(255,215,0,0.5)]">
            <h1 class="text-8xl font-black text-yellow-400 mb-4 game-text italic">SEPAK SALAH!</h1>
            <p class="text-3xl text-white mb-10 font-bold">"Kick the ball, not the alien!"</p>

            <!-- DIFFICULTY SELECTOR -->
            <div class="flex gap-4 mb-8 justify-center">
                <button id="btnEasy" onclick="setDifficulty('easy')"
                    class="pointer-events-auto bg-green-500 text-white text-2xl font-bold py-3 px-8 rounded-xl border-[4px] border-green-800 hover:scale-105 transition-all opacity-60">EASY</button>
                <button id="btnNormal" onclick="setDifficulty('normal')"
                    class="pointer-events-auto bg-yellow-500 text-white text-2xl font-bold py-3 px-8 rounded-xl border-[4px] border-yellow-800 hover:scale-105 transition-all border-white shadow-[0_0_20px_white]">NORMAL</button>
                <button id="btnHard" onclick="setDifficulty('hard')"
                    class="pointer-events-auto bg-red-500 text-white text-2xl font-bold py-3 px-8 rounded-xl border-[4px] border-red-800 hover:scale-105 transition-all opacity-60">HARD</button>
            </div>

            <div class="flex flex-col items-center gap-6 mb-8">
                <button onclick="startGame(1)"
                    class="pointer-events-auto bg-green-500 hover:bg-green-600 text-white text-4xl font-bold py-6 px-12 rounded-full border-b-8 border-green-800 active:border-b-0 active:translate-y-2 transition-all w-96">
                    üë§ 1 PLAYER
                </button>
                <button onclick="startGame(2)"
                    class="pointer-events-auto bg-yellow-500 hover:bg-yellow-600 text-white text-4xl font-bold py-6 px-12 rounded-full border-b-8 border-yellow-800 active:border-b-0 active:translate-y-2 transition-all w-96">
                    üë• 2 PLAYERS
                </button>
            </div>
            <button onclick="window.location.href='../index.html'"
                class="pointer-events-auto bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-10 rounded-2xl border-[8px] border-white shadow-lg text-3xl mt-8 transition-transform hover:scale-105 active:scale-95">
                üè† BACK TO HUB
            </button>
        </div>

        <!-- TURN INTRO SCREEN (Player Ready?) -->
        <div id="turnScreen" class="hidden text-center w-full max-w-3xl">
            <h2 id="turnTitle" class="text-8xl font-black text-white mb-10 game-text animate-pulse-scale">PLAYER 1
                READY?</h2>
            <button onclick="startCountdown()"
                class="pointer-events-auto bg-green-500 hover:bg-green-600 text-white text-6xl font-black py-8 px-20 rounded-full border-[8px] border-white shadow-[0_0_40px_rgba(34,197,94,0.6)] hover:scale-110 transition-transform">
                START!
            </button>
        </div>

        <!-- COUNTDOWN SCREEN -->
        <div id="countdownScreen" class="hidden flex items-center justify-center">
            <h1 id="countdownText"
                class="text-[15rem] font-black text-yellow-400 game-text drop-shadow-[0_10px_20px_rgba(0,0,0,0.5)]">3
            </h1>
        </div>

        <!-- TURN RESULT SCREEN -->
        <div id="turnResultScreen" class="hidden text-center w-full max-w-3xl">
            <h2 class="text-6xl font-black text-white mb-6 game-text">TIME'S UP!</h2>
            <div class="bg-blue-900/80 rounded-3xl p-8 border-8 border-white mb-8">
                <p id="turnPlayerName" class="text-3xl text-yellow-300 font-bold mb-2">PLAYER 1</p>
                <p class="text-2xl text-white mb-4">SCORE</p>
                <p id="turnScore" class="text-9xl font-black text-white game-text">1200</p>
            </div>
            <button id="nextTurnBtn" onclick="nextTurn()"
                class="pointer-events-auto bg-yellow-500 hover:bg-yellow-600 text-white text-4xl font-bold py-6 px-12 rounded-full border-b-8 border-yellow-800 active:border-b-0 active:translate-y-2">
                NEXT PLAYER ‚û°Ô∏è
            </button>
        </div>

        <!-- FINAL GAME OVER SCREEN -->
        <div id="gameOverScreen"
            class="hidden text-center w-full max-w-4xl bg-white/10 backdrop-blur-md p-10 rounded-3xl border-[8px] border-white">
            <h2 class="text-8xl font-black text-yellow-400 mb-8 game-text">GAME OVER!</h2>

            <div id="finalScoresContainer" class="flex justify-center gap-10 mb-10">
                <!-- Scores injected here -->
            </div>

            <h3 id="winnerText" class="text-6xl font-black text-green-400 mb-10 game-text animate-pulse">PLAYER 1 WINS!
            </h3>

            <div class="flex justify-center gap-6">
                <button onclick="location.reload()"
                    class="pointer-events-auto bg-green-500 hover:bg-green-600 text-white text-4xl font-bold py-6 px-12 rounded-full border-b-8 border-green-800 active:border-b-0 active:translate-y-2">
                    REMATCH üîÑ
                </button>
                <button onclick="window.location.href='../'"
                    class="pointer-events-auto bg-gray-600 hover:bg-gray-700 text-white text-4xl font-bold py-6 px-12 rounded-full border-b-8 border-gray-900 active:border-b-0 active:translate-y-2">
                    EXIT üö™
                </button>
            </div>
        </div>

    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // === GAME CONFIGURATION ===
        const GAMEConfig = {
            MAX_ROUNDS: 10, // Kicks per player

            // Ball Physics
            BALL_GRAVITY: 0.5,
            BALL_BOUNCE_DAMPING: 0.65,
            BALL_MIN_BOUNCE_VY: 2,
            BALL_SIZE_MIN: 100,
            BALL_SIZE_MAX: 350,

            // Goal Detection
            GOAL_LEFT_BOUND: 1700,
            GOAL_RIGHT_BOUND: 1700,
            GOAL_DEPTH_NEAR: 1200,
            GOAL_DEPTH_FAR: 3000,

            // Difficulty Presets
            DIFFICULTY: {
                easy: { alienSpeed: 20, reactionTime: 45, catchRadius: 240, predictionAccuracy: 0.55, catchProbability: 1 },  // ‚öôÔ∏è TWEAK: 15% catch chance
                normal: { alienSpeed: 25, reactionTime: 45, catchRadius: 140, predictionAccuracy: 0.75, catchProbability: 1 },  // ‚öôÔ∏è TWEAK: 40% catch chance
                hard: { alienSpeed: 50, reactionTime: 45, catchRadius: 40, predictionAccuracy: 0.9, catchProbability: 1 }  // ‚öôÔ∏è TWEAK: 70% catch chance
            }
        };

        // ASSETS
        const ASSETS = {
            stadium: new Image(),
            goal: new Image(),
            alien: new Image(),
            ball: new Image()
        };
        ASSETS.stadium.src = '../assets/goal_stadium_bg.jpg';
        ASSETS.goal.src = '../assets/goal_v3.png';

        // üé≤ RANDOM ALIEN SELECTION
        const ALIEN_SPRITES = [
            '../assets/alien_blue_ant.png',
            '../assets/alien_red_round.png',
            '../assets/alien_orange_tall.png',
        ];
        ASSETS.alien.src = ALIEN_SPRITES[Math.floor(Math.random() * ALIEN_SPRITES.length)];

        ASSETS.ball.src = '../assets/Ball.png';

        // PHRASES
        const ALIEN_BOUNCE_PHRASES = ["WAH BOUNCE BALIK!", "BALIK SANA!", "TAK BOLEH MASUK!", "LEMAH LA!", "CUBA LAGI!"];
        const ALIEN_MISS_PHRASES = ["HAHAHA NOOB!", "TEMBAK PON TAK KENA!", "MANA BOLA?", "LARI KE MANA?", "KOSONG!"];
        const ALIEN_GOAL_PHRASES = ["AIYOOO CAMNE?!", "TAK NAMPAK KE?!", "TIDO KE AKU?!", "ADUH MALU!", "GG WP!"];

        function getRandomPhrase(list) {
            return list[Math.floor(Math.random() * list.length)];
        }

        // === SOUND SYSTEM (Web Audio API) ===
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        const SOUNDS = {
            kick: () => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(200, audioContext.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.1);
            },
            bounce: () => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(100, audioContext.currentTime);
                osc.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.05);
                gain.gain.setValueAtTime(0.2, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.05);
            },
            block: () => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, audioContext.currentTime);
                gain.gain.setValueAtTime(0.3, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.15);
            },
            goal: () => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(400, audioContext.currentTime);
                osc.frequency.setValueAtTime(500, audioContext.currentTime + 0.1);
                osc.frequency.setValueAtTime(600, audioContext.currentTime + 0.2);
                gain.gain.setValueAtTime(0.25, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.4);
            },
            miss: () => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(200, audioContext.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.3);
                gain.gain.setValueAtTime(0.15, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.3);
            },
            countdown: () => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(600, audioContext.currentTime);
                gain.gain.setValueAtTime(0.2, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.1);
            },
            go: () => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.setValueAtTime(800, audioContext.currentTime);
                gain.gain.setValueAtTime(0.25, audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                osc.start(audioContext.currentTime);
                osc.stop(audioContext.currentTime + 0.15);
            }
        };

        // === BACKGROUND MUSIC ===
        const BGM = new Audio();
        BGM.loop = true;
        BGM.volume = 0.1; // 40% volume

        // üéµ CHANGE SONG HERE: Replace with your own mp3 file
        // Example: BGM.src = '../assets/music/my_song.mp3';
        BGM.src = '../assets/Upbeat.wav';

        function initAudio() {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            if (BGM.src && BGM.paused) {
                BGM.play().catch(e => console.log("Audio play failed:", e));
            }
        }

        // --- GAME STATE ---
        let width, height;
        let gameState = 'MENU'; // MENU, TURN_INTRO, COUNTDOWN, PLAYING, TURN_RESULT, GAME_OVER
        let playerCount = 1;
        let currentPlayer = 1;
        let scores = [0, 0]; // P1, P2
        let currentRound = 1;
        let particles = [];
        let popups = [];
        let currentDifficulty = 'normal';
        let difficultySettings = GAMEConfig.DIFFICULTY.normal;

        // Physics Objects
        let ball = { x: 0, y: 150, z: -350, vx: 0, vy: 0, vz: 0, state: 'idle', rotation: 0 };
        let alien = { x: 0, targetX: ball.x, reactionDelay: 0, movingToTarget: false };
        const perspective = 800;

        // Asset Loading
        let resourcesLoaded = 0;
        function checkLoad() {
            resourcesLoaded++;
            if (resourcesLoaded === 4) {
                resize();
                render();
            }
        }
        ASSETS.stadium.onload = checkLoad;
        ASSETS.goal.onload = checkLoad;
        ASSETS.alien.onload = checkLoad;
        ASSETS.ball.onload = checkLoad;

        // --- GAME LOGIC ---

        function setDifficulty(mode) {
            currentDifficulty = mode;
            difficultySettings = GAMEConfig.DIFFICULTY[mode];

            ['easy', 'normal', 'hard'].forEach(m => {
                const btn = document.getElementById(`btn${m.charAt(0).toUpperCase() + m.slice(1)}`);
                if (m === mode) {
                    btn.className = btn.className.replace('opacity-60', 'border-white shadow-[0_0_20px_white]');
                } else {
                    btn.className = btn.className.replace('border-white shadow-[0_0_20px_white]', '').replace('opacity-60', '') + ' opacity-60';
                }
            });
        }

        function startGame(numPlayers) {
            playerCount = numPlayers;
            scores = [0, 0];
            currentPlayer = 1;

            document.getElementById('mainMenu').classList.add('hidden');
            initAudio(); // üîä Start Audio System
            startTurnIntro();
        }

        function startTurnIntro() {
            gameState = 'TURN_INTRO';
            document.getElementById('menuOverlay').classList.remove('hidden');
            document.getElementById('turnScreen').classList.remove('hidden');
            document.getElementById('turnResultScreen').classList.add('hidden');

            const title = document.getElementById('turnTitle');
            title.textContent = playerCount === 1 ? "READY?" : `PLAYER ${currentPlayer} READY?`;
            title.className = `text-8xl font-black mb-10 game-text animate-pulse-scale ${currentPlayer === 1 ? 'text-blue-400' : 'text-red-400'}`;

            // Hide HUD during intro
            document.getElementById('hud').classList.add('hidden');
        }

        function startCountdown() {
            gameState = 'COUNTDOWN';
            document.getElementById('turnScreen').classList.add('hidden');
            document.getElementById('countdownScreen').classList.remove('hidden');

            let count = 3;
            const countText = document.getElementById('countdownText');
            countText.textContent = count;
            // Play sound?

            const timer = setInterval(() => {
                count--;
                if (count > 0) {
                    countText.textContent = count;
                    SOUNDS.countdown();  // üîä Countdown beep
                } else if (count === 0) {
                    countText.textContent = "GO!";
                    SOUNDS.go();  // üîä GO sound
                } else {
                    clearInterval(timer);
                    document.getElementById('countdownScreen').classList.add('hidden');
                    document.getElementById('menuOverlay').classList.add('hidden');
                    beginGameplay();
                }
            }, 1000);
        }

        function beginGameplay() {
            gameState = 'PLAYING';
            currentRound = 1;

            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('currentPlayerText').textContent = playerCount === 1 ? "SOLO" : `PLAYER ${currentPlayer}`;
            document.getElementById('currentPlayerBadge').className = `rounded-full px-10 py-2 border-[4px] border-white ${currentPlayer === 1 ? 'bg-blue-600/90' : 'bg-red-600/90'}`;

            resetBall(true);
            updateHUD();

            spawnPopup("START!", "#FFF");
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function updateHUD() {
            document.getElementById('timerDisplay').textContent = `ROUND ${currentRound}/${GAMEConfig.MAX_ROUNDS}`;
            document.getElementById('timerDisplay').classList.remove('text-red-500');
            document.getElementById('scoreDisplay').textContent = scores[currentPlayer - 1];
        }

        function handleTurnEnd() {
            gameState = 'TURN_RESULT';
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('menuOverlay').classList.remove('hidden');
            document.getElementById('turnResultScreen').classList.remove('hidden');

            document.getElementById('turnPlayerName').textContent = playerCount === 1 ? "YOU SCORED" : `PLAYER ${currentPlayer}`;
            document.getElementById('turnScore').textContent = scores[currentPlayer - 1];

            const nextBtn = document.getElementById('nextTurnBtn');
            if (currentPlayer < playerCount) {
                nextBtn.textContent = "NEXT PLAYER ‚û°Ô∏è";
                nextBtn.onclick = () => {
                    currentPlayer++;
                    startTurnIntro();
                };
            } else {
                nextBtn.textContent = "FINISH üèÅ";
                nextBtn.onclick = endGame;
            }
        }

        function endGame() {
            gameState = 'GAME_OVER';
            document.getElementById('turnResultScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.remove('hidden');

            const container = document.getElementById('finalScoresContainer');
            container.innerHTML = '';

            // Render Scores
            for (let i = 1; i <= playerCount; i++) {
                const div = document.createElement('div');
                div.className = "flex flex-col items-center";
                div.innerHTML = `
                    <div class="text-3xl font-bold mb-4 ${i === 1 ? 'text-blue-400' : 'text-red-400'}">PLAYER ${i}</div>
                    <div class="text-6xl font-black text-white game-text bg-white/20 rounded-xl px-8 py-4">${scores[i - 1]}</div>
                `;
                container.appendChild(div);
            }

            // Determine Winner
            const winnerText = document.getElementById('winnerText');
            if (playerCount === 1) {
                winnerText.textContent = "GAME COMPLETED!";
                winnerText.className = "text-6xl font-black text-white mb-10 game-text";
            } else {
                if (scores[0] > scores[1]) {
                    winnerText.textContent = "PLAYER 1 WINS! üèÜ";
                    winnerText.className = "text-6xl font-black text-blue-400 mb-10 game-text animate-pulse";
                } else if (scores[1] > scores[0]) {
                    winnerText.textContent = "PLAYER 2 WINS! üèÜ";
                    winnerText.className = "text-6xl font-black text-red-500 mb-10 game-text animate-pulse";
                } else {
                    winnerText.textContent = "IT'S A DRAW! ü§ù";
                    winnerText.className = "text-6xl font-black text-yellow-400 mb-10 game-text";
                }
            }
        }

        function returnToMenu() {
            gameState = 'MENU';
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('menuOverlay').classList.remove('hidden');
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('turnScreen').classList.add('hidden');
            document.getElementById('countdownScreen').classList.add('hidden');
            document.getElementById('turnResultScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
        }

        // --- GAME LOOP & PHYSICS ---

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        function project(x, y, z) {
            const scale = perspective / (perspective + z);
            return {
                x: width / 2 + x * scale,
                y: height / 2 + y * scale,
                scale: scale
            };
        }

        function resetBall(isInitial = false) {
            if (!isInitial) {
                if (currentRound >= GAMEConfig.MAX_ROUNDS) {
                    handleTurnEnd();
                    return;
                }
                currentRound++;
                updateHUD();
            }
            ball = { x: 0, y: 150, z: -350, vx: 0, vy: 0, vz: 0, state: 'idle', rotation: 0 };
            alien.x = ball.x;
            alien.targetX = 0;
            alien.reactionDelay = difficultySettings.reactionTime; // Reset reaction
            alien.movingToTarget = true;
        }

        function handleInput(clientX, clientY) {
            if (gameState !== 'PLAYING' || ball.state !== 'idle') return;

            const normalizedX = (clientX / width - 0.5) * 4;
            const normalizedY = (clientY / height - 0.5) * 8;

            ball.vx = normalizedX * 18;
            const minArc = -4, maxArc = -15;
            ball.vy = minArc + (maxArc - minArc) * ((1 - normalizedY) / 2);
            const minSpeed = 22, maxSpeed = 35;
            ball.vz = minSpeed + (maxSpeed - minSpeed) * ((normalizedY + 1) / 2);

            ball.state = 'moving';
            SOUNDS.kick();  // üîä Kick sound

            alien.reactionDelay = difficultySettings.reactionTime;
            alien.movingToTarget = false; // ‚ö° FIX: False so it recalculates target after delay
        }

        canvas.addEventListener('mousedown', e => handleInput(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', e => { e.preventDefault(); handleInput(e.touches[0].clientX, e.touches[0].clientY); });

        // Particles & Popups
        class Particle {
            constructor(x, y, color, speedScale = 100) {
                this.x = x; this.y = y; this.color = color;
                this.vx = (Math.random() - 0.5) * 10 * speedScale;
                this.vy = (Math.random() - 1) * 10 * speedScale;
                this.life = 1.0; this.size = Math.random() * 5 + 2; this.gravity = 0.5;
            }
            update() { this.x += this.vx; this.y += this.vy; this.vy += this.gravity; this.life -= 0.03; }
            draw(ctx) {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1;
            }
        }
        function spawnParticles(x, y, count, color, speed) { for (let i = 0; i < count; i++) particles.push(new Particle(x, y, color, speed)); }
        function spawnPopup(text, color, duration = 2000) {
            const popup = { text, color, life: 1.0, y: height / 2, scale: 0 };
            popups.push(popup);
            setTimeout(() => { const idx = popups.indexOf(popup); if (idx > -1) popups.splice(idx, 1); }, duration);
        }

        let lastTime = 0;
        function gameLoop(timestamp) {
            if (gameState !== 'PLAYING') return; // Stop loop if not playing

            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            // --- UPDATE ---
            // Alien AI
            if (ball.state === 'moving') {
                if (alien.reactionDelay > 0) {
                    alien.reactionDelay--;
                } else if (!alien.movingToTarget) {
                    const accuracy = difficultySettings.predictionAccuracy;
                    const predictedX = ball.x + ball.vx * (ball.z / ball.vz) * accuracy;
                    const error = (Math.random() - 0.5) * (100 * (1 - accuracy));
                    alien.movingToTarget = true;
                }
                if (alien.movingToTarget) {
                    const dx = alien.targetX - alien.x;
                    alien.x += Math.sign(dx) * Math.min(Math.abs(dx), difficultySettings.alienSpeed);
                }
            } else {
                if (Math.abs(alien.x - alien.targetX) < 1) alien.targetX = (Math.random() - 0.5) * 1000; // ‚ö° FIX: INCREASED wander range from 10 to 1000
                alien.x += (alien.targetX - alien.x) * 0.4;  // ‚ö° FIX: INCREASED speed from 0 to 0.1
            }

            // Ball Physics
            if (ball.state === 'moving') {
                ball.x += ball.vx; ball.y += ball.vy; ball.z += ball.vz;
                ball.vy += GAMEConfig.BALL_GRAVITY; ball.rotation += 0.2;

                // Bounce
                if (ball.y > 200) {
                    ball.y = 200;
                    if (Math.abs(ball.vy) > GAMEConfig.BALL_MIN_BOUNCE_VY) {
                        ball.vy *= -GAMEConfig.BALL_BOUNCE_DAMPING; ball.vx *= 0.9;
                        const pb = project(ball.x, ball.y, ball.z);
                        spawnParticles(pb.x, pb.y + 30, 10, '#888', 1);
                        SOUNDS.bounce();  // üîä Bounce sound
                    } else ball.vy = 0;
                }

                // Goal Check
                if (ball.z >= GAMEConfig.GOAL_DEPTH_NEAR && ball.z <= GAMEConfig.GOAL_DEPTH_FAR) {
                    const inGoalX = Math.abs(ball.x) < GAMEConfig.GOAL_LEFT_BOUND;
                    const inGoalY = ball.y > -100 && ball.y < 300;

                    if (inGoalX && inGoalY) {
                        if (Math.abs(ball.x - alien.x) < difficultySettings.catchRadius) {
                            // üé≤ PROBABILITY CHECK: Roll dice to see if alien catches (TWEAK catchProbability in config)
                            const catchRoll = Math.random();
                            if (catchRoll < difficultySettings.catchProbability) {
                                // ‚úÖ ALIEN CAUGHT THE BALL - Apply bounce reaction
                                ball.vx *= -0.8; ball.vz *= -0.5; ball.vy = -8;  // üèÄ BOUNCE: Ball bounces away from alien
                                ball.state = 'bounced';
                                SOUNDS.block();  // üîä Block sound
                                spawnPopup(getRandomPhrase(ALIEN_BOUNCE_PHRASES), "#EF4444");
                                const pb = project(ball.x, ball.y, ball.z);
                                spawnParticles(pb.x, pb.y, 30, '#FF4444', 3);
                                setTimeout(resetBall, 2000);
                            }
                            // ‚ùå If catchRoll >= catchProbability, alien MISSES - ball continues to goal check below
                        } else {
                            // GOAL
                            scores[currentPlayer - 1] += 100;
                            ball.state = 'scored';
                            ball.state = 'scored';
                            SOUNDS.goal();  // üîä Goal sound
                            spawnPopup("GOAL!", "#22C55E");
                            setTimeout(() => spawnPopup(getRandomPhrase(ALIEN_GOAL_PHRASES), "#FBBF24", 1500), 500);
                            const pb = project(ball.x, ball.y, ball.z);
                            spawnParticles(pb.x, pb.y, 40, '#22C55E', 4);
                            updateHUD();
                            setTimeout(resetBall, 1000); // Faster reset for timed mode
                        }
                    }
                }

                // Miss
                if (ball.z > GAMEConfig.GOAL_DEPTH_FAR + 100) {
                    ball.state = 'missed';
                    SOUNDS.miss();  // üîä Miss sound
                    spawnPopup("MISSED!", "#EF4444");
                    setTimeout(() => spawnPopup(getRandomPhrase(ALIEN_MISS_PHRASES), "#FBBF24", 1500), 500);
                    setTimeout(resetBall, 1500);
                }
            }

            particles.forEach(p => p.update());
            particles = particles.filter(p => p.life > 0);
            popups.forEach(p => { p.life -= 0.015; p.y -= 0.5; if (p.scale < 1) p.scale += 0.1; });

            render();
            requestAnimationFrame(gameLoop);
        }

        // --- RENDER ---
        function render() {
            ctx.clearRect(0, 0, width, height);

            // Draw Stadium
            if (ASSETS.stadium.complete) ctx.drawImage(ASSETS.stadium, 0, 0, width, height);
            else { ctx.fillStyle = '#111'; ctx.fillRect(0, 0, width, height); }

            // Field
            const horizonY = height * 0.6;
            const grad = ctx.createLinearGradient(0, horizonY, 0, height);
            grad.addColorStop(0, 'rgba(15,46,15,0)'); grad.addColorStop(0.5, 'rgba(26,74,26,0.3)'); grad.addColorStop(1, 'rgba(46,125,50,0.5)');
            ctx.fillStyle = grad; ctx.beginPath(); ctx.moveTo(0, horizonY); ctx.lineTo(width, horizonY); ctx.lineTo(width, height); ctx.lineTo(0, height); ctx.fill();

            // Alien
            const goalZ = 400;
            const pAlien = project(alien.x, 350, goalZ);
            if (ASSETS.alien.complete) {
                const aw = 700 * pAlien.scale; const ah = 700 * pAlien.scale;
                ctx.fillStyle = 'rgba(0,0,0,0.0)'; ctx.beginPath(); ctx.ellipse(pAlien.x, pAlien.y, aw / 2, aw / 5, 0, 0, Math.PI * 2); ctx.fill();
                ctx.drawImage(ASSETS.alien, pAlien.x - aw / 2, pAlien.y - ah, aw, ah);
            }

            // Ball
            const pBall = project(ball.x, ball.y, ball.z);
            const depthFactor = Math.max(0, Math.min(1, (ball.z + 400) / 800));
            const ballSize = GAMEConfig.BALL_SIZE_MIN + (GAMEConfig.BALL_SIZE_MAX - GAMEConfig.BALL_SIZE_MIN) * (1 - depthFactor);

            ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.beginPath();
            const pShadow = project(ball.x, 200, ball.z);
            ctx.ellipse(pShadow.x, pShadow.y, ballSize * 0.7, ballSize * 0.35, 0, 0, Math.PI * 2); ctx.fill();

            ctx.save(); ctx.translate(pBall.x, pBall.y); ctx.rotate(ball.rotation);
            if (ASSETS.ball.complete && ASSETS.ball.naturalWidth !== 0) ctx.drawImage(ASSETS.ball, -ballSize, -ballSize, ballSize * 2, ballSize * 2);
            else { ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(0, 0, ballSize, 0, Math.PI * 2); ctx.fill(); }
            ctx.restore();

            // Effects
            particles.forEach(p => p.draw(ctx));
            popups.forEach((p, i) => {
                ctx.save(); ctx.globalAlpha = Math.max(0, p.life); ctx.translate(width / 2, p.y - i * 80); ctx.scale(p.scale, p.scale);
                ctx.fillStyle = p.color; ctx.font = "900 80px Fredoka"; ctx.textAlign = "center"; ctx.shadowColor = "black"; ctx.shadowOffsetX = 5; ctx.shadowOffsetY = 5;
                ctx.fillText(p.text, 0, 0); ctx.font = "900 80px Fredoka"; ctx.strokeStyle = "white"; ctx.lineWidth = 3; ctx.strokeText(p.text, 0, 0);
                ctx.restore();
            });
        }

        // Initial set
        setDifficulty('normal');
    </script>
</body>

</html>