<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Salah Tembak! - Aliens vs Malaysians</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'fredoka': ['Fredoka', 'sans-serif'] },
                    colors: { 'sambal': '#FF5252', 'durian': '#FFD600', 'pandan': '#00E676' }
                }
            }
        }
    </script>
    <style>
        .target-hit {
            animation: targetHit 0.4s ease-out forwards;
        }

        @keyframes targetHit {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.3) rotate(15deg);
            }

            100% {
                transform: scale(0) rotate(-30deg);
                opacity: 0;
            }
        }

        .balloon-pop {
            animation: balloonPop 0.3s ease-out forwards;
        }

        @keyframes balloonPop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.5);
            }

            100% {
                transform: scale(0);
                opacity: 0;
            }
        }

        .wrong-reaction {
            animation: wrongReaction 0.6s ease-out forwards;
        }

        @keyframes wrongReaction {
            0% {
                transform: scale(1) rotate(0deg);
            }

            25% {
                transform: scale(1.1) rotate(-10deg);
            }

            50% {
                transform: scale(1.1) rotate(10deg);
            }

            75% {
                transform: scale(1.05) rotate(-5deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
            }
        }

        .disguise-fall {
            animation: disguiseFall 0.8s ease-out forwards;
        }

        @keyframes disguiseFall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100px) rotate(45deg);
                opacity: 0;
            }
        }

        .crosshair {
            pointer-events: none;
        }

        .winner-bounce {
            animation: winnerBounce 0.5s ease-out forwards, winnerGlow 1s ease-in-out infinite 0.5s;
        }

        @keyframes winnerBounce {
            0% {
                transform: scale(0) rotate(-10deg);
            }

            50% {
                transform: scale(1.3) rotate(5deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
            }
        }

        @keyframes winnerGlow {

            0%,
            100% {
                filter: drop-shadow(0 0 20px gold);
            }

            50% {
                filter: drop-shadow(0 0 40px gold) drop-shadow(0 0 60px orange);
            }
        }

        .confetti {
            position: fixed;
            pointer-events: none;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .pulse-text {
            animation: pulseText 1s ease-in-out infinite;
        }

        @keyframes pulseText {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.9;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }
        }

        .muzzle-flash {
            animation: muzzleFlash 0.1s ease-out forwards;
        }

        @keyframes muzzleFlash {
            0% {
                transform: scale(0);
                opacity: 1;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }
    </style>
</head>

<body
    class="font-fredoka bg-gradient-to-b from-red-600 via-red-500 to-orange-400 min-h-screen overflow-hidden touch-none select-none cursor-none">

    <!-- Game Canvas -->
    <canvas id="gameCanvas" class="block w-full h-screen"></canvas>

    <!-- HUD -->
    <div id="hud" class="hidden fixed inset-0 pointer-events-none z-50">
        <div class="absolute top-4 left-1/2 -translate-x-1/2 flex gap-4 flex-wrap justify-center">
            <div
                class="bg-white/90 px-10 py-5 rounded-full border-[10px] border-black shadow-[6px_6px_0_#000] font-bold text-3xl">
                ‚è±Ô∏è <span id="timer" class="text-sambal">35</span>s
            </div>
            <div id="p1ScoreBox"
                class="bg-sambal/90 px-10 py-5 rounded-full border-[10px] border-black shadow-[6px_6px_0_#000] font-bold text-3xl text-white">
                P1: <span id="p1Score">0</span>
            </div>
            <div id="p2ScoreBox"
                class="hidden bg-orange-500/90 px-10 py-5 rounded-full border-[10px] border-black shadow-[6px_6px_0_#000] font-bold text-3l text-white">
                P2: <span id="p2Score">0</span>
            </div>
        </div>
        <div class="absolute top-32 left-1/2 -translate-x-1/2 flex gap-4">
            <div id="difficultyBadge"
                class="bg-pandan px-8 py-3 rounded-full border-[10px] border-black font-bold text-3xl">
                EASY</div>
            <div id="accuracyBadge"
                class="bg-durian px-8 py-3 rounded-full border-[10px] border-black font-bold text-3xl">üéØ
                100%</div>
        </div>

        <!-- MENU BUTTON -->
        <div class="fixed bottom-4 left-4 z-[100] pointer-events-auto">
            <button onclick="handleBackButton()"
                class="bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-10 rounded-2xl border-[8px] border-white shadow-lg text-3xl transition-transform hover:scale-105 active:scale-95">
                üè† MENU
            </button>
        </div>
    </div>

    <!-- Countdown Overlay -->
    <div id="countdown"
        class="hidden fixed inset-0 flex items-center justify-center z-[80] bg-black/70 pointer-events-none">
        <div id="countdownText" class="text-9xl font-bold text-white drop-shadow-[0_8px_0_#000]">3</div>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu"
        class="fixed inset-0 bg-gradient-to-b from-red-800 to-orange-900 flex flex-col items-center justify-center z-[100] text-center px-4">
        <div class="text-6xl mb-4 animate-bounce">üéØ</div>
        <h1 class="text-6xl md:text-8xl font-black text-sambal drop-shadow-[0_10px_0_#000] mb-6 tracking-tight">
            SALAH TEMBAK!
        </h1>
        <p class="text-white text-2xl font-bold mb-3 max-w-4xl leading-relaxed">"Not everything green is
            alien.<br>Sometimes it's cactus. Sometimes
            it's balloon."</p>
        <p class="text-red-300 text-3xl font-black mb-8 animate-pulse">Shoot the REAL aliens!</p>

        <!-- Difficulty Selection -->
        <div class="flex gap-4 mb-8">
            <button onclick="setDifficulty('easy')" id="btnEasy"
                class="bg-pandan text-black font-bold text-3xl px-12 py-5 rounded-2xl border-4 border-black shadow-[4px_4px_0_#000] transition-all">EASY</button>
            <button onclick="setDifficulty('normal')" id="btnNormal"
                class="bg-durian text-black font-bold text-3xl px-12 py-5 rounded-2xl border-4 border-black shadow-[4px_4px_0_#000] transition-all opacity-60">NORMAL</button>
            <button onclick="setDifficulty('hard')" id="btnHard"
                class="bg-sambal text-white font-bold text-3xl px-12 py-5 rounded-2xl border-4 border-black shadow-[4px_4px_0_#000] transition-all opacity-60">HARD</button>
        </div>

        <button onclick="startGame(1)"
            class="bg-pandan text-black font-bold text-3xl px-12 py-6 rounded-full border-[6px] border-black shadow-[0_10px_0_#2E7D32] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#2E7D32] transition-all mb-6 w-80 font-black tracking-wider">
            üë§ 1 PLAYER
        </button>

        <button onclick="startGame(2)"
            class="bg-durian text-black font-bold text-3xl px-12 py-6 rounded-full border-[6px] border-black shadow-[0_10px_0_#B8860B] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#B8860B] transition-all w-80 font-black tracking-wider mb-6">
            üë• 2 PLAYERS
        </button>

        <button onclick="window.location.href='../index.html'"
            class="pointer-events-auto bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-10 rounded-2xl border-[8px] border-white shadow-lg text-3xl mt-8 transition-transform hover:scale-105 active:scale-95">
            üè† BACK TO HUB
        </button>
    </div>

    <!-- Player Ready Screen -->
    <div id="playerReadyScreen"
        class="hidden fixed inset-0 bg-gradient-to-b from-red-800 to-orange-900 flex flex-col items-center justify-center z-[90] text-center px-4">
        <div id="playerReadyIcon" class="text-9xl mb-4 pulse-text">üéØ</div>
        <h1 id="playerReadyText"
            class="text-5xl md:text-7xl font-bold text-sambal drop-shadow-[0_6px_0_#000] mb-4 pulse-text">
            PLAYER 1 READY?
        </h1>
        <p class="text-white text-2xl">Get ready to blast some aliens!</p>
    </div>

    <!-- Score Reveal Screen -->
    <div id="scoreRevealScreen"
        class="hidden fixed inset-0 bg-black/95 flex flex-col items-center justify-center z-[95] text-center px-4">
        <div id="confettiContainer"></div>
        <h2 id="scoreRevealTitle" class="text-4xl md:text-5xl font-bold text-sambal drop-shadow-[0_4px_0_#000] mb-4">
            PLAYER 1 SCORED
        </h2>
        <div id="scoreRevealNumber" class="text-8xl md:text-9xl font-bold text-durian drop-shadow-[0_8px_0_#000] mb-4">
            0
        </div>
        <div id="accuracyResult" class="text-2xl font-bold text-pandan mb-8">üéØ Accuracy: 100%</div>
        <p class="text-white text-xl animate-pulse">Tap to continue...</p>
    </div>

    <!-- Winner Screen -->
    <div id="winnerScreen"
        class="hidden fixed inset-0 bg-gradient-to-b from-red-800 via-black to-orange-900 flex flex-col items-center justify-center z-[100] text-center px-4">
        <div id="winnerConfettiContainer"></div>
        <div class="text-9xl mb-4 winner-bounce">üèÜ</div>
        <h1 id="winnerTitle"
            class="text-4xl md:text-6xl font-bold text-sambal drop-shadow-[0_6px_0_#000] mb-2 winner-bounce">
            WHO MORE POWER?
        </h1>
        <h2 id="winnerSubtitle" class="text-3xl md:text-5xl font-bold text-durian drop-shadow-[0_4px_0_#000] mb-8"></h2>
        <div class="flex gap-8 justify-center mb-8">
            <div class="text-center">
                <div class="text-sambal font-bold text-2xl">Player 1</div>
                <div id="winnerP1Score" class="text-5xl font-bold text-white drop-shadow-[0_4px_0_#000]">0</div>
            </div>
            <div class="text-6xl font-bold text-white">VS</div>
            <div class="text-center">
                <div class="text-orange-400 font-bold text-2xl">Player 2</div>
                <div id="winnerP2Score" class="text-5xl font-bold text-white drop-shadow-[0_4px_0_#000]">0</div>
            </div>
        </div>
        <div class="flex flex-col gap-4">
            <button onclick="rematch()"
                class="bg-pandan text-black font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#2E7D32] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#2E7D32] transition-all">
                üî• FIGHT AGAIN!
            </button>
            <button onclick="returnToMainMenu()"
                class="bg-gray-600 text-white font-bold text-xl px-8 py-3 rounded-full border-4 border-black shadow-[0_6px_0_#374151] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_3px_0_#374151] transition-all">
                üè† MAIN MENU
            </button>
        </div>
    </div>

    <!-- End Screen (Single Player) -->
    <div id="endScreen"
        class="hidden fixed inset-0 bg-black/90 flex flex-col items-center justify-center z-[100] text-center px-4">
        <div class="text-8xl mb-4">üéØ</div>
        <h1 class="text-5xl md:text-6xl font-bold text-sambal drop-shadow-[0_4px_0_#000] mb-4">
            TIME'S UP!
        </h1>
        <p class="text-white text-xl mb-2">Final Score:</p>
        <div id="finalScore" class="text-6xl font-bold text-durian drop-shadow-[0_4px_0_#000] mb-4">0</div>
        <div id="finalAccuracy" class="text-2xl font-bold text-pandan mb-8">üéØ Accuracy: 100%</div>
        <button onclick="location.reload()"
            class="bg-pandan text-black font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#2E7D32] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#2E7D32] transition-all">
            PLAY AGAIN
        </button>
        <button onclick="handleBackButton()"
            class="mt-4 bg-gray-600 text-white font-bold px-6 py-2 rounded-full border-2 border-black">
            BACK TO HUB
        </button>
    </div>

    <!-- QUIT CONFIRMATION MODAL -->
    <div id="quitModal"
        class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[200] backdrop-blur-sm">
        <div
            class="bg-white p-8 rounded-3xl border-[8px] border-black shadow-[10px_10px_0_#000] text-center max-w-lg animated-modal">
            <h2 class="text-5xl font-black text-sambal mb-6">QUIT GAME?</h2>
            <p class="text-2xl font-bold text-gray-700 mb-8">Balik kampung so soon?</p>
            <div class="flex gap-6 justify-center">
                <button onclick="confirmQuit()"
                    class="bg-red-500 hover:bg-red-600 text-white text-3xl font-bold py-4 px-10 rounded-2xl border-[4px] border-black shadow-[4px_4px_0_#000] hover:translate-y-1 hover:shadow-[2px_2px_0_#000] transition-all">
                    YES
                </button>
                <button onclick="cancelQuit()"
                    class="bg-gray-300 hover:bg-gray-200 text-black text-3xl font-bold py-4 px-10 rounded-2xl border-[4px] border-black shadow-[4px_4px_0_#000] hover:translate-y-1 hover:shadow-[2px_2px_0_#000] transition-all">
                    NO
                </button>
            </div>
        </div>
    </div>


    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        const TARGET_BASE_SIZE = 400; // Global scale reference

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // Game State
        let gameRunning = false;
        let numPlayers = 1;
        let currentPlayer = 1;
        let p1Score = 0;
        let p2Score = 0;
        let timeRemaining = 35;
        let gameTimer = null;
        let difficulty = 'easy';
        let gamePhase = 'menu';

        // Accuracy tracking
        let totalShots = 0;
        let correctShots = 0;

        // Game Objects
        let targets = [];
        let muzzleFlashes = [];
        let particles = [];
        let popups = [];
        let frameCount = 0;
        let mouseX = 0;
        let mouseY = 0;

        // === AUDIO SYSTEM ===
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const BGM = new Audio('../assets/Shooting2.mp3');
        BGM.loop = true;
        BGM.volume = 0.1;

        const SFX = {
            shot: () => { // Pew-Pew (Laser shot)
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'sawtooth';
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.setValueAtTime(800, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.2);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + 0.2);
            },
            error: () => { // Buzzer/Ouch (Human hit)
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = 'square';
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + 0.3);
            }
        };

        function initAudio() {
            if (BGM.paused) BGM.play().catch(e => console.log(e));
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        // Asset paths
        const ASSETS = {
            // Aliens (randomized)
            alienBlueAnt: '../assets/alien_blue_ant.png',
            alienOrangeTall: '../assets/alien_orange_tall.png',
            alienRedRound: '../assets/alien_red_round.png',
            alienGreenEyes: '../assets/green alien with big eyes.png',

            // Malaysians (randomized)
            pakcikSongkok: '../assets/pakcik with songkok.png',
            uncleBatik: '../assets/malaysian uncle in batik shirt.png',
            malaysianFemale: '../assets/malaysian_female_v2.png',

            // Effects
            redFlash: '../assets/Red_flash.png',

            durian: '../assets/durian.png',
            heroBanner: '../assets/hero-banner-final.jpg'
        };

        // Preload images
        const images = {};
        let imagesLoaded = 0;

        function processTransparency(img) {
            const c = document.createElement('canvas');
            c.width = img.width;
            c.height = img.height;
            const ctx = c.getContext('2d');
            ctx.drawImage(img, 0, 0);
            const id = ctx.getImageData(0, 0, c.width, c.height);
            const d = id.data;

            // Detect background color from top-left pixel
            const bgR = d[0];
            const bgG = d[1];
            const bgB = d[2];

            // Replace matching background color with transparency
            const range = 50;
            for (let i = 0; i < d.length; i += 4) {
                if (Math.abs(d[i] - bgR) < range &&
                    Math.abs(d[i + 1] - bgG) < range &&
                    Math.abs(d[i + 2] - bgB) < range) {
                    d[i + 3] = 0;
                }
            }

            ctx.putImageData(id, 0, 0);
            const newImg = new Image();
            newImg.src = c.toDataURL();
            return newImg;
        }

        Object.entries(ASSETS).forEach(([key, src]) => {
            const img = new Image();
            img.onload = () => {
                if (key === 'alienNormal' || key === 'malaysianFemale') {
                    images[key] = processTransparency(img);
                } else {
                    images[key] = img;
                }
                imagesLoaded++;
            };
            img.onerror = () => { imagesLoaded++; console.log('Asset not found:', src); };
            img.src = src;
        });

        // Difficulty Settings
        const difficultySettings = {
            easy: { spawnRate: 70, fakeChance: 0, disguiseChance: 0, time: 60, targetLife: 160 },
            normal: { spawnRate: 50, fakeChance: 0.3, disguiseChance: 0, time: 60, targetLife: 120 },
            hard: { spawnRate: 35, fakeChance: 0.5, disguiseChance: 0.3, time: 60, targetLife: 90 }
        };

        // Fake target types
        const fakeTypes = ['cardboard', 'balloon', 'cactus', 'plant'];

        // Disguise types
        const disguiseTypes = ['mustache', 'hat', 'wig'];

        function setDifficulty(diff) {
            difficulty = diff;
            document.getElementById('btnEasy').classList.toggle('opacity-60', diff !== 'easy');
            document.getElementById('btnNormal').classList.toggle('opacity-60', diff !== 'normal');
            document.getElementById('btnHard').classList.toggle('opacity-60', diff !== 'hard');
        }

        function handleBackButton() {
            if (gamePhase === 'menu') {
                document.getElementById('quitModal').classList.remove('hidden');
            } else {
                returnToMainMenu();
            }
        }

        function confirmQuit() {
            window.location.href = '../index.html';
        }

        function cancelQuit() {
            document.getElementById('quitModal').classList.add('hidden');
        }

        function returnToMainMenu() {
            gameRunning = false;
            clearInterval(gameTimer);
            gamePhase = 'menu';
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('winnerScreen').classList.add('hidden');
            document.getElementById('scoreRevealScreen').classList.add('hidden');
            document.getElementById('playerReadyScreen').classList.add('hidden');
            targets = [];
            particles = [];
            muzzleFlashes = [];
        }

        // Background Management
        class GameBackground {
            constructor() {
                // Fireflies
                this.fireflies = [];
                for (let i = 0; i < 20; i++) {
                    this.fireflies.push({
                        x: Math.random() * width,
                        y: height - Math.random() * 300,
                        size: Math.random() * 3 + 1,
                        speedX: (Math.random() - 0.5) * 0.5,
                        speedY: (Math.random() - 0.5) * 0.5,
                        alpha: Math.random(),
                        fadeDir: Math.random() > 0.5 ? 0.02 : -0.02
                    });
                }

                // Clouds
                this.clouds = [];
                for (let i = 0; i < 5; i++) {
                    this.clouds.push({
                        x: Math.random() * width,
                        y: Math.random() * height * 0.3,
                        size: 60 + Math.random() * 60,
                        speed: 0.1 + Math.random() * 0.2
                    });
                }

                // Stars
                this.stars = [];
                for (let i = 0; i < 80; i++) {
                    this.stars.push({
                        x: Math.random() * width,
                        y: Math.random() * height * 0.6,
                        size: Math.random() * 2,
                        twinkle: Math.random()
                    });
                }
            }

            update() {
                // Fireflies
                this.fireflies.forEach(f => {
                    f.x += f.speedX;
                    f.y += f.speedY;
                    f.alpha += f.fadeDir;
                    if (f.alpha > 1 || f.alpha < 0) f.fadeDir *= -1;
                    if (f.x < 0) f.x = width;
                    if (f.x > width) f.x = 0;
                });

                // Clouds
                this.clouds.forEach(c => {
                    c.x += c.speed;
                    if (c.x > width + 100) c.x = -100;
                });

                // Stars
                this.stars.forEach(s => {
                    s.twinkle += 0.05;
                });
            }

            draw() {
                // 1. Sky Gradient (Deep Purple/Blue Night)
                const grad = ctx.createLinearGradient(0, 0, 0, height);
                grad.addColorStop(0, '#0f172a'); // Slate 900
                grad.addColorStop(0.5, '#1e1b4b'); // Indigo 950
                grad.addColorStop(1, '#312e81'); // Indigo 900
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, width, height);

                // 2. Stars
                ctx.fillStyle = '#FFF';
                this.stars.forEach(s => {
                    ctx.globalAlpha = 0.5 + Math.sin(s.twinkle) * 0.4;
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                    ctx.fill();
                });
                ctx.globalAlpha = 1;

                // 3. Moon (Glowing)
                const moonX = width - 100;
                const moonY = 80;
                // Glow
                const moonGlow = ctx.createRadialGradient(moonX, moonY, 20, moonX, moonY, 60);
                moonGlow.addColorStop(0, 'rgba(255, 255, 210, 0.4)');
                moonGlow.addColorStop(1, 'rgba(255, 255, 210, 0)');
                ctx.fillStyle = moonGlow;
                ctx.beginPath();
                ctx.arc(moonX, moonY, 60, 0, Math.PI * 2);
                ctx.fill();
                // Body
                ctx.fillStyle = '#fef3c7';
                ctx.beginPath();
                ctx.arc(moonX, moonY, 25, 0, Math.PI * 2);
                ctx.fill();

                // 4. Clouds (Back)
                ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
                this.clouds.forEach(c => {
                    this.drawCloud(c.x, c.y, c.size);
                });

                // 5. Far Hills (Silhouette)
                ctx.fillStyle = '#1e1b4b'; // Dark Indigo
                ctx.beginPath();
                ctx.moveTo(0, height);
                ctx.lineTo(0, height * 0.65);
                ctx.bezierCurveTo(width * 0.3, height * 0.55, width * 0.7, height * 0.7, width, height * 0.6);
                ctx.lineTo(width, height);
                ctx.fill();

                // 6. Mid Layer (Palm Trees)
                ctx.fillStyle = '#312e81'; // Lighter Indigo
                this.drawPalmTree(width * 0.1, height * 0.75, 120);
                this.drawPalmTree(width * 0.85, height * 0.8, 140);
                this.drawPalmTree(width * 0.2, height * 0.85, 100);

                // 7. Ground
                ctx.fillStyle = '#172554'; // Blue 950
                ctx.fillRect(0, height * 0.8, width, height * 0.2);

                // 8. Houses (Detailed Silhouette)
                // Left House
                this.drawKampungHouse(50, height * 0.8 - 60, 0.8);
                // Right House
                this.drawKampungHouse(width - 180, height * 0.8 - 70, 0.9);

                // 9. Fireflies
                this.fireflies.forEach(f => {
                    ctx.fillStyle = 'rgba(253, 224, 71, ' + f.alpha + ')'; // Yellow
                    ctx.beginPath();
                    ctx.arc(f.x, f.y, f.size, 0, Math.PI * 2);
                    ctx.fill();
                    // Glow
                    ctx.fillStyle = 'rgba(253, 224, 71, ' + (f.alpha * 0.3) + ')';
                    ctx.beginPath();
                    ctx.arc(f.x, f.y, f.size * 3, 0, Math.PI * 2);
                    ctx.fill();
                });
            }

            drawCloud(x, y, size) {
                ctx.beginPath();
                ctx.arc(x, y, size, 0, Math.PI * 2);
                ctx.arc(x + size * 0.6, y - size * 0.2, size * 0.8, 0, Math.PI * 2);
                ctx.arc(x - size * 0.6, y - size * 0.2, size * 0.8, 0, Math.PI * 2);
                ctx.fill();
            }

            drawPalmTree(x, y, h) {
                // Trunk
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.quadraticCurveTo(x + 10, y - h / 2, x - 5, y - h);
                ctx.lineTo(x + 5, y - h);
                ctx.quadraticCurveTo(x + 20, y - h / 2, x + 15, y);
                ctx.fill();

                // Leaves
                const tipX = x; // Approximate top
                const tipY = y - h;
                for (let i = 0; i < 7; i++) {
                    const angle = (Math.PI / 4) + (Math.PI / 6) * i; // Arc spread
                    const len = 40 + Math.random() * 20;
                    const ex = tipX + Math.cos(angle) * len;
                    const ey = tipY - h * 0.2 + Math.sin(angle) * len;

                    ctx.lineWidth = 3;
                    ctx.strokeStyle = ctx.fillStyle; // Inherit color
                    ctx.beginPath();
                    ctx.moveTo(tipX, tipY);
                    ctx.quadraticCurveTo(tipX + (ex - tipX) / 2, tipY - 20, ex, ey);
                    ctx.stroke();
                }
                ctx.lineWidth = 1;
            }

            drawKampungHouse(x, y, scale) {
                ctx.save();
                ctx.translate(x, y);
                ctx.scale(scale, scale);
                ctx.fillStyle = '#0f172a'; // Dark silhouette

                // Stilts
                ctx.fillRect(10, 50, 5, 30);
                ctx.fillRect(30, 50, 5, 30);
                ctx.fillRect(60, 50, 5, 30);
                ctx.fillRect(90, 50, 5, 30);

                // Floor/Body
                ctx.fillRect(0, 0, 110, 50);

                // Roof (Trapezoid/Triangle mix)
                ctx.beginPath();
                ctx.moveTo(-10, 0);
                ctx.lineTo(120, 0);
                ctx.lineTo(100, -30);
                ctx.lineTo(10, -30);
                ctx.closePath();
                ctx.fill();
                // Top Roof
                ctx.beginPath();
                ctx.moveTo(10, -30);
                ctx.lineTo(100, -30);
                ctx.lineTo(55, -50);
                ctx.closePath();
                ctx.fill();

                // Window glow
                ctx.fillStyle = 'rgba(253, 224, 71, 0.6)'; // Yellow light
                ctx.fillRect(20, 15, 20, 20);
                ctx.fillRect(70, 15, 20, 20);

                ctx.restore();
            }
        }

        const bg = new GameBackground();

        // Target Class
        class Target {
            constructor() {
                const settings = difficultySettings[difficulty];

                // Determine Type
                this.isReal = Math.random() >= settings.fakeChance;

                // 20% Unknown/Malaysian chance if fake
                if (!this.isReal) {
                    if (Math.random() < 0.2) {
                        this.fakeType = 'malaysian';
                    } else {
                        // Exclude malaysian from standard fakes list to avoid double counting if I added it there
                        this.fakeType = fakeTypes[Math.floor(Math.random() * fakeTypes.length)];
                    }
                } else {
                    this.fakeType = null;
                }

                // Disguise logic (Real Only)
                this.hasDisguise = this.isReal && Math.random() < settings.disguiseChance;
                this.disguiseType = this.hasDisguise ? disguiseTypes[Math.floor(Math.random() * disguiseTypes.length)] : null;
                this.disguiseFalling = false;

                // Malaysian properties
                this.isMalaysian = this.fakeType === 'malaysian';
                this.malaysianGender = Math.random() > 0.5 ? 'male' : 'female';
                this.size = TARGET_BASE_SIZE; // Standardized size for all targets

                // Randomize alien variant (for real aliens)
                const alienVariants = ['alienBlueAnt', 'alienOrangeTall', 'alienRedRound', 'alienGreenEyes'];
                this.alienVariant = alienVariants[Math.floor(Math.random() * alienVariants.length)];

                // Randomize Malaysian  variant (for fake malaysians)
                const malaysianVariants = this.malaysianGender === 'male'
                    ? ['pakcikSongkok', 'uncleBatik']
                    : ['malaysianFemale'];
                this.malaysianVariant = malaysianVariants[Math.floor(Math.random() * malaysianVariants.length)];

                let safe = false;
                let attempts = 0;
                while (!safe && attempts < 20) {
                    // Increased top margin to 280 to avoid enlarged HUD
                    this.x = Math.random() * (width - 200) + 100;
                    this.y = Math.random() * (height * 0.5) + 280;

                    safe = true;
                    for (const t of targets) {
                        // ... existing overlap check ...
                        const dx = this.x - t.x;
                        const dy = this.y - t.y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        // Ensure at least 50px gap between edges
                        if (dist < (this.size / 2 + t.size / 2 + 50)) {
                            safe = false;
                            break;
                        }
                    }
                    attempts++;
                }

                this.state = 'active';
                this.animTimer = 0;
                this.wobble = Math.random() * Math.PI * 2;
                this.life = settings.targetLife;
                this.hoverTime = 0;
                this.hue = this.isReal ? 120 : 0;

                // Fun Movement: Random velocity
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 1;
            }

            update() {
                if (this.state === 'active') {
                    this.wobble += 0.05;

                    // Fun Movement
                    this.x += this.vx + Math.sin(this.wobble) * 0.5;
                    this.y += this.vy + Math.cos(this.wobble * 0.7) * 0.3;

                    // Bounce off walls (respecting new top margin 280)
                    if (this.x < 80 || this.x > width - 80) this.vx *= -1;
                    if (this.y < 280 || this.y > height * 0.8) this.vy *= -1;

                    // Keep in bounds
                    this.x = Math.max(80, Math.min(width - 80, this.x));
                    this.y = Math.max(280, Math.min(height * 0.8, this.y));

                    this.life--;
                    if (this.life <= 0) return false;

                    // Check if mouse is hovering (for disguise reveal on hard mode)
                    const dx = mouseX - this.x;
                    const dy = mouseY - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < this.size && this.hasDisguise && !this.disguiseFalling) {
                        this.hoverTime++;
                        if (this.hoverTime > 60) {
                            this.disguiseFalling = true;
                        }
                    } else {
                        this.hoverTime = Math.max(0, this.hoverTime - 1);
                    }
                } else {
                    this.animTimer++;
                    if (this.animTimer > 30) return false;
                }
                return true;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);

                if (this.state === 'hit') {
                    const progress = this.animTimer / 30;
                    ctx.scale(1 - progress, 1 - progress);
                    ctx.rotate(progress * Math.PI * 0.5);
                    ctx.globalAlpha = 1 - progress;
                } else if (this.state === 'wrong') {
                    ctx.rotate(Math.sin(this.animTimer * 0.7) * 0.2);
                }

                if (this.isReal) {
                    this.drawAlien();
                    if (this.hasDisguise && !this.disguiseFalling) {
                        this.drawDisguise();
                    }
                } else {
                    this.drawFakeTarget();
                }

                ctx.restore();

                // Draw falling disguise separately
                if (this.disguiseFalling && this.animTimer < 60) {
                    this.drawFallingDisguise();
                }
            }

            drawAlien() {
                // Use randomized alien variant
                let img = images[this.alienVariant];

                // Programmatic Hit Effect (Red Tint) instead of swapping image
                if (this.state === 'hit') {
                    ctx.filter = 'brightness(0.8) sepia(1) hue-rotate(-50deg) saturate(5)';
                }

                if (img && img.complete && img.naturalWidth > 0) {
                    ctx.drawImage(img, -this.size / 2, -this.size / 2 * 0.85, this.size, this.size * 0.85);

                    // Reset filter
                    ctx.filter = 'none';

                    // Skin peek visible check (for disguises)
                    if (this.hasDisguise) {
                        ctx.fillStyle = '#4CAF50'; // Green skin peek
                        ctx.beginPath();
                        ctx.arc(-25, 5, 8, 0, Math.PI * 2);
                        ctx.arc(25, 5, 8, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } else {
                    ctx.filter = 'none'; // Safety reset
                    this.drawAlienFallback();
                }
            }

            drawAlienFallback() {
                // Body (green for real aliens)
                ctx.fillStyle = '#4CAF50';
                ctx.beginPath();
                ctx.ellipse(0, 0, this.size / 2, this.size / 2 * 0.85, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#2E7D32';
                ctx.lineWidth = 3;
                ctx.stroke();

                // Three eyes (distinctive alien feature)
                ctx.fillStyle = '#FFF';
                ctx.beginPath();
                ctx.arc(-15, -10, 10, 0, Math.PI * 2);
                ctx.arc(0, -15, 8, 0, Math.PI * 2);
                ctx.arc(15, -10, 10, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(-15 + Math.sin(frameCount * 0.08) * 2, -10, 4, 0, Math.PI * 2);
                ctx.arc(0 + Math.sin(frameCount * 0.08) * 2, -15, 3, 0, Math.PI * 2);
                ctx.arc(15 + Math.sin(frameCount * 0.08) * 2, -10, 4, 0, Math.PI * 2);
                ctx.fill();

                // Suspicious mouth
                ctx.strokeStyle = '#2E7D32';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(0, 10, 10, 0.2, Math.PI - 0.2);
                ctx.stroke();

                // Small antennae
                ctx.strokeStyle = '#4CAF50';
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.beginPath();
                ctx.moveTo(-10, -this.size * 0.4);
                ctx.lineTo(-15, -this.size * 0.55);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(10, -this.size * 0.4);
                ctx.lineTo(15, -this.size * 0.55);
                ctx.stroke();

                // Green skin visible (shows even with disguise)
                if (this.hasDisguise) {
                    ctx.fillStyle = '#4CAF50';
                    ctx.beginPath();
                    ctx.arc(-25, 5, 8, 0, Math.PI * 2);
                    ctx.arc(25, 5, 8, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            drawDisguise() {
                if (this.disguiseType === 'mustache') {
                    ctx.fillStyle = '#5D4037';
                    ctx.beginPath();
                    ctx.moveTo(-20, 5);
                    ctx.quadraticCurveTo(-25, 15, -15, 12);
                    ctx.quadraticCurveTo(0, 8, 15, 12);
                    ctx.quadraticCurveTo(25, 15, 20, 5);
                    ctx.quadraticCurveTo(0, 10, -20, 5);
                    ctx.fill();
                } else if (this.disguiseType === 'hat') {
                    ctx.fillStyle = '#795548';
                    ctx.beginPath();
                    ctx.ellipse(0, -this.size * 0.35, 30, 10, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillRect(-15, -this.size * 0.55, 30, 20);
                } else if (this.disguiseType === 'wig') {
                    ctx.fillStyle = '#FDD835';
                    ctx.beginPath();
                    ctx.moveTo(-30, -10);
                    ctx.quadraticCurveTo(-35, -40, -10, -35);
                    ctx.quadraticCurveTo(0, -50, 10, -35);
                    ctx.quadraticCurveTo(35, -40, 30, -10);
                    ctx.quadraticCurveTo(25, 5, 20, 0);
                    ctx.lineTo(-20, 0);
                    ctx.quadraticCurveTo(-25, 5, -30, -10);
                    ctx.fill();
                }
            }

            drawFallingDisguise() {
                ctx.save();
                const progress = this.hoverTime / 60;
                ctx.translate(this.x, this.y + progress * 80);
                ctx.rotate(progress * Math.PI * 0.5);
                ctx.globalAlpha = 1 - progress * 0.5;

                if (this.disguiseType === 'hat') {
                    ctx.fillStyle = '#795548';
                    ctx.fillRect(-15, -10, 30, 20);
                }

                ctx.restore();
            }

            drawFakeTarget() {
                if (this.fakeType === 'malaysian') {
                    // MALAYSIAN HUMAN (randomized variant)
                    const img = images[this.malaysianVariant];

                    if (img && img.complete && img.naturalWidth > 0) {
                        ctx.drawImage(img, -this.size / 2, -this.size / 2, this.size, this.size);
                    } else {
                        // Fallback circle
                        ctx.fillStyle = '#2196F3';
                        ctx.beginPath();
                        ctx.arc(0, 0, this.size / 2, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.fillStyle = '#FFF';
                        ctx.fillText('HUMAN', -20, 0);
                    }

                } else if (this.fakeType === 'cardboard') {
                    // Cardboard alien cutout
                    ctx.fillStyle = '#D7CCC8';
                    ctx.beginPath();
                    ctx.ellipse(0, 0, this.size / 2, this.size / 2 * 0.85, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#8D6E63';
                    ctx.lineWidth = 4;
                    ctx.setLineDash([10, 5]);
                    ctx.stroke();
                    ctx.setLineDash([]);

                    // Drawn-on face
                    ctx.strokeStyle = '#5D4037';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(-12, -8, 8, 0, Math.PI * 2);
                    ctx.arc(12, -8, 8, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(0, 10, 10, 0, Math.PI);
                    ctx.stroke();

                    // "FAKE" label
                    ctx.font = 'bold 12px Fredoka';
                    ctx.fillStyle = '#8D6E63';
                    ctx.textAlign = 'center';
                    ctx.fillText('CARDBOARD', 0, this.size * 0.6);

                } else if (this.fakeType === 'balloon') {
                    // Green balloon
                    ctx.fillStyle = '#81C784';
                    ctx.beginPath();
                    ctx.ellipse(0, -5, this.size * 0.4, this.size * 0.5, 0, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.strokeStyle = '#4CAF50';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Balloon knot
                    ctx.beginPath();
                    ctx.moveTo(0, this.size * 0.4);
                    ctx.lineTo(0, this.size * 0.55);
                    ctx.stroke();

                    // String
                    ctx.beginPath();
                    ctx.moveTo(0, this.size * 0.55);
                    ctx.quadraticCurveTo(10, this.size * 0.7, 0, this.size * 0.8);
                    ctx.stroke();

                    // Shine
                    ctx.fillStyle = 'rgba(255,255,255,0.5)';
                    ctx.beginPath();
                    ctx.ellipse(-10, -15, 8, 12, -0.3, 0, Math.PI * 2);
                    ctx.fill();

                } else if (this.fakeType === 'poster') {
                    // Movie poster with alien
                    ctx.fillStyle = '#263238';
                    ctx.fillRect(-25, -35, 50, 70);
                    ctx.strokeStyle = '#FFF';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(-25, -35, 50, 70);

                    // Alien drawing on poster
                    ctx.fillStyle = '#4CAF50';
                    ctx.beginPath();
                    ctx.arc(0, -10, 15, 0, Math.PI * 2);
                    ctx.fill();

                    // Text
                    ctx.font = 'bold 8px Fredoka';
                    ctx.fillStyle = '#FFF';
                    ctx.textAlign = 'center';
                    ctx.fillText('COMING SOON', 0, 25);

                } else if (this.fakeType === 'cactus') {
                    // Cactus (Scaling based on this.size)
                    const scale = this.size / 100;
                    ctx.fillStyle = '#4CAF50';
                    ctx.beginPath();
                    ctx.roundRect(-12 * scale, -30 * scale, 24 * scale, 60 * scale, 10 * scale);
                    ctx.fill();

                    // Arms
                    ctx.beginPath();
                    ctx.roundRect(-30 * scale, -15 * scale, 20 * scale, 10 * scale, 5 * scale);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.roundRect(-30 * scale, -28 * scale, 10 * scale, 18 * scale, 5 * scale);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.roundRect(10 * scale, 0 * scale, 20 * scale, 10 * scale, 5 * scale);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.roundRect(20 * scale, -15 * scale, 10 * scale, 18 * scale, 5 * scale);
                    ctx.fill();

                    // Spines
                    ctx.strokeStyle = '#2E7D32';
                    ctx.lineWidth = 1 * scale;
                    for (let i = 0; i < 8; i++) {
                        ctx.beginPath();
                        ctx.moveTo((-12 + Math.random() * 24) * scale, (-25 + i * 7) * scale);
                        ctx.lineTo((-15 + Math.random() * 30) * scale, (-28 + i * 7) * scale);
                        ctx.stroke();
                    }

                    // Pot
                    ctx.fillStyle = '#8D6E63';
                    ctx.beginPath();
                    ctx.moveTo(-18 * scale, 25 * scale);
                    ctx.lineTo(-15 * scale, 40 * scale);
                    ctx.lineTo(15 * scale, 40 * scale);
                    ctx.lineTo(18 * scale, 25 * scale);
                    ctx.closePath();
                    ctx.fill();

                } else if (this.fakeType === 'plant') {
                    // Houseplant (Scaling based on this.size)
                    const scale = this.size / 100;
                    ctx.fillStyle = '#8D6E63';
                    ctx.beginPath();
                    ctx.moveTo(-20 * scale, 15 * scale);
                    ctx.lineTo(-15 * scale, 40 * scale);
                    ctx.lineTo(15 * scale, 40 * scale);
                    ctx.lineTo(20 * scale, 15 * scale);
                    ctx.closePath();
                    ctx.fill();

                    // Leaves
                    ctx.fillStyle = '#4CAF50';
                    for (let i = 0; i < 5; i++) {
                        ctx.save();
                        ctx.rotate((i - 2) * 0.4);
                        ctx.beginPath();
                        ctx.ellipse(0, -25 * scale, 8 * scale, 25 * scale, 0, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.restore();
                    }
                }
            }

            hit() {
                this.state = this.isReal ? 'hit' : 'wrong';
                this.animTimer = 0;
            }
        }

        // Muzzle Flash
        class MuzzleFlash {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.size = 40;
                this.life = 6;
            }

            update() {
                this.life--;
                this.size += 5;
                return this.life > 0;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.globalAlpha = this.life / 6;

                // Flash
                ctx.fillStyle = '#FFEB3B';
                ctx.beginPath();
                ctx.arc(0, 0, this.size / 2, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#FF5722';
                ctx.beginPath();
                ctx.arc(0, 0, this.size / 3, 0, Math.PI * 2);
                ctx.fill();

                ctx.restore();
            }
        }

        // Popup
        class Popup {
            constructor(x, y, text, color, isReaction = false) {
                this.x = x;
                this.y = y;
                this.text = text;
                this.color = color;
                this.isReaction = isReaction;
                this.life = isReaction ? 50 : 35;
            }

            update() {
                if (!this.isReaction) this.y -= 2;
                this.life--;
                return this.life > 0;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = Math.min(1, this.life / 15);
                ctx.font = this.isReaction ? 'bold 40px Fredoka' : 'bold 28px Fredoka';
                ctx.textAlign = 'center';
                ctx.fillStyle = this.color;
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.strokeText(this.text, this.x, this.y);
                ctx.fillText(this.text, this.x, this.y);
                ctx.restore();
            }
        }

        // Particle
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 12;
                this.vy = (Math.random() - 0.5) * 12 - 3;
                this.life = 1;
                this.color = color;
                this.size = Math.random() * 6 + 3;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.25;
                this.life -= 0.035;
                return this.life > 0;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        // Game Functions
        function startGame(players) {
            numPlayers = players;
            currentPlayer = 1;
            p1Score = 0;
            p2Score = 0;
            totalShots = 0;
            correctShots = 0;
            document.getElementById('mainMenu').classList.add('hidden');

            if (players === 2) {
                document.getElementById('p2ScoreBox').classList.remove('hidden');
                gamePhase = 'ready';
                showReadyScreen();
            } else {
                document.getElementById('p2ScoreBox').classList.add('hidden');
                startCountdown();
            }
            initAudio(); // üîä Start Audio
        }

        function showReadyScreen() {
            const screen = document.getElementById('playerReadyScreen');
            const text = document.getElementById('playerReadyText');
            screen.classList.remove('hidden');

            text.textContent = `PLAYER ${currentPlayer} READY?`;
            text.style.color = currentPlayer === 1 ? '#FF5252' : '#F97316';

            setTimeout(() => {
                screen.classList.add('hidden');
                startCountdown();
            }, 2000);
        }

        function startCountdown() {
            const countEl = document.getElementById('countdown');
            const textEl = document.getElementById('countdownText');
            countEl.classList.remove('hidden');

            let count = 3;
            textEl.textContent = count;

            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    textEl.textContent = count;
                } else if (count === 0) {
                    textEl.textContent = 'SHOOT!';
                } else {
                    clearInterval(interval);
                    countEl.classList.add('hidden');
                    startRound();
                }
            }, 1000);
        }

        function startRound() {
            gameRunning = true;
            gamePhase = 'playing';
            targets = [];
            particles = [];
            muzzleFlashes = [];
            popups = [];
            totalShots = 0;
            correctShots = 0;

            timeRemaining = difficultySettings[difficulty].time;
            document.getElementById('timer').textContent = timeRemaining;
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('difficultyBadge').textContent = difficulty.toUpperCase();
            updateAccuracyDisplay();

            updateScoreDisplay();

            gameTimer = setInterval(() => {
                timeRemaining--;
                document.getElementById('timer').textContent = timeRemaining;
                if (timeRemaining <= 0) {
                    endRound();
                }
            }, 1000);

            gameLoop();
        }

        function updateScoreDisplay() {
            if (numPlayers === 2) {
                document.getElementById('p1Score').textContent = currentPlayer === 1 ? getCurrentScore() : p1Score;
                document.getElementById('p2Score').textContent = currentPlayer === 2 ? getCurrentScore() : p2Score;
            } else {
                document.getElementById('p1Score').textContent = p1Score;
            }
        }

        function updateAccuracyDisplay() {
            const accuracy = totalShots > 0 ? Math.round((correctShots / totalShots) * 100) : 100;
            document.getElementById('accuracyBadge').textContent = `üéØ ${accuracy}%`;
        }

        function getAccuracy() {
            return totalShots > 0 ? Math.round((correctShots / totalShots) * 100) : 100;
        }

        function getAccuracyBonus() {
            const acc = getAccuracy();
            if (acc >= 90) return 100;
            if (acc >= 80) return 50;
            return 0;
        }

        function getCurrentScore() {
            return currentPlayer === 1 ? p1Score : p2Score;
        }

        function addScore(points) {
            if (currentPlayer === 1) {
                p1Score += points;
                p1Score = Math.max(0, p1Score);
            } else {
                p2Score += points;
                p2Score = Math.max(0, p2Score);
            }
            updateScoreDisplay();
        }

        function endRound() {
            gameRunning = false;
            clearInterval(gameTimer);
            document.getElementById('hud').classList.add('hidden');

            // Add accuracy bonus
            const bonus = getAccuracyBonus();
            if (bonus > 0) {
                addScore(bonus);
            }

            if (numPlayers === 2) {
                if (currentPlayer === 1) {
                    showScoreReveal(1, p1Score);
                } else {
                    showScoreReveal(2, p2Score);
                }
            } else {
                document.getElementById('finalScore').textContent = p1Score;
                document.getElementById('finalAccuracy').textContent = `üéØ Accuracy: ${getAccuracy()}% ${bonus > 0 ? '(+' + bonus + ' bonus!)' : ''}`;
                document.getElementById('endScreen').classList.remove('hidden');
            }
        }

        function showScoreReveal(player, score) {
            gamePhase = 'scoreReveal';
            const screen = document.getElementById('scoreRevealScreen');
            const bonus = getAccuracyBonus();
            document.getElementById('scoreRevealTitle').textContent = `PLAYER ${player} SCORED`;
            document.getElementById('scoreRevealNumber').textContent = score;
            document.getElementById('accuracyResult').textContent = `üéØ Accuracy: ${getAccuracy()}% ${bonus > 0 ? '(+' + bonus + ' bonus!)' : ''}`;
            screen.classList.remove('hidden');
            spawnConfetti('confettiContainer');

            screen.onclick = () => {
                screen.classList.add('hidden');
                screen.onclick = null;

                if (player === 1) {
                    currentPlayer = 2;
                    totalShots = 0;
                    correctShots = 0;
                    gamePhase = 'ready';
                    showReadyScreen();
                } else {
                    showWinner();
                }
            };
        }

        function showWinner() {
            gamePhase = 'winner';
            const screen = document.getElementById('winnerScreen');
            document.getElementById('winnerP1Score').textContent = p1Score;
            document.getElementById('winnerP2Score').textContent = p2Score;

            let subtitle = '';
            if (p1Score > p2Score) {
                subtitle = 'PLAYER 1 WINS! üéâ';
            } else if (p2Score > p1Score) {
                subtitle = 'PLAYER 2 WINS! üéâ';
            } else {
                subtitle = "IT'S A TIE! ü§ù";
            }
            document.getElementById('winnerSubtitle').textContent = subtitle;

            screen.classList.remove('hidden');
            spawnConfetti('winnerConfettiContainer');
        }

        function spawnConfetti(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const colors = ['#FF5252', '#FFD600', '#00E676', '#2196F3', '#E040FB'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.fontSize = (Math.random() * 20 + 10) + 'px';
                confetti.textContent = ['üéâ', 'üéä', '‚ú®', '‚≠ê', 'üéØ'][Math.floor(Math.random() * 5)];
                confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
                container.appendChild(confetti);
            }
        }

        function rematch() {
            document.getElementById('winnerScreen').classList.add('hidden');
            currentPlayer = 1;
            p1Score = 0;
            p2Score = 0;
            totalShots = 0;
            correctShots = 0;
            gamePhase = 'ready';
            showReadyScreen();
        }

        // Spawn targets
        function spawnTarget() {
            if (!gameRunning) return;
            const settings = difficultySettings[difficulty];
            if (frameCount % settings.spawnRate === 0) {
                targets.push(new Target());
            }
        }

        // Track mouse position
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mouseX = e.clientX - rect.left;
            mouseY = e.clientY - rect.top;
        });

        // Handle click/touch
        function handleClick(e) {
            if (!gameRunning) return;

            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            let x, y;

            if (e.touches) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }

            // Create muzzle flash
            muzzleFlashes.push(new MuzzleFlash(x, y));

            // Create red flash effect
            if (images.redFlash && images.redFlash.complete) {
                particles.push({
                    x, y,
                    vx: 0, vy: 0,
                    life: 15,
                    maxLife: 15,
                    isFlash: true,
                    update() {
                        this.life--;
                        return this.life > 0;
                    },
                    draw() {
                        const alpha = this.life / this.maxLife;
                        ctx.globalAlpha = alpha * 0.8;
                        const size = 150 * (1 - alpha * 0.5);
                        ctx.drawImage(images.redFlash, this.x - size / 2, this.y - size / 2, size, size);
                        ctx.globalAlpha = 1;
                    }
                });
            }

            totalShots++;

            // Check if hit any target
            let hitSomething = false;
            for (let target of targets) {
                if (target.state !== 'active') continue;

                // üéØ REFINED HIT DETECTION: Type-specific rectangles
                let hitWidthMod = 0.5;
                let hitHeightMod = 0.8;

                if (target.isReal) {
                    hitWidthMod = 0.6; // Easier to hit aliens
                } else if (target.fakeType === 'cactus') {
                    hitWidthMod = 0.3; // Skinny
                } else if (target.fakeType === 'cardboard') {
                    hitWidthMod = 0.8; // Wide
                } else if (target.fakeType === 'balloon') {
                    hitWidthMod = 0.5;
                }

                const isHit = Math.abs(x - target.x) < (target.size * hitWidthMod / 2) &&
                    Math.abs(y - target.y) < (target.size * hitHeightMod / 2);

                if (isHit) {
                    hitSomething = true;
                    target.hit();

                    if (target.isReal) {
                        // Hit real alien
                        correctShots++;
                        addScore(10);
                        popups.push(new Popup(target.x, target.y - 50, '+10', '#00E676'));

                        // Particles
                        for (let i = 0; i < 10; i++) {
                            particles.push(new Particle(target.x, target.y, '#4CAF50'));
                        }
                        SFX.shot(); // ‚ö° Zap
                    } else {
                        // Hit fake target
                        addScore(-5);
                        popups.push(new Popup(target.x, target.y - 50, '-5', '#FF5252'));

                        SFX.error(); // üö´ Buzzer

                        // Reaction based on type
                        if (target.fakeType === 'malaysian') {
                            const reactions = ['ADOI!', 'GILA KE?!', 'MATA MANA?', 'SALAH LA!', 'SAYANG NYA!'];
                            popups.push(new Popup(target.x, target.y - 90, reactions[Math.floor(Math.random() * reactions.length)], '#FFC107', true));
                        } else if (target.fakeType === 'cactus') {
                            popups.push(new Popup(target.x, target.y - 90, 'OUCH!', '#FF9800', true));
                        } else if (target.fakeType === 'balloon') {
                            popups.push(new Popup(target.x, target.y - 90, 'POP!', '#2196F3', true));
                            // Balloon pop particles
                            for (let i = 0; i < 15; i++) {
                                particles.push(new Particle(target.x, target.y, '#81C784'));
                            }
                        } else {
                            popups.push(new Popup(target.x, target.y - 90, 'EH?', '#FF5722', true));
                        }
                    }
                    updateAccuracyDisplay();
                    break;
                }
            }

            // Miss feedback
            if (!hitSomething) {
                popups.push(new Popup(x, y - 30, 'MISS', '#888'));
            }
        }

        canvas.addEventListener('click', handleClick);
        canvas.addEventListener('touchstart', handleClick);

        // Draw crosshair
        function drawCrosshair() {
            ctx.save();
            ctx.strokeStyle = '#FF5252';
            ctx.lineWidth = 2;

            ctx.beginPath();
            ctx.arc(mouseX, mouseY, 20, 0, Math.PI * 2);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(mouseX - 30, mouseY);
            ctx.lineTo(mouseX - 10, mouseY);
            ctx.moveTo(mouseX + 10, mouseY);
            ctx.lineTo(mouseX + 30, mouseY);
            ctx.moveTo(mouseX, mouseY - 30);
            ctx.lineTo(mouseX, mouseY - 10);
            ctx.moveTo(mouseX, mouseY + 10);
            ctx.lineTo(mouseX, mouseY + 30);
            ctx.stroke();

            ctx.fillStyle = '#FF5252';
            ctx.beginPath();
            ctx.arc(mouseX, mouseY, 3, 0, Math.PI * 2);
            ctx.fill();

            ctx.restore();
        }

        // Game Loop
        function gameLoop() {
            if (!gameRunning) return;

            frameCount++;

            // Clear canvas
            ctx.fillStyle = '#ECEFF1';
            ctx.fillRect(0, 0, width, height);

            // Update and draw background
            bg.update();
            drawBackground();

            // Spawn targets
            spawnTarget();

            // Update and draw targets
            targets = targets.filter(target => {
                if (!target.update()) return false;
                target.draw();
                return true;
            });

            // Update and draw muzzle flashes
            muzzleFlashes = muzzleFlashes.filter(flash => {
                if (!flash.update()) return false;
                flash.draw();
                return true;
            });

            // Update and draw particles
            particles = particles.filter(particle => {
                if (!particle.update()) return false;
                particle.draw();
                return true;
            });

            // Update and draw popups
            popups = popups.filter(popup => {
                if (!popup.update()) return false;
                popup.draw();
                return true;
            });

            // Draw crosshair - REMOVED for projection
            // drawCrosshair();

            requestAnimationFrame(gameLoop);
        }

        function drawBackground() {
            bg.draw();
        }

        // Initial draw
        function initialDraw() {
            ctx.fillStyle = '#546E7A';
            ctx.fillRect(0, 0, width, height);
            drawBackground();
        }
        initialDraw();
    </script>
</body>

</html>