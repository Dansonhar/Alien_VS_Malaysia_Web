<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Traffic Jam vs UFO - Aliens vs Malaysians</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'fredoka': ['Fredoka', 'sans-serif'] },
                    colors: { 'sambal': '#FF5252', 'durian': '#FFD600', 'pandan': '#00E676' }
                }
            }
        }
    </script>
</head>

<body
    class="font-fredoka bg-[url('/assets/kl-night-bg.png')] bg-cover bg-bottom min-h-screen overflow-hidden touch-none select-none">

    <!-- HUD -->
    <div id="hud" class="hidden fixed top-4 left-1/2 -translate-x-1/2 z-50 flex gap-4 pointer-events-none">
        <div class="bg-white/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg">
            SCORE: <span id="score" class="text-pandan">0</span>
        </div>
        <div class="bg-white/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg">
            <span id="timer" class="text-sambal">90</span>s
        </div>
    </div>

    <canvas id="gameCanvas" class="block w-full h-screen"></canvas>

    <!-- Start Screen -->
    <div id="startScreen"
        class="fixed inset-0 bg-black/85 flex flex-col items-center justify-center z-[100] text-center px-4">
        <h1 class="text-5xl md:text-6xl font-bold text-sambal drop-shadow-[0_4px_0_#000] mb-4">
            üöó YEET THE CAR!
        </h1>
        <p class="text-white text-xl mb-8">Tap anywhere to launch Malaysian traffic at UFOs!<br>Defend KLCC!</p>
        <button onclick="startGame()"
            class="bg-yellow-400 text-black font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#F57F17] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#F57F17] transition-all mb-8">
            START DEFENSE
        </button>

        <button onclick="window.location.href='../index.html'"
            class="pointer-events-auto bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-10 rounded-2xl border-[8px] border-white shadow-lg text-3xl mt-8 transition-transform hover:scale-105 active:scale-95">
            üè† BACK TO HUB
        </button>
    </div>

    <!-- End Screen -->
    <div id="endScreen"
        class="hidden fixed inset-0 bg-black/85 flex flex-col items-center justify-center z-[100] text-center px-4">
        <h1 class="text-5xl md:text-6xl font-bold text-white drop-shadow-[0_4px_0_#000] mb-4">
            TIME'S UP!
        </h1>
        <p class="text-white text-2xl mb-8">UFOs Destroyed:</p>
        <div id="finalScore" class="text-7xl font-bold text-pandan drop-shadow-[0_4px_0_#000] mb-8">0</div>
        <button onclick="startGame()"
            class="bg-pandan text-white font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#2E7D32] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#2E7D32] transition-all">
            PLAY AGAIN
        </button>
        <button onclick="window.location.href='../'"
            class="mt-4 bg-gray-600 text-white font-bold px-6 py-2 rounded-full border-2 border-black">
            BACK TO MENU
        </button>
    </div>

    <button onclick="window.location.href='../'"
        class="fixed bottom-4 left-4 z-[200] bg-red-500 hover:bg-red-600 text-white font-bold px-6 py-3 rounded-xl border-4 border-black shadow-[4px_4px_0_#000] hover:shadow-[2px_2px_0_#000] hover:translate-y-[2px] transition-all flex items-center gap-2">
        <span class="text-2xl">üè†</span> BACK TO MENU
    </button>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        let gameRunning = false;
        let score = 0;
        let timeLeft = 90;
        let timerInterval = null;
        let cars = [];
        let ufos = [];
        let particles = [];
        let ufoSpawnRate = 60;
        let frameCount = 0;

        class CarProjectile {
            constructor(targetX, targetY) {
                this.x = width / 2;
                this.y = height;
                this.type = Math.random() < 0.3 ? 'bus' : 'kancil'; // 30% chance of bus
                this.width = this.type === 'kancil' ? 40 : 80;
                this.height = this.type === 'kancil' ? 25 : 40;

                // Physics
                const angle = Math.atan2(targetY - this.y, targetX - this.x);
                const speed = 25; // Base speed
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.gravity = 0.5;
                this.rotation = angle;

                // Add some initial upward boost to help arcs
                this.vy -= 10;

                this.active = true;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += this.gravity;
                this.rotation = Math.atan2(this.vy, this.vx);

                if (this.y > height + 100 || this.x < -100 || this.x > width + 100) {
                    this.active = false;
                }
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);

                // Color based on type
                ctx.fillStyle = this.type === 'kancil' ? '#FF5252' : '#2979FF';

                // Car Body
                ctx.beginPath();
                if (this.type === 'kancil') {
                    // Kancil shape (compact)
                    ctx.rect(-20, -12, 40, 25);
                } else {
                    // Bus shape (long)
                    ctx.rect(-40, -20, 80, 40);
                }
                ctx.fill();
                ctx.lineWidth = 2;
                ctx.strokeStyle = '#000';
                ctx.stroke();

                // Simple details
                ctx.fillStyle = '#81D4FA'; // Windows
                if (this.type === 'kancil') {
                    ctx.fillRect(-10, -12, 20, 25);
                } else {
                    ctx.fillRect(-30, -20, 60, 40);
                }

                ctx.restore();
            }
        }

        class UFO {
            constructor() {
                this.y = Math.random() * (height * 0.4); // Top 40% of screen
                this.x = Math.random() < 0.5 ? -50 : width + 50; // Coming from sides
                this.size = 50;
                this.speed = 2 + Math.random() * 2;
                this.direction = this.x < 0 ? 1 : -1;
                this.wobble = Math.random() * 100;
                this.active = true;
            }

            update() {
                this.x += this.speed * this.direction;
                this.y += Math.sin((frameCount + this.wobble) * 0.05) * 2; // Bobbing motion

                if ((this.direction === 1 && this.x > width + 100) || (this.direction === -1 && this.x < -100)) {
                    this.active = false;
                }
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);

                // Dome
                ctx.fillStyle = '#76FF03';
                ctx.beginPath(); ctx.arc(0, -10, 20, Math.PI, 0); ctx.fill();
                ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.stroke();

                // Saucer
                ctx.fillStyle = '#424242';
                ctx.beginPath(); ctx.ellipse(0, 0, 30, 10, 0, 0, Math.PI * 2); ctx.fill();
                ctx.stroke();

                // Lights
                ctx.fillStyle = `hsl(${frameCount * 5 % 360}, 100%, 50%)`;
                [-20, 0, 20].forEach(lx => {
                    ctx.beginPath(); ctx.arc(lx, 5, 3, 0, Math.PI * 2); ctx.fill();
                });

                ctx.restore();
            }
        }

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.vx = (Math.random() - 0.5) * 10;
                this.vy = (Math.random() - 0.5) * 10;
                this.life = 1;
                this.color = color;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.life -= 0.05;
                this.vy += 0.2;
            }
            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, 5, 0, Math.PI * 2); ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        function createExplosion(x, y) {
            for (let i = 0; i < 15; i++) particles.push(new Particle(x, y, '#FFC107'));
            for (let i = 0; i < 10; i++) particles.push(new Particle(x, y, '#FF5722'));
        }

        function startGame() {
            score = 0; timeLeft = 90;
            cars = []; ufos = []; particles = [];
            gameRunning = true;
            document.getElementById('score').textContent = score;
            document.getElementById('timer').textContent = timeLeft;
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--; document.getElementById('timer').textContent = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);

            requestAnimationFrame(loop);
        }

        function endGame() {
            gameRunning = false; clearInterval(timerInterval);
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('finalScore').textContent = score;
            document.getElementById('endScreen').classList.remove('hidden');
        }

        // Input Handling
        function handleInput(e) {
            if (!gameRunning) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            // Handle both touch and mouse
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const x = clientX - rect.left;
            const y = clientY - rect.top;

            cars.push(new CarProjectile(x, y));
        }

        canvas.addEventListener('mousedown', handleInput);
        canvas.addEventListener('touchstart', handleInput);

        function loop() {
            if (!gameRunning) return;
            ctx.clearRect(0, 0, width, height);

            frameCount++;
            if (frameCount % ufoSpawnRate === 0) ufos.push(new UFO());

            // Adjust difficulty
            if (score > 10) ufoSpawnRate = 45;
            if (score > 30) ufoSpawnRate = 30;

            // Update & Draw UFOs
            for (let i = ufos.length - 1; i >= 0; i--) {
                let u = ufos[i];
                u.update();
                u.draw();
                if (!u.active) ufos.splice(i, 1);
            }

            // Update & Draw Cars (Projectiles)
            for (let i = cars.length - 1; i >= 0; i--) {
                let c = cars[i];
                c.update();
                c.draw();

                // Collision Detection
                for (let j = ufos.length - 1; j >= 0; j--) {
                    let u = ufos[j];
                    let dist = Math.hypot(c.x - u.x, c.y - u.y);
                    if (dist < u.size + 20) { // Hit!
                        createExplosion(u.x, u.y);
                        u.active = false; // Destroy UFO
                        // c.active = false; // Optionally destroy car too, but piercing is fun? Let's destroy car for balance
                        // Actually, let's keep car for multi-hits (Chaos mode!) if it's a bus? 
                        // Simplified: Destroy car on hit to prevent one shot clearing screen
                        c.active = false;
                        score++;
                        document.getElementById('score').textContent = score;
                        break; // Car can only hit one UFO per frame (and gets destroyed)
                    }
                }

                if (!c.active) cars.splice(i, 1);
            }

            // Update & Draw Particles
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw();
                if (particles[i].life <= 0) particles.splice(i, 1);
            }

            // Draw Ground/Launch area hint if needed overlay
            // (Background image handles visual, but maybe a launcher base?)
            // Let's keep it clean as requested for "interactive wall" style (just shoot from bottom)

            requestAnimationFrame(loop);
        }
    </script>
</body>

</html>