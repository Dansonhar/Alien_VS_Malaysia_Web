<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sepak Salah - Aliens vs Malaysians</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Fredoka', sans-serif;
            overflow: hidden;
            touch-action: none;
            user-select: none;
        }

        .game-text {
            text-shadow: 2px 2px 0px #000;
        }

        /* Pulse Animation for HUD */
        @keyframes pulse-red {
            0% {
                transform: scale(1);
                color: #FBBF24;
            }

            50% {
                transform: scale(1.1);
                color: #EF4444;
            }

            100% {
                transform: scale(1);
                color: #FBBF24;
            }
        }

        .pulse-active {
            animation: pulse-red 0.5s infinite;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body class="bg-black text-white w-full h-screen relative">

    <!-- CANVAS LAYER -->
    <canvas id="gameCanvas" class="absolute top-0 left-0 w-full h-full z-0"></canvas>

    <!-- UI LAYER -->
    <div id="uiLayer"
        class="absolute top-0 left-0 w-full h-full z-10 pointer-events-none flex flex-col justify-between p-6">

        <!-- HUD -->
        <div id="hud" class="hidden flex justify-between items-start w-full">
            <button onclick="returnToMenu()"
                class="pointer-events-auto bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-10 rounded-2xl border-[8px] border-white shadow-lg text-3xl">
                üè† MENU
            </button>

            <div class="flex flex-col items-center gap-3">
                <div class="bg-gray-900/90 rounded-full px-12 py-4 border-[8px] border-yellow-400">
                    <span id="roundDisplay" class="text-5xl font-bold text-white game-text">ROUND 1/10</span>
                </div>
                <div id="playerIndicator"
                    class="hidden bg-purple-600/90 rounded-full px-10 py-3 border-[6px] border-white">
                    <span id="playerText" class="text-4xl font-bold text-white game-text">PLAYER 1</span>
                </div>
            </div>

            <div class="bg-blue-600 rounded-2xl px-10 py-4 border-[8px] border-white flex flex-col items-end">
                <span class="text-2xl font-bold uppercase text-white">SCORE</span>
                <span id="scoreDisplay" class="text-6xl font-bold game-text">0</span>
            </div>
        </div>

        <!-- CENTER MESSAGES -->
        <div id="centerMessage" class="absolute inset-0 flex items-center justify-center pointer-events-none"></div>

    </div>

    <!-- MENUS -->
    <div id="menuOverlay" class="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">

        <!-- MAIN MENU -->
        <div id="mainMenu"
            class="text-center w-full max-w-3xl p-10 bg-white/10 rounded-3xl border-[10px] border-yellow-400 shadow-[0_0_50px_rgba(255,215,0,0.5)]">
            <h1 class="text-8xl font-black text-yellow-400 mb-4 game-text italic">SEPAK SALAH!</h1>
            <p class="text-3xl text-white mb-10 font-bold">"Kick the ball, not the Malaysian!"</p>

            <div class="flex flex-col items-center gap-6 mb-8">
                <button onclick="startGame(1)"
                    class="pointer-events-auto bg-green-500 hover:bg-green-600 text-white text-5xl font-bold py-8 px-16 rounded-full border-b-8 border-green-800 active:border-b-0 active:translate-y-2 transition-all w-96">
                    üë§ 1 PLAYER
                </button>
                <button onclick="startGame(2)"
                    class="pointer-events-auto bg-yellow-500 hover:bg-yellow-600 text-black text-5xl font-bold py-8 px-16 rounded-full border-b-8 border-yellow-800 active:border-b-0 active:translate-y-2 transition-all w-96">
                    üë• 2 PLAYER
                </button>
            </div>
            <button onclick="window.location.href='../'"
                class="pointer-events-auto text-gray-400 hover:text-white underline text-xl">Back to Hub</button>
        </div>

        <!-- GAME OVER -->
        <div id="resultScreen" class="hidden text-center w-full max-w-3xl">
            <h2 class="text-8xl font-black text-yellow-400 mb-6 game-text">GAME OVER!</h2>
            <div id="singlePlayerResult" class="hidden mb-8">
                <p class="text-3xl text-white mb-4">GOALS SCORED</p>
                <p id="goalsScored" class="text-7xl font-bold text-green-400 game-text mb-2">0/10</p>
                <p class="text-3xl text-yellow-300">FINAL SCORE</p>
                <p id="finalScore" class="text-8xl font-bold text-white game-text">0</p>
            </div>
            <div id="twoPlayerResult" class="hidden mb-8">
                <p id="winnerText" class="text-6xl font-bold text-yellow-400 game-text mb-6">PLAYER 1 WINS!</p>
                <div class="flex justify-center gap-12 mb-4">
                    <div>
                        <p class="text-3xl text-red-400 font-bold">PLAYER 1</p>
                        <p id="p1FinalScore" class="text-7xl font-bold text-white game-text">0</p>
                    </div>
                    <div class="text-6xl font-bold text-white">VS</div>
                    <div>
                        <p class="text-3xl text-blue-400 font-bold">PLAYER 2</p>
                        <p id="p2FinalScore" class="text-7xl font-bold text-white game-text">0</p>
                    </div>
                </div>
            </div>
            <div class="flex justify-center gap-6">
                <button onclick="location.reload()"
                    class="pointer-events-auto bg-green-500 hover:bg-green-600 text-white text-4xl font-bold py-6 px-12 rounded-full border-b-8 border-green-800 active:border-b-0 active:translate-y-2">
                    REMATCH üîÑ
                </button>
            </div>
        </div>

        <!-- Player Turn Screen -->
        <div id="turnScreen" class="hidden text-center w-full max-w-3xl">
            <h2 id="turnTitle" class="text-8xl font-black text-yellow-400 mb-8 game-text">PLAYER 2 READY?</h2>
            <p class="text-4xl text-white mb-4">Get ready to score!</p>
            <p id="turnScore" class="text-3xl text-gray-300 mb-10">Player 1 Score: 0</p>
            <button onclick="startPlayerTurn()"
                class="pointer-events-auto bg-yellow-500 hover:bg-yellow-600 text-black text-5xl font-bold py-8 px-16 rounded-full border-b-8 border-yellow-800 active:border-b-0 active:translate-y-2 transition-all">
                START üî•
            </button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // ASSETS
        const ASSETS = {
            stadium: new Image(),
            goal: new Image(),
            alien: new Image(),
            malaysian: new Image()
        };
        ASSETS.stadium.src = '../assets/goal_stadium_bg.jpg';
        ASSETS.goal.src = '../assets/goal_v3.png';
        ASSETS.alien.src = '../assets/alien_purple_v2.png';
        ASSETS.malaysian.src = '../assets/malaysian_male.png';
        ASSETS.ball = new Image();
        ASSETS.ball.src = '../assets/ball.png'; // USER: Replace this file to change ball!

        // Feedback Phrases
        const BLOCK_PHRASES = ["TAK KENA! HAHA", "LEMAH!", "TRY HARD!", "DAH AGAK!", "BOLEH BLAH!"];
        const GOAL_PHRASES = ["NOOB!", "KOSONG!", "TAK NAMPAK KE?", "TIDO KE?", "ADUI!"];

        function getRandomPhrase(list) {
            return list[Math.floor(Math.random() * list.length)];
        }

        // Helper: Transparent Image Processor
        // Helper: Transparent Image Processor
        // Removed: Performed offline to avoid CORS/SecurityError on file:// protocol


        // --- GAME STATE ---
        let width, height;
        let gameState = 'MENU'; // MENU, PLAYING, TURN_SWITCH, RESULT
        let numPlayers = 1;
        let currentPlayer = 1;
        let currentRound = 1;
        let maxRounds = 10; // 10 for 1P, 5 for 2P
        let p1Score = 0;
        let p2Score = 0;
        let p1Goals = 0;
        let p2Goals = 0;
        let particles = [];
        let popups = [];

        // Asset Loading Wrapper
        let resourcesLoaded = 0;
        function checkLoad() {
            resourcesLoaded++;
            if (resourcesLoaded === 4) {
                render();
                resize();
            }
        }

        ASSETS.stadium.onload = checkLoad;
        ASSETS.goal.onload = checkLoad;
        ASSETS.alien.onload = checkLoad;
        ASSETS.malaysian.onload = checkLoad;

        // Physics Objects
        let ball = { x: 0, y: 0, z: 0, vx: 0, vy: 0, vz: 0, state: 'idle' }; // idle, moving, scored, missed
        let keeper = { x: 0, targetX: 0, speed: 0.05, width: 100, type: 'alien' }; // Slower speed logic in update
        let goalDim = { x: 0, y: 0, w: 0, h: 0, depth: 400 };

        // Helper
        const perspective = 800;
        function project(x, y, z) {
            const scale = perspective / (perspective + z);
            return {
                x: width / 2 + x * scale,
                y: height / 2 + y * scale,
                scale: scale
            };
        }

        // --- RESIZE ---
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;

            // Setup  Goal Dimensions (Fixed Aspect Ratio)
            const goalScale = Math.min(width * 0.6, height * 0.45);
            goalDim.w = goalScale;
            goalDim.h = goalScale * 0.7; // Better aspect for goal_v3.png
            goalDim.y = height * 0.15; // Position higher for better visibility
        }
        window.addEventListener('resize', resize);
        resize();

        // --- INPUT (FULL DIRECTIONAL CONTROL - 9 ZONES) ---
        function handleInput(clientX, clientY) {
            if (gameState !== 'PLAYING' || ball.state !== 'idle') return;

            // Normalize click position to -1 to 1 range
            const normalizedX = (clientX / width - 0.5) * 4;  // -1 (left) to 1 (right)
            const normalizedY = (clientY / height - 0.5) * 8; // -1 (top) to 1 (bottom)

            // HORIZONTAL CONTROL (Left/Center/Right)
            // Determines side direction of ball
            const horizontalSpeed = 18;
            ball.vx = normalizedX * horizontalSpeed;

            // VERTICAL CONTROL (High/Middle/Low)
            // Top of screen = CHIP SHOT (high arc, floaty)
            // Middle = BALANCED SHOT
            // Bottom = POWER SHOT (low, fast)

            // Map Y position to arc height
            // Top clicks (-1) -> High arc (-15 initial vy)
            // Bottom clicks (1) -> Low arc (-4 initial vy)
            const minArc = -4;  // Power shot (low)
            const maxArc = -15; // Chip shot (high)
            ball.vy = minArc + (maxArc - minArc) * ((1 - normalizedY) / 2);

            // FORWARD SPEED
            // Higher shots = slower forward (easier to save)
            // Lower shots = faster forward (harder to save)
            const minSpeed = 22;  // Chip shot speed
            const maxSpeed = 35;  // Power shot speed
            ball.vz = minSpeed + (maxSpeed - minSpeed) * ((normalizedY + 1) / 2);

            ball.state = 'moving';

            // Particle effect at ball
            const pBall = project(ball.x, ball.y, ball.z);
            spawnParticles(pBall.x, pBall.y, 20, '#FFF', 2);

            // Show shot type feedback
            let shotType = '';
            if (normalizedY < -0.3) shotType = 'CHIP SHOT!';
            else if (normalizedY > 0.3) shotType = 'POWER SHOT!';
            else shotType = 'BALANCED!';

            if (Math.abs(normalizedX) < 0.2) shotType += ' CENTER';
            else if (normalizedX < 0) shotType += ' LEFT';
            else shotType += ' RIGHT';

            spawnPopup(shotType, '#FFD700');
        }

        // Global Event Listener (Interactive Wall)
        canvas.addEventListener('mousedown', e => handleInput(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', e => {
            e.preventDefault();
            handleInput(e.touches[0].clientX, e.touches[0].clientY);
        });

        // --- PARTICLES ---
        class Particle {
            constructor(x, y, color, speedScale = 1) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 10 * speedScale;
                this.vy = (Math.random() - 1) * 10 * speedScale;
                this.life = 1.0;
                this.color = color;
                this.size = Math.random() * 5 + 2;
                this.gravity = 0.5;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += this.gravity;
                this.life -= 0.03;
            }
            draw(ctx) {
                ctx.globalAlpha = Math.max(0, this.life);
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalAlpha = 1;
            }
        }

        function spawnParticles(x, y, count, color, speed) {
            for (let i = 0; i < count; i++) particles.push(new Particle(x, y, color, speed));
        }

        function spawnPopup(text, color) {
            popups.push({ text, color, life: 1.0, y: height / 2 });
        }

        // --- LOGIC ---
        function startGame(players) {
            numPlayers = players;
            maxRounds = numPlayers === 1 ? 10 : 5;
            currentRound = 1;
            currentPlayer = 1;
            p1Score = 0;
            p2Score = 0;
            p1Goals = 0;
            p2Goals = 0;

            gameState = 'PLAYING';
            document.getElementById('menuOverlay').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');

            // Show player indicator for 2P
            if (numPlayers === 2) {
                document.getElementById('playerIndicator').classList.remove('hidden');
                document.getElementById('playerText').textContent = 'PLAYER 1';
            }

            updateHUD();
            resetBall();
            spawnPopup("CLICK LEFT OR RIGHT!", "#FFF");
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function updateHUD() {
            const roundText = numPlayers === 1
                ? `ROUND ${currentRound}/${maxRounds}`
                : `P${currentPlayer}: R${currentRound}/${maxRounds}`;
            document.getElementById('roundDisplay').textContent = roundText;

            const currentScore = currentPlayer === 1 ? p1Score : p2Score;
            document.getElementById('scoreDisplay').textContent = currentScore;
        }

        function returnToMenu() {
            gameState = 'MENU';
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('menuOverlay').classList.remove('hidden');
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('resultScreen').classList.add('hidden');
            document.getElementById('turnScreen').classList.add('hidden');
        }

        function startPlayerTurn() {
            document.getElementById('menuOverlay').classList.add('hidden'); // Fix: Remove dark overlay
            document.getElementById('turnScreen').classList.add('hidden');
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('playerText').textContent = `PLAYER ${currentPlayer}`;
            gameState = 'PLAYING';
            currentRound = 1;
            updateHUD();
            resetBall();
            spawnPopup('YOUR TURN!', '#FFF');
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }

        function resetBall() {
            ball = { x: 0, y: 150, z: -350, vx: 0, vy: 0, vz: 0, state: 'idle' };
        }

        function nextRound() {
            currentRound++;

            // Check if this player finished all rounds
            if (currentRound > maxRounds) {
                if (numPlayers === 2 && currentPlayer === 1) {
                    // Switch to Player 2
                    currentPlayer = 2;
                    gameState = 'TURN_SWITCH';
                    document.getElementById('hud').classList.add('hidden');
                    document.getElementById('menuOverlay').classList.remove('hidden');
                    document.getElementById('mainMenu').classList.add('hidden');
                    document.getElementById('turnScreen').classList.remove('hidden');
                    document.getElementById('turnTitle').textContent = 'PLAYER 2 READY?';
                    document.getElementById('turnScore').textContent = `Player 1 Score: ${p1Score} (${p1Goals} goals)`;
                } else {
                    // Game over
                    endGame();
                }
            } else {
                // Next round for same player
                updateHUD();
                resetBall();
                setTimeout(() => {
                    if (gameState === 'PLAYING') {
                        spawnPopup(`ROUND ${currentRound}!`, '#FFF');
                    }
                }, 500);
            }
        }

        function update(dt) {
            // No timer - rounds-based now!

            // Goalkeeper AI (Reactive)
            const limit = 400; // movement range

            // AI LOGIC:
            if (ball.state === 'moving' && ball.z < 300) {
                // If ball is coming, try to intercept!
                // Alien tries to match ball X position
                keeper.targetX = ball.x;

                // Add some human error (random offset) so he's not perfect
                // keeper.targetX += (Math.random() - 0.5) * 50; 

                // Clamp to limit
                if (keeper.targetX > limit) keeper.targetX = limit;
                if (keeper.targetX < -limit) keeper.targetX = -limit;

                // USER: ADJUST ALIEN SPEED HERE (Lower = Slower, Higher = Faster)
                // Was 0.08, Increased to 0.15 for harder difficulty
                keeper.x += (keeper.targetX - keeper.x) * 0.15; // Reaction speed
            } else {
                // Idle random movement when ball is waiting
                if (Math.abs(keeper.x - keeper.targetX) < 10) {
                    if (Math.random() > 0.5) keeper.targetX = 0;
                    else keeper.targetX = (Math.random() - 0.5) * limit;
                }
                keeper.x += (keeper.targetX - keeper.x) * 0.05;
            }



            // Ball Physics
            if (ball.state === 'moving') {
                ball.x += ball.vx;
                ball.y += ball.vy;
                ball.z += ball.vz;
                ball.vy += 0.5; // Gravity

                // Ground Bounce
                if (ball.y > 200) { // arbitrary floor plane
                    ball.y = 200;
                    ball.vy *= -0.6;
                    ball.vx *= 0.9;
                }

                // Goal Check
                if (ball.z > 300 && ball.z < 350) { // Passing goal line
                    // Dimensions check
                    // VISUAL FIX: Widen detection to 290 (Total 580) to match visual goal width of 600
                    if (Math.abs(ball.x) < 1000 && ball.y < 1000 && ball.y > -1000) {

                        // Keeper Collision (SAVE)
                        // USER: ADJUST CATCH RADIUS HERE (Larger = Easier for Alien to save)
                        // Was 90, Increased to 120 for harder difficulty
                        if (Math.abs(ball.x - keeper.x) < 120) { // Hit Keeper! (Hitbox size)
                            ball.vx *= -1;
                            ball.vz *= -0.5;
                            ball.state = 'missed';
                            spawnParticles(width / 2 + ball.x, height / 2 + ball.y, 20, '#F00', 3);
                            spawnPopup(getRandomPhrase(BLOCK_PHRASES), "#EF4444"); // Lawak Bodo text
                            setTimeout(nextRound, 1500);
                        } else {
                            // GOAL!
                            if (currentPlayer === 1) {
                                p1Score += 100;
                                p1Goals++;
                            } else {
                                p2Score += 100;
                                p2Goals++;
                            }
                            updateHUD();
                            ball.state = 'scored';
                            spawnParticles(width / 2 + ball.x, height / 2 + ball.y, 30, '#FFD700', 4);
                            spawnPopup(getRandomPhrase(GOAL_PHRASES), "#FBBF24"); // Noob text
                            setTimeout(nextRound, 1500);
                        }
                    } else if (ball.z > 400) {
                        // Missed completely
                        ball.state = 'missed';
                        spawnPopup("MISS!", "#FFF");
                        setTimeout(nextRound, 1500);
                    }
                }

                // Far out bounds
                if (ball.z > 600) {
                    ball.state = 'missed';
                    setTimeout(nextRound, 1000);
                }
            }

            // Particles
            particles.forEach(p => p.update());
            particles = particles.filter(p => p.life > 0);
            popups.forEach(p => { p.life -= 0.02; p.y -= 1; });
            popups = popups.filter(p => p.life > 0);
        }

        function render() {
            ctx.clearRect(0, 0, width, height);

            // 1. STADIUM BACKGROUND WITH GOAL
            if (ASSETS.stadium.complete) {
                ctx.drawImage(ASSETS.stadium, 0, 0, width, height);
            } else {
                ctx.fillStyle = '#111'; ctx.fillRect(0, 0, width, height);
            }

            // 2. FIELD GRADIENT OVERLAY (subtle, for depth)
            const horizonY = height * 0.6; // Lower to avoid covering goal
            const grad = ctx.createLinearGradient(0, horizonY, 0, height);
            grad.addColorStop(0, 'rgba(15,46,15,0)'); // Transparent at horizon
            grad.addColorStop(0.5, 'rgba(26,74,26,0.3)');
            grad.addColorStop(1, 'rgba(46,125,50,0.5)'); // Semi-transparent green close
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.moveTo(0, horizonY);
            ctx.lineTo(width, horizonY);
            ctx.lineTo(width, height);
            ctx.lineTo(0, height);
            ctx.fill();

            // 3. NO GOAL OVERLAY - using background image instead
            const goalZ = 350; // Goal line position for collision/rendering

            // 4. KEEPER (Alien) - Moved forward for better visibility
            const pKeeper = project(keeper.x, 200, goalZ - 60); // Further in front
            if (ASSETS.alien.complete) {
                // USER: ADJUST ALIEN SIZE HERE
                // Increase the '140' for width and '200' for height to make bigger
                const kw = 500 * pKeeper.scale; // Width (was 140)
                const kh = 500 * pKeeper.scale; // Height (was 200)

                // Shadow
                ctx.fillStyle = 'rgba(0,0,0,0.4)';
                ctx.beginPath();
                ctx.ellipse(pKeeper.x, pKeeper.y, kw / 2, kw / 5, 0, 0, Math.PI * 2);
                ctx.fill();

                ctx.drawImage(ASSETS.alien, pKeeper.x - kw / 2, pKeeper.y - kh, kw, kh);
            }

            // 5. BALL
            const pBall = project(ball.x, ball.y, ball.z);
            const size = 40 * pBall.scale;

            // Ball Shadow
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            // Project shadow on ground (y=200)
            const pShadow = project(ball.x, 200, ball.z);
            const sSize = 30 * pShadow.scale;
            ctx.ellipse(pShadow.x, pShadow.y, sSize, sSize / 2, 0, 0, Math.PI * 2);
            ctx.fill();

            // Draw Ball (Image with Fallback)
            if (ASSETS.ball.complete && ASSETS.ball.naturalWidth !== 0) {
                ctx.drawImage(ASSETS.ball, pBall.x - size, pBall.y - size, size * 2, size * 2);
            } else {
                // FALLBACK: White circle if image not found
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(pBall.x, pBall.y, size, 0, Math.PI * 2);
                ctx.fill();
                // Shading detail
                ctx.fillStyle = '#ddd';
                ctx.beginPath();
                ctx.arc(pBall.x - size * 0.5, pBall.y - size * 0.5, size * 0.2, 0, Math.PI * 2);
                ctx.fill();
            }

            // 6. PARTICLES & POPUPS
            particles.forEach(p => p.draw(ctx));
            popups.forEach(p => {
                ctx.font = "900 80px Fredoka"; // Larger for projection
                ctx.fillStyle = p.color;
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 6;
                ctx.textAlign = 'center';
                ctx.globalAlpha = p.life;
                ctx.strokeText(p.text, width / 2, p.y);
                ctx.fillText(p.text, width / 2, p.y);
                ctx.globalAlpha = 1;
            });
        }

        function endGame() {
            gameState = 'RESULT';
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('menuOverlay').classList.remove('hidden');
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');

            if (numPlayers === 1) {
                // Single player result
                document.getElementById('singlePlayerResult').classList.remove('hidden');
                document.getElementById('twoPlayerResult').classList.add('hidden');
                document.getElementById('goalsScored').textContent = `${p1Goals}/${maxRounds}`;
                document.getElementById('finalScore').textContent = p1Score;
            } else {
                // Two player result
                document.getElementById('singlePlayerResult').classList.add('hidden');
                document.getElementById('twoPlayerResult').classList.remove('hidden');
                document.getElementById('p1FinalScore').textContent = p1Score;
                document.getElementById('p2FinalScore').textContent = p2Score;

                if (p1Score > p2Score) {
                    document.getElementById('winnerText').textContent = 'PLAYER 1 WINS!';
                } else if (p2Score > p1Score) {
                    document.getElementById('winnerText').textContent = 'PLAYER 2 WINS!';
                } else {
                    document.getElementById('winnerText').textContent = "IT'S A TIE!";
                }
            }
        }

        let lastTime = 0;
        function gameLoop(timestamp) {
            if (gameState !== 'PLAYING') return;
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;

            update(dt);
            render();
            requestAnimationFrame(gameLoop);
        }

        // Initial Render
        // ASSETS.stadium.onload handled by checkLoad
    </script>
</body>

</html>