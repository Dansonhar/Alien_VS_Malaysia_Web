<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sepak Salah, Alien Marah! - Aliens vs Malaysians</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'fredoka': ['Fredoka', 'sans-serif'] },
                    colors: { 'sambal': '#FF5252', 'durian': '#FFD600', 'pandan': '#00E676' }
                }
            }
        }
    </script>
    <style>
        .ball-fly {
            animation: ballFly 0.4s ease-out forwards;
        }

        @keyframes ballFly {
            0% {
                transform: scale(1) rotate(0deg);
            }

            50% {
                transform: scale(1.2) rotate(180deg);
            }

            100% {
                transform: scale(0.9) rotate(360deg);
            }
        }

        .alien-hit {
            animation: alienHit 0.5s ease-out forwards;
        }

        @keyframes alienHit {
            0% {
                transform: translateY(0) scale(1);
            }

            30% {
                transform: translateY(-30px) scale(1.1);
            }

            100% {
                transform: translateY(80px) scale(0.8);
                opacity: 0;
            }
        }

        .wrong-hit {
            animation: wrongHit 0.5s ease-out;
        }

        @keyframes wrongHit {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-15deg);
            }

            75% {
                transform: rotate(15deg);
            }
        }

        .ufo-hover {
            animation: ufoHover 2s ease-in-out infinite;
        }

        @keyframes ufoHover {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-15px);
            }
        }

        .portal-pulse {
            animation: portalPulse 1.5s ease-in-out infinite;
        }

        @keyframes portalPulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.8;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .combo-text {
            animation: comboFloat 1s ease-out forwards;
        }

        @keyframes comboFloat {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            100% {
                transform: translateY(-80px) scale(1.5);
                opacity: 0;
            }
        }

        .aiyo-popup {
            animation: aiyoShake 0.8s ease-out forwards;
        }

        @keyframes aiyoShake {
            0% {
                transform: scale(0) rotate(-10deg);
            }

            20% {
                transform: scale(1.2) rotate(5deg);
            }

            40% {
                transform: scale(1) rotate(-5deg);
            }

            60% {
                transform: scale(1.1) rotate(3deg);
            }

            80% {
                transform: scale(1) rotate(-2deg);
            }

            100% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
        }

        .winner-bounce {
            animation: winnerBounce 0.5s ease-out forwards, winnerGlow 1s ease-in-out infinite 0.5s;
        }

        @keyframes winnerBounce {
            0% {
                transform: scale(0) rotate(-10deg);
            }

            50% {
                transform: scale(1.3) rotate(5deg);
            }

            100% {
                transform: scale(1) rotate(0deg);
            }
        }

        @keyframes winnerGlow {

            0%,
            100% {
                filter: drop-shadow(0 0 20px gold);
            }

            50% {
                filter: drop-shadow(0 0 40px gold) drop-shadow(0 0 60px orange);
            }
        }

        .confetti {
            position: fixed;
            pointer-events: none;
            animation: confettiFall 3s linear forwards;
        }

        @keyframes confettiFall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .pulse-text {
            animation: pulseText 1s ease-in-out infinite;
        }

        @keyframes pulseText {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.9;
            }

            50% {
                transform: scale(1.05);
                opacity: 1;
            }
        }
    </style>
</head>

<body
    class="font-fredoka bg-gradient-to-b from-green-600 via-green-500 to-emerald-400 min-h-screen overflow-hidden touch-none select-none">

    <!-- Game Canvas -->
    <canvas id="gameCanvas" class="block w-full h-screen"></canvas>

    <!-- HUD -->
    <div id="hud" class="hidden fixed inset-0 pointer-events-none z-50">
        <div class="absolute top-4 left-1/2 -translate-x-1/2 flex gap-4 flex-wrap justify-center">
            <div
                class="bg-white/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg">
                ‚è±Ô∏è <span id="timer" class="text-sambal">40</span>s
            </div>
            <div id="p1ScoreBox"
                class="bg-pandan/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg">
                P1: <span id="p1Score">0</span>
            </div>
            <div id="p2ScoreBox"
                class="hidden bg-orange-500/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg text-white">
                P2: <span id="p2Score">0</span>
            </div>
            <div id="comboBox"
                class="hidden bg-durian/90 px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] font-bold text-lg">
                üî• <span id="comboCount">0</span>x
            </div>
        </div>
        <div class="absolute top-16 left-1/2 -translate-x-1/2">
            <div id="difficultyBadge" class="bg-pandan px-4 py-1 rounded-full border-2 border-black font-bold text-sm">
                EASY</div>
        </div>
    </div>

    <!-- Countdown Overlay -->
    <div id="countdown"
        class="hidden fixed inset-0 flex items-center justify-center z-[80] bg-black/70 pointer-events-none">
        <div id="countdownText" class="text-9xl font-bold text-white drop-shadow-[0_8px_0_#000]">3</div>
    </div>

    <!-- Main Menu -->
    <div id="mainMenu"
        class="fixed inset-0 bg-gradient-to-b from-green-800 to-emerald-900 flex flex-col items-center justify-center z-[100] text-center px-4">
        <div class="text-8xl mb-4 animate-bounce">‚öΩ</div>
        <h1 class="text-4xl md:text-6xl font-bold text-pandan drop-shadow-[0_6px_0_#000] mb-2">
            SEPAK SALAH,<br>ALIEN MARAH!
        </h1>
        <p class="text-white text-xl mb-2 max-w-md">"Kick the ball. Miss the alien.<br>Kick the wrong thing ‚Äî everyone
            judge you."</p>
        <p class="text-green-300 text-lg mb-6">Kick footballs at aliens!</p>

        <!-- Difficulty Selection -->
        <div class="flex gap-2 mb-6">
            <button onclick="setDifficulty('easy')" id="btnEasy"
                class="bg-pandan text-black font-bold px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] transition-all">EASY</button>
            <button onclick="setDifficulty('normal')" id="btnNormal"
                class="bg-durian text-black font-bold px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] transition-all opacity-60">NORMAL</button>
            <button onclick="setDifficulty('hard')" id="btnHard"
                class="bg-sambal text-white font-bold px-4 py-2 rounded-full border-4 border-black shadow-[4px_4px_0_#000] transition-all opacity-60">HARD</button>
        </div>

        <button onclick="startGame(1)"
            class="bg-pandan text-black font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#2E7D32] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#2E7D32] transition-all mb-4 w-72">
            üë§ 1 PLAYER
        </button>

        <button onclick="startGame(2)"
            class="bg-durian text-black font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#B8860B] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#B8860B] transition-all w-72">
            üë• 2 PLAYER (TURN)
        </button>
    </div>

    <!-- Player Ready Screen -->
    <div id="playerReadyScreen"
        class="hidden fixed inset-0 bg-gradient-to-b from-green-800 to-emerald-900 flex flex-col items-center justify-center z-[90] text-center px-4">
        <div id="playerReadyIcon" class="text-9xl mb-4 pulse-text">‚öΩ</div>
        <h1 id="playerReadyText"
            class="text-5xl md:text-7xl font-bold text-pandan drop-shadow-[0_6px_0_#000] mb-4 pulse-text">
            PLAYER 1 READY?
        </h1>
        <p class="text-white text-2xl">Get ready to kick some aliens!</p>
    </div>

    <!-- Score Reveal Screen -->
    <div id="scoreRevealScreen"
        class="hidden fixed inset-0 bg-black/95 flex flex-col items-center justify-center z-[95] text-center px-4">
        <div id="confettiContainer"></div>
        <h2 id="scoreRevealTitle" class="text-4xl md:text-5xl font-bold text-pandan drop-shadow-[0_4px_0_#000] mb-4">
            PLAYER 1 SCORED
        </h2>
        <div id="scoreRevealNumber" class="text-8xl md:text-9xl font-bold text-durian drop-shadow-[0_8px_0_#000] mb-8">
            0
        </div>
        <p class="text-white text-xl animate-pulse">Tap to continue...</p>
    </div>

    <!-- Winner Screen -->
    <div id="winnerScreen"
        class="hidden fixed inset-0 bg-gradient-to-b from-green-800 via-black to-emerald-900 flex flex-col items-center justify-center z-[100] text-center px-4">
        <div id="winnerConfettiContainer"></div>
        <div class="text-9xl mb-4 winner-bounce">üèÜ</div>
        <h1 id="winnerTitle"
            class="text-4xl md:text-6xl font-bold text-pandan drop-shadow-[0_6px_0_#000] mb-2 winner-bounce">
            WHO MORE POWER?
        </h1>
        <h2 id="winnerSubtitle" class="text-3xl md:text-5xl font-bold text-durian drop-shadow-[0_4px_0_#000] mb-8"></h2>
        <div class="flex gap-8 justify-center mb-8">
            <div class="text-center">
                <div class="text-pandan font-bold text-2xl">Player 1</div>
                <div id="winnerP1Score" class="text-5xl font-bold text-white drop-shadow-[0_4px_0_#000]">0</div>
            </div>
            <div class="text-6xl font-bold text-white">VS</div>
            <div class="text-center">
                <div class="text-orange-400 font-bold text-2xl">Player 2</div>
                <div id="winnerP2Score" class="text-5xl font-bold text-white drop-shadow-[0_4px_0_#000]">0</div>
            </div>
        </div>
        <div class="flex flex-col gap-4">
            <button onclick="rematch()"
                class="bg-pandan text-black font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#2E7D32] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#2E7D32] transition-all">
                üî• FIGHT AGAIN!
            </button>
            <button onclick="returnToMainMenu()"
                class="bg-gray-600 text-white font-bold text-xl px-8 py-3 rounded-full border-4 border-black shadow-[0_6px_0_#374151] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_3px_0_#374151] transition-all">
                üè† MAIN MENU
            </button>
        </div>
    </div>

    <!-- End Screen (Single Player) -->
    <div id="endScreen"
        class="hidden fixed inset-0 bg-black/90 flex flex-col items-center justify-center z-[100] text-center px-4">
        <div class="text-8xl mb-4">‚öΩ</div>
        <h1 class="text-5xl md:text-6xl font-bold text-pandan drop-shadow-[0_4px_0_#000] mb-4">
            TIME'S UP!
        </h1>
        <p class="text-white text-xl mb-2">Final Score:</p>
        <div id="finalScore" class="text-6xl font-bold text-durian drop-shadow-[0_4px_0_#000] mb-8">0</div>
        <button onclick="location.reload()"
            class="bg-pandan text-black font-bold text-2xl px-12 py-4 rounded-full border-4 border-black shadow-[0_8px_0_#2E7D32] hover:-translate-y-1 active:translate-y-1 active:shadow-[0_4px_0_#2E7D32] transition-all">
            PLAY AGAIN
        </button>
        <button onclick="window.location.href='../'"
            class="mt-4 bg-gray-600 text-white font-bold px-6 py-2 rounded-full border-2 border-black">
            BACK TO HUB
        </button>
    </div>

    <!-- Back Button -->
    <button onclick="handleBackButton()"
        class="fixed bottom-4 left-4 z-[200] bg-red-500 hover:bg-red-600 text-white font-bold px-6 py-3 rounded-xl border-4 border-black shadow-[4px_4px_0_#000] hover:shadow-[2px_2px_0_#000] hover:translate-y-[2px] transition-all flex items-center gap-2 pointer-events-auto">
        <span class="text-2xl">üîô</span> MENU
    </button>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // Game State
        let gameRunning = false;
        let numPlayers = 1;
        let currentPlayer = 1;
        let p1Score = 0;
        let p2Score = 0;
        let timeRemaining = 40;
        let gameTimer = null;
        let difficulty = 'easy';
        let gamePhase = 'menu';
        let combo = 0;

        // Game Objects
        let targets = [];
        let footballs = [];
        let particles = [];
        let popups = [];
        let ufos = [];
        let portals = [];
        let frameCount = 0;

        // Asset paths
        const ASSETS = {
            alienNormal: '../assets/alien_normal.png',
            alienHelmet: '../assets/alien_helmet.png',
            alienHit: '../assets/alien_hit.png',
            durian: '../assets/durian.png', // Not used but available
            malaysianMale: '../assets/malaysian_male.png',
            malaysianFemale: '../assets/malaysian_female.png'
        };

        // Preload images
        const images = {};
        let imagesLoaded = 0;

        Object.entries(ASSETS).forEach(([key, src]) => {
            const img = new Image();
            img.onload = () => { imagesLoaded++; };
            img.onerror = () => { imagesLoaded++; console.log('Asset not found:', src); };
            img.src = src;
            images[key] = img;
        });

        // Difficulty Settings
        const difficultySettings = {
            easy: { spawnRate: 80, wrongChance: 0, swapChance: 0, ufoMoves: false, time: 45 },
            normal: { spawnRate: 60, wrongChance: 0.25, swapChance: 0, ufoMoves: false, time: 40 },
            hard: { spawnRate: 45, wrongChance: 0.4, swapChance: 0.3, ufoMoves: true, time: 35 }
        };

        // Wrong target types
        const wrongTargetTypes = ['cone', 'dustbin', 'pakcik'];

        function setDifficulty(diff) {
            difficulty = diff;
            document.getElementById('btnEasy').classList.toggle('opacity-60', diff !== 'easy');
            document.getElementById('btnNormal').classList.toggle('opacity-60', diff !== 'normal');
            document.getElementById('btnHard').classList.toggle('opacity-60', diff !== 'hard');
        }

        function handleBackButton() {
            if (gamePhase === 'menu') {
                window.location.href = '../';
            } else {
                returnToMainMenu();
            }
        }

        function returnToMainMenu() {
            gameRunning = false;
            clearInterval(gameTimer);
            gamePhase = 'menu';
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('endScreen').classList.add('hidden');
            document.getElementById('winnerScreen').classList.add('hidden');
            document.getElementById('scoreRevealScreen').classList.add('hidden');
            document.getElementById('playerReadyScreen').classList.add('hidden');
            targets = [];
            footballs = [];
            particles = [];
            ufos = [];
            portals = [];
        }

        // Target Class (Alien or Wrong Target)
        class Target {
            constructor(fromPortal = false) {
                const settings = difficultySettings[difficulty];
                this.isWrong = Math.random() < settings.wrongChance;
                this.wrongType = this.isWrong ? wrongTargetTypes[Math.floor(Math.random() * wrongTargetTypes.length)] : null;
                this.size = 70;

                if (fromPortal && portals.length > 0) {
                    const portal = portals[Math.floor(Math.random() * portals.length)];
                    this.x = portal.x;
                    this.y = portal.y;
                } else {
                    this.x = Math.random() * (width - 200) + 100;
                    this.y = Math.random() * (height * 0.5) + 80;
                }

                this.vx = (Math.random() - 0.5) * 2;
                this.vy = (Math.random() - 0.5) * 1;
                this.state = 'active';
                this.animTimer = 0;
                this.wobble = Math.random() * Math.PI * 2;
                this.life = 180; // 3 seconds at 60fps
                this.hue = this.isWrong ? 0 : 120;
            }

            update() {
                if (this.state === 'active') {
                    const settings = difficultySettings[difficulty];
                    this.wobble += 0.08;
                    this.x += this.vx + Math.sin(this.wobble) * 0.5;
                    this.y += this.vy + Math.cos(this.wobble) * 0.3;

                    // Hard mode: swap positions
                    if (settings.swapChance > 0 && Math.random() < 0.005) {
                        this.x = Math.random() * (width - 200) + 100;
                        this.y = Math.random() * (height * 0.5) + 80;
                    }

                    // Keep in bounds
                    if (this.x < 50) { this.x = 50; this.vx *= -1; }
                    if (this.x > width - 50) { this.x = width - 50; this.vx *= -1; }
                    if (this.y < 80) { this.y = 80; this.vy *= -1; }
                    if (this.y > height * 0.55) { this.y = height * 0.55; this.vy *= -1; }

                    this.life--;
                    if (this.life <= 0) return false;
                } else {
                    this.animTimer++;
                    if (this.animTimer > 40) return false;
                }
                return true;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);

                if (this.state === 'hit') {
                    const progress = this.animTimer / 40;
                    ctx.translate(0, progress * 60);
                    ctx.scale(1 - progress * 0.3, 1 - progress * 0.3);
                    ctx.globalAlpha = 1 - progress;
                } else if (this.state === 'wrong') {
                    ctx.rotate(Math.sin(this.animTimer * 0.5) * 0.3);
                }

                if (this.isWrong) {
                    this.drawWrongTarget();
                } else {
                    this.drawAlien();
                }

                ctx.restore();
            }

            drawAlien() {
                let img = images.alienNormal;
                if (this.state === 'hit') img = images.alienHit;
                // Add helmet logic if applicable, but Sepak Salah currently assumes non-helmeted aliens mostly or uses generic Target class.
                // If I want to add variety:
                if (Math.random() < 0.3) img = images.alienHelmet;
                // Wait, random in draw() causes flashing. Need property.
                // The current Target doesn't track helmet. Let's strictly use normal/hit for now.

                // Better logic:
                img = (this.state === 'hit' || this.state === 'wrong') ? images.alienHit : images.alienNormal;
                // Wrong targets (cone etc) are handled in drawWrongTarget, so this is only for Real Aliens.

                if (img && img.complete && img.naturalWidth > 0) {
                    ctx.drawImage(img, -this.size / 2, -this.size / 2, this.size, this.size);
                } else {
                    this.drawAlienFallback();
                }
            }

            drawAlienFallback() {
                // Body
                ctx.fillStyle = `hsl(${this.hue}, 70%, 50%)`;
                ctx.beginPath();
                ctx.ellipse(0, 0, this.size / 2, this.size / 2 * 0.85, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.stroke();

                // Eyes
                ctx.fillStyle = '#FFF';
                ctx.beginPath();
                ctx.ellipse(-12, -8, 12, 15, 0, 0, Math.PI * 2);
                ctx.ellipse(12, -8, 12, 15, 0, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(-12 + Math.sin(frameCount * 0.05) * 3, -8, 5, 0, Math.PI * 2);
                ctx.arc(12 + Math.sin(frameCount * 0.05) * 3, -8, 5, 0, Math.PI * 2);
                ctx.fill();

                // Scared mouth
                ctx.beginPath();
                ctx.ellipse(0, 12, 10, 12, 0, 0, Math.PI * 2);
                ctx.fill();

                // Antennae
                ctx.strokeStyle = `hsl(${this.hue}, 70%, 40%)`;
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(-15, -this.size * 0.4);
                ctx.quadraticCurveTo(-20, -this.size * 0.6, -10, -this.size * 0.65);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(15, -this.size * 0.4);
                ctx.quadraticCurveTo(20, -this.size * 0.6, 10, -this.size * 0.65);
                ctx.stroke();

                ctx.fillStyle = '#FFD600';
                ctx.beginPath();
                ctx.arc(-10, -this.size * 0.65, 6, 0, Math.PI * 2);
                ctx.arc(10, -this.size * 0.65, 6, 0, Math.PI * 2);
                ctx.fill();
            }

            drawWrongTarget() {
                if (this.wrongType === 'cone') {
                    // Traffic cone
                    ctx.fillStyle = '#FF6B00';
                    ctx.beginPath();
                    ctx.moveTo(-25, 30);
                    ctx.lineTo(-10, -25);
                    ctx.lineTo(10, -25);
                    ctx.lineTo(25, 30);
                    ctx.closePath();
                    ctx.fill();
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // White stripes
                    ctx.fillStyle = '#FFF';
                    ctx.fillRect(-18, 0, 36, 8);
                    ctx.fillRect(-14, -15, 28, 6);
                } else if (this.wrongType === 'dustbin') {
                    // Dustbin
                    ctx.fillStyle = '#4CAF50';
                    ctx.beginPath();
                    ctx.moveTo(-25, 35);
                    ctx.lineTo(-20, -20);
                    ctx.lineTo(20, -20);
                    ctx.lineTo(25, 35);
                    ctx.closePath();
                    ctx.fill();
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    // Lid
                    ctx.fillStyle = '#388E3C';
                    ctx.fillRect(-22, -25, 44, 8);
                    ctx.strokeRect(-22, -25, 44, 8);

                    // Handle
                    ctx.beginPath();
                    ctx.arc(0, -28, 8, Math.PI, 0);
                    ctx.stroke();
                } else if (this.wrongType === 'pakcik') {
                    // Pak Cik cardboard cutout
                    ctx.fillStyle = '#D7CCC8';
                    ctx.fillRect(-30, -40, 60, 80);
                    ctx.strokeStyle = '#795548';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(-30, -40, 60, 80);

                    // Face
                    ctx.fillStyle = '#FFCC80';
                    ctx.beginPath();
                    ctx.arc(0, -15, 20, 0, Math.PI * 2);
                    ctx.fill();

                    // Eyes
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(-8, -18, 3, 0, Math.PI * 2);
                    ctx.arc(8, -18, 3, 0, Math.PI * 2);
                    ctx.fill();

                    // Smile
                    ctx.beginPath();
                    ctx.arc(0, -10, 8, 0.1, Math.PI - 0.1);
                    ctx.stroke();

                    // Songkok
                    ctx.fillStyle = '#000';
                    ctx.fillRect(-15, -38, 30, 15);

                    // Body
                    ctx.fillStyle = '#4DB6AC';
                    ctx.fillRect(-20, 5, 40, 35);
                }
            }

            hit(isWrongHit) {
                this.state = isWrongHit ? 'wrong' : 'hit';
                this.animTimer = 0;
            }
        }

        // Football Class
        class Football {
            constructor(startX, startY, targetX, targetY) {
                this.x = startX;
                this.y = startY;
                this.size = 30;
                this.rotation = 0;
                this.speed = 18;

                const dx = targetX - startX;
                const dy = targetY - startY;
                const dist = Math.sqrt(dx * dx + dy * dy);
                this.vx = (dx / dist) * this.speed;
                this.vy = (dy / dist) * this.speed;

                // On hard mode, sometimes ball curves
                if (difficulty === 'hard' && Math.random() < 0.2) {
                    this.curve = (Math.random() - 0.5) * 0.5;
                } else {
                    this.curve = 0;
                }

                this.life = 50;
                this.hasHit = false;
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vx += this.curve;
                this.rotation += 0.4;
                this.life--;
                return this.life > 0 && !this.hasHit;
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);

                // Football
                ctx.fillStyle = '#FFF';
                ctx.beginPath();
                ctx.arc(0, 0, this.size / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Pentagon pattern
                ctx.fillStyle = '#000';
                for (let i = 0; i < 5; i++) {
                    const angle = (i / 5) * Math.PI * 2 - Math.PI / 2;
                    const px = Math.cos(angle) * 8;
                    const py = Math.sin(angle) * 8;
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(px, py);
                    ctx.lineTo(Math.cos(angle + Math.PI / 5) * 8, Math.sin(angle + Math.PI / 5) * 8);
                    ctx.closePath();
                    ctx.fill();
                }

                ctx.restore();
            }

            checkCollision(target) {
                const dx = this.x - target.x;
                const dy = this.y - target.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                return dist < (this.size / 2 + target.size / 2);
            }
        }

        // UFO Spawner
        class UFO {
            constructor() {
                this.x = Math.random() * (width - 200) + 100;
                this.y = 60;
                this.size = 80;
                this.doorOpen = false;
                this.doorTimer = 0;
                this.baseX = this.x;
            }

            update() {
                const settings = difficultySettings[difficulty];
                if (settings.ufoMoves) {
                    this.x = this.baseX + Math.sin(frameCount * 0.02) * 100;
                }

                this.doorTimer++;
                if (this.doorTimer > 120) {
                    this.doorOpen = !this.doorOpen;
                    this.doorTimer = 0;
                    if (this.doorOpen && gameRunning) {
                        // Spawn alien from UFO
                        const target = new Target(false);
                        target.x = this.x;
                        target.y = this.y + 40;
                        targets.push(target);
                    }
                }
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);

                // UFO body
                ctx.fillStyle = '#9E9E9E';
                ctx.beginPath();
                ctx.ellipse(0, 0, this.size / 2, this.size / 4, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#616161';
                ctx.lineWidth = 3;
                ctx.stroke();

                // Dome
                ctx.fillStyle = '#64B5F6';
                ctx.beginPath();
                ctx.ellipse(0, -10, 25, 20, 0, Math.PI, 0);
                ctx.fill();
                ctx.stroke();

                // Lights
                for (let i = 0; i < 5; i++) {
                    const lightX = (i - 2) * 15;
                    ctx.fillStyle = frameCount % 20 < 10 ? '#FFEB3B' : '#FF5722';
                    ctx.beginPath();
                    ctx.arc(lightX, 8, 5, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Door beam
                if (this.doorOpen) {
                    ctx.fillStyle = 'rgba(100, 181, 246, 0.5)';
                    ctx.beginPath();
                    ctx.moveTo(-15, 15);
                    ctx.lineTo(-30, 80);
                    ctx.lineTo(30, 80);
                    ctx.lineTo(15, 15);
                    ctx.closePath();
                    ctx.fill();
                }

                ctx.restore();
            }
        }

        // Portal Class
        class Portal {
            constructor() {
                this.x = Math.random() * (width - 150) + 75;
                this.y = Math.random() * (height * 0.4) + 100;
                this.size = 60;
                this.rotation = 0;
                this.spawnTimer = 0;
            }

            update() {
                this.rotation += 0.05;
                this.spawnTimer++;
                if (this.spawnTimer > 180 && gameRunning) {
                    this.spawnTimer = 0;
                    const target = new Target(true);
                    target.x = this.x;
                    target.y = this.y;
                    targets.push(target);
                }
            }

            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);

                // Portal rings
                for (let i = 3; i >= 0; i--) {
                    ctx.strokeStyle = `hsl(${280 + i * 20}, 80%, ${50 + i * 10}%)`;
                    ctx.lineWidth = 5;
                    ctx.beginPath();
                    ctx.arc(0, 0, this.size / 2 - i * 8, 0, Math.PI * 2);
                    ctx.stroke();
                }

                // Center glow
                ctx.fillStyle = 'rgba(156, 39, 176, 0.5)';
                ctx.beginPath();
                ctx.arc(0, 0, 15, 0, Math.PI * 2);
                ctx.fill();

                ctx.restore();
            }
        }

        // Popup (score, aiyo, etc.)
        class Popup {
            constructor(x, y, text, color, isAiyo = false) {
                this.x = x;
                this.y = y;
                this.text = text;
                this.color = color;
                this.isAiyo = isAiyo;
                this.life = isAiyo ? 60 : 40;
            }

            update() {
                if (!this.isAiyo) this.y -= 2;
                this.life--;
                return this.life > 0;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = Math.min(1, this.life / 20);
                ctx.font = this.isAiyo ? 'bold 48px Fredoka' : 'bold 32px Fredoka';
                ctx.textAlign = 'center';
                ctx.fillStyle = this.color;
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 4;
                ctx.strokeText(this.text, this.x, this.y);
                ctx.fillText(this.text, this.x, this.y);
                ctx.restore();
            }
        }

        // Game Functions
        function startGame(players) {
            numPlayers = players;
            currentPlayer = 1;
            p1Score = 0;
            p2Score = 0;
            combo = 0;
            document.getElementById('mainMenu').classList.add('hidden');

            if (players === 2) {
                document.getElementById('p2ScoreBox').classList.remove('hidden');
                gamePhase = 'ready';
                showReadyScreen();
            } else {
                document.getElementById('p2ScoreBox').classList.add('hidden');
                startCountdown();
            }
        }

        function showReadyScreen() {
            const screen = document.getElementById('playerReadyScreen');
            const text = document.getElementById('playerReadyText');
            screen.classList.remove('hidden');

            text.textContent = `PLAYER ${currentPlayer} READY?`;
            text.style.color = currentPlayer === 1 ? '#00E676' : '#F97316';

            setTimeout(() => {
                screen.classList.add('hidden');
                startCountdown();
            }, 2000);
        }

        function startCountdown() {
            const countEl = document.getElementById('countdown');
            const textEl = document.getElementById('countdownText');
            countEl.classList.remove('hidden');

            let count = 3;
            textEl.textContent = count;

            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    textEl.textContent = count;
                } else if (count === 0) {
                    textEl.textContent = 'KICK!';
                } else {
                    clearInterval(interval);
                    countEl.classList.add('hidden');
                    startRound();
                }
            }, 1000);
        }

        function startRound() {
            gameRunning = true;
            gamePhase = 'playing';
            targets = [];
            footballs = [];
            particles = [];
            popups = [];
            ufos = [];
            portals = [];
            combo = 0;

            // Create UFOs and portals
            ufos.push(new UFO());
            if (difficulty !== 'easy') {
                portals.push(new Portal());
                if (difficulty === 'hard') {
                    portals.push(new Portal());
                }
            }

            timeRemaining = difficultySettings[difficulty].time;
            document.getElementById('timer').textContent = timeRemaining;
            document.getElementById('hud').classList.remove('hidden');
            document.getElementById('difficultyBadge').textContent = difficulty.toUpperCase();
            document.getElementById('comboBox').classList.remove('hidden');

            updateScoreDisplay();
            updateComboDisplay();

            gameTimer = setInterval(() => {
                timeRemaining--;
                document.getElementById('timer').textContent = timeRemaining;
                if (timeRemaining <= 0) {
                    endRound();
                }
            }, 1000);

            gameLoop();
        }

        function updateScoreDisplay() {
            if (numPlayers === 2) {
                document.getElementById('p1Score').textContent = currentPlayer === 1 ? getCurrentScore() : p1Score;
                document.getElementById('p2Score').textContent = currentPlayer === 2 ? getCurrentScore() : p2Score;
            } else {
                document.getElementById('p1Score').textContent = p1Score;
            }
        }

        function updateComboDisplay() {
            document.getElementById('comboCount').textContent = combo;
            document.getElementById('comboBox').classList.toggle('hidden', combo < 2);
        }

        function getCurrentScore() {
            return currentPlayer === 1 ? p1Score : p2Score;
        }

        function addScore(points) {
            if (currentPlayer === 1) {
                p1Score += points;
                p1Score = Math.max(0, p1Score);
            } else {
                p2Score += points;
                p2Score = Math.max(0, p2Score);
            }
            updateScoreDisplay();
        }

        function endRound() {
            gameRunning = false;
            clearInterval(gameTimer);
            document.getElementById('hud').classList.add('hidden');

            if (numPlayers === 2) {
                if (currentPlayer === 1) {
                    showScoreReveal(1, p1Score);
                } else {
                    showScoreReveal(2, p2Score);
                }
            } else {
                document.getElementById('finalScore').textContent = p1Score;
                document.getElementById('endScreen').classList.remove('hidden');
            }
        }

        function showScoreReveal(player, score) {
            gamePhase = 'scoreReveal';
            const screen = document.getElementById('scoreRevealScreen');
            document.getElementById('scoreRevealTitle').textContent = `PLAYER ${player} SCORED`;
            document.getElementById('scoreRevealNumber').textContent = score;
            screen.classList.remove('hidden');
            spawnConfetti('confettiContainer');

            screen.onclick = () => {
                screen.classList.add('hidden');
                screen.onclick = null;

                if (player === 1) {
                    currentPlayer = 2;
                    combo = 0;
                    gamePhase = 'ready';
                    showReadyScreen();
                } else {
                    showWinner();
                }
            };
        }

        function showWinner() {
            gamePhase = 'winner';
            const screen = document.getElementById('winnerScreen');
            document.getElementById('winnerP1Score').textContent = p1Score;
            document.getElementById('winnerP2Score').textContent = p2Score;

            let subtitle = '';
            if (p1Score > p2Score) {
                subtitle = 'PLAYER 1 WINS! üéâ';
            } else if (p2Score > p1Score) {
                subtitle = 'PLAYER 2 WINS! üéâ';
            } else {
                subtitle = "IT'S A TIE! ü§ù";
            }
            document.getElementById('winnerSubtitle').textContent = subtitle;

            screen.classList.remove('hidden');
            spawnConfetti('winnerConfettiContainer');
        }

        function spawnConfetti(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const colors = ['#FF5252', '#FFD600', '#00E676', '#2196F3', '#E040FB'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.fontSize = (Math.random() * 20 + 10) + 'px';
                confetti.textContent = ['üéâ', 'üéä', '‚ú®', '‚≠ê', '‚öΩ'][Math.floor(Math.random() * 5)];
                confetti.style.color = colors[Math.floor(Math.random() * colors.length)];
                container.appendChild(confetti);
            }
        }

        function rematch() {
            document.getElementById('winnerScreen').classList.add('hidden');
            currentPlayer = 1;
            p1Score = 0;
            p2Score = 0;
            combo = 0;
            gamePhase = 'ready';
            showReadyScreen();
        }

        // Spawn targets
        function spawnTarget() {
            if (!gameRunning) return;
            const settings = difficultySettings[difficulty];
            if (frameCount % settings.spawnRate === 0) {
                targets.push(new Target(portals.length > 0 && Math.random() > 0.5));
            }
        }

        // Handle click/touch
        function handleClick(e) {
            if (!gameRunning) return;

            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            let x, y;

            if (e.touches) {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            } else {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            }

            // Create football from bottom center
            const startX = width / 2;
            const startY = height - 80;
            footballs.push(new Football(startX, startY, x, y));
        }

        canvas.addEventListener('click', handleClick);
        canvas.addEventListener('touchstart', handleClick);

        // Game Loop
        function gameLoop() {
            if (!gameRunning) return;

            frameCount++;

            // Clear canvas
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(0, 0, width, height);

            // Draw background
            drawBackground();

            // Update and draw UFOs
            ufos.forEach(ufo => {
                ufo.update();
                ufo.draw();
            });

            // Update and draw portals
            portals.forEach(portal => {
                portal.update();
                portal.draw();
            });

            // Spawn targets
            spawnTarget();

            // Update and draw targets
            targets = targets.filter(target => {
                if (!target.update()) return false;
                target.draw();
                return true;
            });

            // Update and draw footballs
            footballs = footballs.filter(ball => {
                if (!ball.update()) return false;

                // Check collisions with targets
                for (let target of targets) {
                    if (target.state === 'active' && ball.checkCollision(target)) {
                        ball.hasHit = true;

                        if (target.isWrong) {
                            // Hit wrong target
                            target.hit(true);
                            combo = 0;
                            addScore(-5);
                            popups.push(new Popup(target.x, target.y - 50, '-5', '#FF5252'));

                            // Aiyo popup
                            if (target.wrongType === 'pakcik') {
                                popups.push(new Popup(target.x, target.y - 80, 'ADUH!', '#FF9800', true));
                            } else {
                                popups.push(new Popup(width / 2, height / 2, 'AIYO!', '#FF5722', true));
                            }
                        } else {
                            // Hit alien
                            target.hit(false);
                            combo++;
                            const comboBonus = Math.min(combo - 1, 5) * 5;
                            const points = 10 + comboBonus;
                            addScore(points);
                            popups.push(new Popup(target.x, target.y - 50, '+' + points, '#00E676'));

                            if (combo >= 3) {
                                popups.push(new Popup(target.x, target.y - 90, combo + 'x COMBO!', '#FFD600'));
                            }

                            // Particles
                            for (let i = 0; i < 8; i++) {
                                particles.push({
                                    x: target.x,
                                    y: target.y,
                                    vx: (Math.random() - 0.5) * 10,
                                    vy: (Math.random() - 0.5) * 10 - 5,
                                    life: 1,
                                    color: `hsl(${target.hue}, 70%, 50%)`,
                                    size: Math.random() * 8 + 4
                                });
                            }
                        }
                        updateComboDisplay();
                        break;
                    }
                }

                ball.draw();
                return true;
            });

            // Update and draw particles
            particles = particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.3;
                p.life -= 0.03;

                if (p.life <= 0) return false;

                ctx.save();
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();

                return true;
            });

            // Update and draw popups
            popups = popups.filter(popup => {
                if (!popup.update()) return false;
                popup.draw();
                return true;
            });

            requestAnimationFrame(gameLoop);
        }

        function drawBackground() {
            // Sky gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(0.5, '#B3E5FC');
            gradient.addColorStop(1, '#4CAF50');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);

            // Stadium field lines
            ctx.strokeStyle = '#FFF';
            ctx.lineWidth = 3;

            // Center circle
            ctx.beginPath();
            ctx.arc(width / 2, height * 0.75, 60, 0, Math.PI * 2);
            ctx.stroke();

            // Center line
            ctx.beginPath();
            ctx.moveTo(0, height * 0.75);
            ctx.lineTo(width, height * 0.75);
            ctx.stroke();

            // Goal posts (simple)
            ctx.fillStyle = '#FFF';
            ctx.fillRect(width / 2 - 80, height - 60, 10, 60);
            ctx.fillRect(width / 2 + 70, height - 60, 10, 60);
            ctx.fillRect(width / 2 - 80, height - 60, 160, 10);

            // Crowd (simple)
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            for (let i = 0; i < 30; i++) {
                const cx = (i / 30) * width;
                const cy = height - 20 + Math.sin(i + frameCount * 0.1) * 3;
                ctx.beginPath();
                ctx.arc(cx, cy, 8, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // Initial draw
        function initialDraw() {
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(0, 0, width, height);
            drawBackground();
        }
        initialDraw();
    </script>
</body>

</html>